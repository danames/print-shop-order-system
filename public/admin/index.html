<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pioneer Party - Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #2d2d2d;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            height: 40px;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background-color: #444;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        /* Mobile Navigation */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        .mobile-nav-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #2d2d2d;
            border-top: 1px solid #444;
            z-index: 1000;
        }

        .mobile-nav-menu.active {
            display: block;
        }

        .mobile-nav-tab {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background-color: transparent;
            border: none;
            color: white;
            cursor: pointer;
            text-align: left;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s;
        }

        .mobile-nav-tab:hover {
            background-color: #444;
        }

        .mobile-nav-tab.active {
            background-color: #10B981;
        }

        .nav-tab.active {
            background-color: #10B981;
        }

        .nav-tab:hover {
            background-color: #555;
        }

        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            box-sizing: border-box;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #10B981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4B5563;
        }

        .btn-danger {
            background-color: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #DC2626;
        }

        .btn-danger-mauve {
            background-color: #FAA18F;
            color: white;
        }

        .btn-danger-mauve:hover {
            background-color: #F88A6F;
        }

        .btn-full {
            width: 100%;
        }

        .orders-table .btn {
            padding: 8px 12px;
            min-width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 2px;
        }

        .orders-table td:last-child {
            white-space: nowrap;
        }

        .orders-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .orders-table th,
        .orders-table td {
            padding: 0px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .orders-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
            padding: 15px 11px; /* Taller header row */
        }

        .orders-table th:hover {
            background-color: #e9ecef;
        }

        .sort-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #6c757d;
        }

        .sort-indicator.active {
            color: #10B981;
        }

        .sort-indicator.asc::after {
            content: "▲";
        }

        .sort-indicator.desc::after {
            content: "▼";
        }

        .sort-indicator:not(.asc):not(.desc)::after {
            content: "⇅";
            opacity: 0.5;
        }

        .orders-table tr:hover {
            background-color: #f8f9fa;
        }

        .order-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .order-row:hover {
            background-color: #e3f2fd !important;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-received { background-color: #DBEAFE; color: #1E40AF; }
        .status-paid { background-color: #D1FAE5; color: #065F46; }
        .status-in_progress { background-color: #FEF3C7; color: #92400E; }
        .status-ready_for_pickup { background-color: #FEF3C7; color: #92400E; }
        .status-picked_up { background-color: #F3F4F6; color: #374151; }
        .status-abandoned { background-color: #F3F4F6; color: #374151; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* View Modal Styles */
        .view-modal-content {
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            padding: 30px;
        }

        .view-modal-body {
            display: flex;
            height: calc(90vh - 140px); /* Account for header + padding */
            min-height: 600px;
        }

        .view-modal-left {
            width: 60%; /* Fixed width instead of flex: 1 */
            padding: 20px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .view-modal-right {
            width: 40%; /* Fixed width instead of flex: 1 */
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 
                0 4px 6px rgba(0, 0, 0, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        /* Scroll indicators - fade effect at top and bottom */
        .view-modal-right::before,
        .view-modal-right::after {
            content: '';
            position: sticky;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
            z-index: 1;
        }
        
        .view-modal-right::before {
            top: 0;
            background: linear-gradient(to bottom, #fafafa 0%, transparent 100%);
            margin: -20px -20px 0 -20px;
        }
        
        .view-modal-right::after {
            bottom: 0;
            background: linear-gradient(to top, #fafafa 0%, transparent 100%);
            margin: 0 -20px -20px -20px;
        }
        
        /* Custom scrollbar styling */
        .view-modal-right::-webkit-scrollbar {
            width: 8px;
        }
        
        .view-modal-right::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .view-modal-right::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .view-modal-right::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Hover effect to indicate interactivity */
        .view-modal-right:hover {
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.15),
                0 2px 6px rgba(0, 0, 0, 0.1);
            border-color: #d0d0d0;
        }

        .file-preview-container {
            height: calc(100% - 60px); /* Fixed height, accounting for PDF controls */
            display: flex;
            flex-direction: column;
        }

        .file-preview {
            width: 100%;
            flex: 1; /* Take remaining space in container */
            border: 2px dashed #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            overflow: auto; /* Allow scrolling when content is larger than container */
            position: relative; /* For proper canvas positioning */
            box-sizing: border-box; /* Include border in width/height calculation */
        }

        .preview-placeholder {
            text-align: center;
            color: #666;
        }

        .preview-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .preview-controls {
            margin-top: 15px;
            text-align: center;
        }

        .order-details {
            height: 100%;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .detail-label {
            font-weight: bold;
            color: #555;
            min-width: 140px;
            margin-right: 15px;
        }

        .detail-value {
            color: #333;
            flex: 1;
            word-break: break-word;
        }

        /* PDF Controls Styles */
        .pdf-controls {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .pdf-controls-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pdf-controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-info, .zoom-level {
            font-size: 12px;
            color: #666;
            min-width: 80px;
            text-align: center;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 30px;
        }

        /* PDF Viewer Styles */
        .pdf-viewer {
            /* Position canvas like in the sample code */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
            display: block;
            transition: transform 0.2s ease;
        }


        .image-viewer {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .view-modal-content {
                width: 98%;
                margin: 2% auto;
            }

            .view-modal-body {
                flex-direction: column;
                height: auto;
                min-height: auto;
            }
            
            .view-modal-left {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
                min-height: 300px;
            }
            
            .view-modal-right {
                width: 100%;
                max-height: 50vh;
            }

            .detail-label {
                min-width: 100px;
                font-size: 14px;
            }

            .detail-value {
                font-size: 14px;
            }
        }

        /* File Upload Styles */
        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #10B981;
        }

        .file-upload.dragover {
            border-color: #10B981;
            background-color: #f0fdf4;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .order-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-position {
            font-size: 14px;
            color: #666;
            min-width: 60px;
            text-align: center;
        }
        
        .order-row.highlighted {
            background-color: #e3f2fd !important;
            border-left: 4px solid #2196f3;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card.clickable-filter {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .stat-card.clickable-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-color: #10B981;
        }

        .stat-card.clickable-filter:active {
            transform: translateY(0);
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #10B981;
            margin-bottom: 3px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Options & Prices Styles */
        .options-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .options-section h4 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #10B981;
            padding-bottom: 5px;
        }

        .options-list {
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
            gap: 10px;
            width: 100%;
        }

        .option-item input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .option-item .option-name {
            min-width: 120px;
        }

        .option-item .option-display {
            min-width: 180px;
            flex: 1;
            max-width: none;
        }

        .option-item .btn-danger {
            min-width: 40px;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .option-item .option-sort {
            min-width: 80px;
            display: none; /* Hide the numeric sort order input */
        }

        .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 16px;
            padding: 8px;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: all 0.2s;
            background-color: #f8f9fa;
            border: 1px solid #e1e5e9;
            flex-shrink: 0;
        }

        .drag-handle:hover {
            background-color: #e1e5e9;
            color: #333;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .option-item.sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
        }

        .option-item.sortable-chosen {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .option-item.sortable-drag {
            transform: rotate(2deg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                position: relative;
            }

            .nav-tabs {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px 10px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }

            .filter-panel {
                margin: 0 -10px;
                padding: 15px 10px;
            }

            .filter-header {
                margin-bottom: 15px;
            }

            .quick-search {
                margin: 0 -10px 15px -10px;
                padding: 0 10px;
            }

            .quick-search input {
                width: 100%;
                box-sizing: border-box;
            }

            .add-order-btn {
                margin: 0 -10px 15px -10px;
                width: calc(100% + 20px);
            }

            .orders-table {
                font-size: 14px;
                margin: 0 -10px;
                width: calc(100% + 20px);
            }

            .orders-table th,
            .orders-table td {
                padding: 8px 6px;
                font-size: 13px;
            }

            .orders-table th {
                padding: 12px 6px;
                font-size: 12px;
            }

            .mobile-nav-toggle {
                display: block;
            }

            .main-content {
                padding: 15px;
            }

            .option-item {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 12px;
            }

            .option-item .option-display {
                min-width: 120px;
                flex: 1;
                max-width: none;
            }

            .drag-handle {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .option-item .btn-danger {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .add-option {
                flex-direction: column;
                align-items: stretch;
            }

            .add-option input {
                min-width: auto;
                width: 100%;
                margin-bottom: 10px;
            }

            .add-option input[placeholder*="Display Name"] {
                min-width: auto;
                width: 100%;
            }

            .combinations-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .combinations-table {
                min-width: 600px;
            }

            .combinations-table th,
            .combinations-table td {
                padding: 8px;
                font-size: 14px;
            }

            .status-chip {
                padding: 4px 8px;
                font-size: 11px;
                min-width: 70px;
            }

            .orders-table .btn {
                min-width: 36px;
                height: 36px;
                font-size: 16px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 8px 10px;
            }

            .main-content {
                padding: 10px;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-card {
                padding: 12px 8px;
            }

            .stat-number {
                font-size: 20px;
            }

            .stat-label {
                font-size: 11px;
            }

            .orders-table {
                font-size: 12px;
            }

            .orders-table th,
            .orders-table td {
                padding: 6px 4px;
                font-size: 11px;
            }

            .orders-table th {
                padding: 10px 4px;
                font-size: 10px;
            }

            .options-section {
                padding: 15px;
                margin-bottom: 20px;
            }

            .option-item {
                padding: 10px;
                gap: 6px;
            }

            .drag-handle {
                width: 26px;
                height: 26px;
                font-size: 12px;
            }

            .option-item .btn-danger {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .combinations-table th,
            .combinations-table td {
                padding: 6px;
                font-size: 12px;
            }

            .status-chip {
                padding: 3px 6px;
                font-size: 10px;
                min-width: 60px;
            }

            .orders-table .btn {
                min-width: 32px;
                height: 32px;
                font-size: 14px;
                padding: 4px 8px;
            }

            .form-group textarea {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 45px;
                padding: 8px;
            }
        }

        .add-option {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-option input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 150px;
        }

        .add-option input[placeholder*="Display Name"] {
            min-width: 300px;
            flex: 1;
        }

        .combinations-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .combinations-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .combinations-table th {
            background: #10B981;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .combinations-table td {
            padding: 12px;
            border-bottom: 1px solid #e1e5e9;
        }

        .combinations-table tr:hover {
            background: #f8f9fa;
        }

        .status-chip {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            text-align: center;
            min-width: 80px;
        }

        .status-chip.available {
            background-color: #10B981;
            color: white;
        }

        .status-chip.available:hover {
            background-color: #059669;
        }

        .status-chip.unavailable {
            background-color: #6B7280;
            color: white;
        }

        .status-chip.unavailable:hover {
            background-color: #4B5563;
        }

        .combinations-table tr.unavailable {
            background: #f5f5f5;
            color: #666;
        }

        .combinations-table tr.unavailable input {
            background: #f5f5f5;
            color: #666;
        }

        .combinations-table input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .combinations-table input[type="checkbox"] {
            transform: scale(1.2);
        }

        .availability-status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .availability-status.available {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .availability-status.unavailable {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-picker input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Advanced Filter Styles */
        .filter-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .filter-header h3 {
            margin: 0;
            color: #333;
        }

        .filter-content {
            padding: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .filter-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .status-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .checkbox-label:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .quick-filters {
            margin-bottom: 20px;
        }

        .quick-filters h4 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .quick-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-filter-buttons .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .active-filters {
            padding: 15px 20px;
            background-color: #e3f2fd;
            border-top: 1px solid #bbdefb;
        }

        .active-filters h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            background-color: #1976d2;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .filter-chip .remove:hover {
            opacity: 1;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }

            .form-group textarea {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 50px;
            }
        }

        /* Inline editing styles */
        .clickable-status {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .date-chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            background-color: #E5E7EB;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #D1D5DB;
        }

        .date-chip:hover {
            background-color: #D1D5DB;
            color: #1F2937;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .clickable-date {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-dropdown {
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
            padding: 8px 0;
        }

        .date-dropdown {
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 0;
        }

        .date-dropdown .flatpickr-calendar {
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
        }

        .status-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:hover {
            background-color: #f3f4f6;
        }

        /* Validation Styles for Admin Modal */
        .modal .form-group {
            position: relative;
        }

        .modal .validation-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            pointer-events: none;
            z-index: 10;
            line-height: 1;
        }
        
        /* Position validation indicators to align with input fields */
        .modal .form-group input + .validation-indicator {
            top: calc(50% + 12px); /* Adjust for label height */
        }
        
        /* Reset positioning for phone and email fields that have validation messages below */
        #modal-phone-indicator,
        #modal-email-indicator {
            top: 50%;
        }

        .modal .validation-indicator.valid {
            color: #10B981;
        }

        .modal .validation-indicator.invalid {
            color: #EF4444;
        }

        .modal .validation-message {
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .modal .validation-message.error {
            color: #EF4444;
            display: block;
        }

        .modal .validation-message.success {
            color: #10B981;
            display: block;
        }

        .modal input.valid {
            border-color: #10B981;
        }

        .modal input.invalid {
            border-color: #EF4444;
        }

        .modal .phone-hint {
            color: #9CA3AF;
            font-size: 12px;
            margin-top: 5px;
        }

        .status-option .status-badge {
            margin: 0;
            font-size: 11px;
        }

        .date-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-picker-modal {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-picker-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Day selector styles */
        .day-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .day-box {
            position: relative;
            width: 40px;
            height: 40px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .day-box:hover {
            border-color: #3b82f6;
            background-color: #f3f4f6;
        }

        .day-box.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }

        .day-label {
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
        }

        .day-checkbox {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .day-checkbox:checked + .day-label {
            color: white;
        }

        .day-box:has(.day-checkbox:checked) {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        
        .unavailable-dates-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .unavailable-date-chip {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 16px;
            padding: 4px 8px 4px 12px;
            font-size: 14px;
            color: #374151;
        }
        
        .unavailable-date-chip .remove-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            margin-left: 6px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .unavailable-date-chip .remove-btn:hover {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Form -->
        <div id="login-form" class="login-form">
            <h2>Admin Login</h2>
            <form id="login">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Login</button>
            </form>
            <div id="login-error" class="alert alert-error" style="display: none;"></div>
        </div>

        <!-- Main App -->
        <div id="main-app" style="display: none;">
        <div class="header">
            <img src="/logo.svg" alt="Pioneer Party" class="logo">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="orders">Orders</button>
                <button class="nav-tab" data-tab="settings">Settings</button>
                <button class="nav-tab" data-tab="options">Options & Prices</button>
                <button class="nav-tab" data-tab="export">Export</button>
                <button class="nav-tab" onclick="logout()">Logout</button>
            </div>
            <button class="mobile-nav-toggle" onclick="toggleMobileNav()">☰</button>
            <div class="mobile-nav-menu" id="mobile-nav-menu">
                <button class="mobile-nav-tab active" data-tab="orders" onclick="switchTab('orders')">Orders</button>
                <button class="mobile-nav-tab" data-tab="settings" onclick="switchTab('settings')">Settings</button>
                <button class="mobile-nav-tab" data-tab="options" onclick="switchTab('options')">Options & Prices</button>
                <button class="mobile-nav-tab" data-tab="export" onclick="switchTab('export')">Export</button>
                <button class="mobile-nav-tab" onclick="logout()">Logout</button>
            </div>
        </div>

            <div class="main-content">
                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card clickable-filter" onclick="applyStatusFilter('active')" title="Click to filter Active orders">
                            <div class="stat-number" id="active-orders">0</div>
                            <div class="stat-label">Active Orders</div>
                        </div>
                        <div class="stat-card clickable-filter" onclick="applyStatusFilter('ready_for_pickup')" title="Click to filter Ready for Pickup orders">
                            <div class="stat-number" id="ready-orders">0</div>
                            <div class="stat-label">Ready for Pickup</div>
                        </div>
                        <div class="stat-card clickable-filter" onclick="applyStatusFilter('paid')" title="Click to filter Paid orders">
                            <div class="stat-number" id="paid-orders">0</div>
                            <div class="stat-label">Paid Orders</div>
                        </div>
                    </div>

                    <!-- Advanced Filter Panel -->
                    <div class="filter-panel">
                        <div class="filter-header">
                            <h3>Advanced Filters</h3>
                            <button class="btn btn-secondary" onclick="toggleFilterPanel()" id="filter-toggle">
                                <span id="filter-toggle-text">Show Filters</span>
                            </button>
                        </div>
                        
                        <div class="filter-content" id="filter-content" style="display: none;">
                            <div class="filter-grid">
                                <!-- Date Range Filters -->
                                <div class="filter-section">
                                    <h4>Date Range</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Created Date From:</label>
                                            <input type="date" id="filter-created-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Created Date To:</label>
                                            <input type="date" id="filter-created-to">
                                        </div>
                                    </div>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Pickup Date From:</label>
                                            <input type="date" id="filter-pickup-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Pickup Date To:</label>
                                            <input type="date" id="filter-pickup-to">
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Filters -->
                                <div class="filter-section">
                                    <h4>Status</h4>
                                    <div class="status-filters">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-received" value="received">
                                            <span class="status-badge status-received">Received</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-paid" value="paid">
                                            <span class="status-badge status-paid">Paid</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-in_progress" value="in_progress">
                                            <span class="status-badge status-in_progress">In Progress</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-ready_for_pickup" value="ready_for_pickup">
                                            <span class="status-badge status-ready_for_pickup">Ready for Pickup</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-picked_up" value="picked_up">
                                            <span class="status-badge status-picked_up">Picked Up</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-abandoned" value="abandoned">
                                            <span class="status-badge status-abandoned">Abandoned</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Customer Filters -->
                                <div class="filter-section">
                                    <h4>Customer</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Customer Name:</label>
                                            <input type="text" id="filter-customer-name" placeholder="Search by name...">
                                        </div>
                                        <div class="filter-group">
                                            <label>Phone:</label>
                                            <input type="text" id="filter-phone" placeholder="Search by phone...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Email:</label>
                                        <input type="text" id="filter-email" placeholder="Search by email...">
                                    </div>
                                </div>

                                <!-- Order Details -->
                                <div class="filter-section">
                                    <h4>Order Details</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Order Number From:</label>
                                            <input type="number" id="filter-order-from" placeholder="e.g., 1000">
                                        </div>
                                        <div class="filter-group">
                                            <label>Order Number To:</label>
                                            <input type="number" id="filter-order-to" placeholder="e.g., 2000">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Description/Notes:</label>
                                        <input type="text" id="filter-description" placeholder="Search in description or notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filters -->
                            <div class="quick-filters">
                                <h4>Quick Filters</h4>
                                <div class="quick-filter-buttons">
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('active')">Active Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('today')">Today's Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisWeek')">This Week</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisMonth')">This Month</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('ready')">Ready for Pickup</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('overdue')">Overdue</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('abandoned')">Abandoned</button>
                                </div>
                            </div>

                            <!-- Filter Actions -->
                            <div class="filter-actions">
                                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                                <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                                <button class="btn btn-secondary" onclick="saveFilterPreset()">Save Preset</button>
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div class="active-filters" id="active-filters" style="display: none;">
                            <h4>Active Filters:</h4>
                            <div class="filter-chips" id="filter-chips"></div>
                        </div>
                    </div>

                    <!-- Simple Search Bar (kept for backward compatibility) -->
                    <div class="search-bar">
                        <input type="text" id="search-orders" placeholder="Quick search by number, name, or phone...">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openOrderModal()">Add New Order</button>
                    </div>

                    <div id="orders-container">
                        <div class="loading">Loading orders...</div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Display Settings</h3>
                            <div class="form-group">
                                <label for="display-mode">Display Mode:</label>
                                <select id="display-mode" class="form-control">
                                    <option value="dark">Dark Mode</option>
                                    <option value="light">Light Mode</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rotation-seconds">Page Rotation (seconds):</label>
                                <input type="number" id="rotation-seconds" min="5" max="60" value="10">
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Status Colors</h3>
                            <div class="color-picker">
                                <label>Received:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-received-bg" value="#3B82F6">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-received-text" value="#1E40AF">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>Paid:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-paid-bg" value="#10B981">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-paid-text" value="#065F46">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>In Progress:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-in_progress-bg" value="#F59E0B">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-in_progress-text" value="#92400E">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>Ready for Pickup:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-ready_for_pickup-bg" value="#FCD34D">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-ready_for_pickup-text" value="#92400E">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button type="button" class="btn btn-secondary" onclick="resetToDefaultColors()">
                                    Reset to Default Colors
                                </button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Pickup Date & Time</h3>
                            <div class="form-group">
                                <label for="pickup-start-time">Pickup Start Time:</label>
                                <input type="text" id="pickup-start-time" placeholder="Select start time" value="9:00 AM">
                            </div>
                            <div class="form-group">
                                <label for="pickup-end-time">Pickup End Time:</label>
                                <input type="text" id="pickup-end-time" placeholder="Select end time" value="5:00 PM">
                            </div>
                            <div class="form-group">
                                <label>Available Pickup Days:</label>
                                <div class="day-selector">
                                    <div class="day-box" data-day="sunday">
                                        <span class="day-label">S</span>
                                        <input type="checkbox" id="day-sunday" class="day-checkbox">
                                    </div>
                                    <div class="day-box" data-day="monday">
                                        <span class="day-label">M</span>
                                        <input type="checkbox" id="day-monday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="tuesday">
                                        <span class="day-label">T</span>
                                        <input type="checkbox" id="day-tuesday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="wednesday">
                                        <span class="day-label">W</span>
                                        <input type="checkbox" id="day-wednesday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="thursday">
                                        <span class="day-label">Th</span>
                                        <input type="checkbox" id="day-thursday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="friday">
                                        <span class="day-label">F</span>
                                        <input type="checkbox" id="day-friday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="saturday">
                                        <span class="day-label">S</span>
                                        <input type="checkbox" id="day-saturday" class="day-checkbox" checked>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="time-increment">Time Increment:</label>
                                <select id="time-increment" class="form-control">
                                    <option value="15">15 Minutes</option>
                                    <option value="30">30 Minutes</option>
                                    <option value="60">Hourly</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Unavailable Dates:</label>
                                <button type="button" class="btn btn-secondary" onclick="openUnavailableDatesModal()" style="margin-bottom: 10px;">
                                    Add Unavailable Date
                                </button>
                                <div id="unavailable-dates-chips" class="unavailable-dates-container">
                                    <!-- Date chips will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Options & Prices Tab -->
                <div id="options-tab" class="tab-content">
                    <div class="settings-section">
                        <h3>Paper Options Management</h3>
                        <p>Manage available paper sizes, types, and color modes for the order form.</p>
                        
                        <!-- Paper Sizes Section -->
                        <div class="options-section">
                            <h4>Paper Sizes</h4>
                            <div class="options-list" id="paper-sizes-list">
                                <!-- Paper sizes will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-paper-size-display" placeholder="e.g. Letter (8.5&Prime; x 11&Prime;)" class="form-input">
                                <button class="btn btn-secondary" onclick="addPaperSize()">Add Paper Size</button>
                            </div>
                        </div>

                        <!-- Paper Types Section -->
                        <div class="options-section">
                            <h4>Paper Types</h4>
                            <div class="options-list" id="paper-types-list">
                                <!-- Paper types will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-paper-type-display" placeholder="e.g. Standard Paper" class="form-input">
                                <button class="btn btn-secondary" onclick="addPaperType()">Add Paper Type</button>
                            </div>
                        </div>

                        <!-- Color Modes Section -->
                        <div class="options-section">
                            <h4>Color Modes</h4>
                            <div class="options-list" id="color-modes-list">
                                <!-- Color modes will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-color-mode-display" placeholder="e.g. Black & White" class="form-input">
                                <button class="btn btn-secondary" onclick="addColorMode()">Add Color Mode</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Price Combinations</h3>
                        <p>Set prices and availability for each combination of paper options.</p>
                        
                        <div class="combinations-table-container">
                            <table class="combinations-table" id="combinations-table">
                                <thead>
                                    <tr>
                                        <th>Paper Size</th>
                                        <th>Paper Type</th>
                                        <th>Color Mode</th>
                                        <th>Price ($)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="combinations-tbody">
                                    <!-- Combinations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="export-tab" class="tab-content">
                    <div class="settings-section">
                        <h3>Export Orders</h3>
                        <p>Export all orders to a CSV file for backup or analysis.</p>
                        <button class="btn btn-primary" onclick="exportOrders()">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Modal -->
        <div id="order-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Add New Order</h2>
                    <span class="close" onclick="closeOrderModal()">&times;</span>
                </div>
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-first-name">First Name:</label>
                            <input type="text" id="customer-first-name" required>
                            <div class="validation-indicator" id="modal-first-name-indicator"></div>
                        </div>
                        <div class="form-group">
                            <label for="customer-last-name">Last Name:</label>
                            <input type="text" id="customer-last-name" required>
                            <div class="validation-indicator" id="modal-last-name-indicator"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-phone">Phone:</label>
                            <input type="tel" id="customer-phone" placeholder="(123) 456-7890" required>
                            <div class="validation-indicator" id="modal-phone-indicator"></div>
                            <div class="validation-message" id="modal-phone-message"></div>
                            <div class="phone-hint">Format: (123) 456-7890</div>
                        </div>
                        <div class="form-group">
                            <label for="customer-email">Email:</label>
                            <input type="email" id="customer-email" required>
                            <div class="validation-indicator" id="modal-email-indicator"></div>
                            <div class="validation-message" id="modal-email-message"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customer-address">Address:</label>
                        <input type="text" id="customer-address" required>
                    </div>

                    <div class="form-group">
                        <label for="pickup-datetime">Pickup Date & Time:</label>
                        <input type="text" id="pickup-datetime" placeholder="Select date and time">
                    </div>

                    <div class="form-group">
                        <label>File Upload (Optional)</label>
                        <div class="file-upload" id="modal-file-upload-area">
                            <input type="file" id="modal-file-input" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif">
                            <p>Click to select file or drag and drop</p>
                            <small>Accepted formats: PDF, Word documents, Images (JPG, PNG, GIF)<br>Maximum file size: 25MB</small>
                        </div>
                        <div class="file-info" id="modal-file-info">
                            <strong>Selected file:</strong> <span id="modal-file-name"></span><br>
                            <strong>Size:</strong> <span id="modal-file-size"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status">
                                <option value="received">Received</option>
                                <option value="paid">Paid</option>
                                <option value="in_progress">In Progress</option>
                                <option value="ready_for_pickup">Ready for Pickup</option>
                                <option value="picked_up">Picked Up</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="copies">Copies:</label>
                            <input type="number" id="copies" min="1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="order-description">Order Description:</label>
                        <textarea id="order-description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="special-instructions">Special Instructions:</label>
                        <textarea id="special-instructions" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" rows="2"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        class AdminPanel {
            constructor() {
                this.orders = [];
                this.filteredOrders = [];
                this.settings = {};
                this.currentUser = null;
                this.socket = null;
                this.activeFilters = {};
                this.flatpickrInstances = []; // Store flatpickr instances for dynamic updates
                this.currentSort = { column: null, direction: null }; // Track current sort state
                
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
                this.setupMobileNavigation();
                this.setupModalValidation();
            }

            checkAuth() {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    this.verifyToken(token);
                } else {
                    this.showLogin();
                }
            }

            async verifyToken(token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        // Token expired or invalid
                        localStorage.removeItem('admin_token');
                        this.showLogin();
                    }
                } catch (error) {
                    console.error('Token verification failed:', error);
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }

            showMainApp() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                this.setupSocket();
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Order form
                document.getElementById('order-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveOrder();
                });

                // File upload for modal
                this.setupModalFileUpload();

                // Search
                document.getElementById('search-orders').addEventListener('input', (e) => {
                    this.filterOrders(e.target.value);
                });

                // Day selector click handlers
                document.querySelectorAll('.day-box').forEach(dayBox => {
                    dayBox.addEventListener('click', (e) => {
                        const checkbox = dayBox.querySelector('.day-checkbox');
                        checkbox.checked = !checkbox.checked;
                    });
                });
            }

            setupModalFileUpload() {
                const fileInput = document.getElementById('modal-file-input');
                const fileUploadArea = document.getElementById('modal-file-upload-area');
                const fileInfo = document.getElementById('modal-file-info');
                const fileName = document.getElementById('modal-file-name');
                const fileSize = document.getElementById('modal-file-size');

                if (!fileInput || !fileUploadArea) return;

                // File input change
                fileInput.addEventListener('change', (e) => {
                    this.handleModalFileSelect(e.target.files[0]);
                });

                // Click to select file
                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // Drag and drop
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });

                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        this.handleModalFileSelect(files[0]);
                    }
                });
            }

            handleModalFileSelect(file) {
                const fileInfo = document.getElementById('modal-file-info');
                const fileName = document.getElementById('modal-file-name');
                const fileSize = document.getElementById('modal-file-size');

                if (file) {
                    fileName.textContent = file.name;
                    fileSize.textContent = this.formatFileSize(file.size);
                    fileInfo.style.display = 'block';
                } else {
                    fileInfo.style.display = 'none';
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            setupMobileNavigation() {
                // Close mobile menu when clicking outside
                document.addEventListener('click', (e) => {
                    const mobileMenu = document.getElementById('mobile-nav-menu');
                    const mobileToggle = document.querySelector('.mobile-nav-toggle');
                    
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        if (!mobileMenu.contains(e.target) && !mobileToggle.contains(e.target)) {
                            mobileMenu.classList.remove('active');
                        }
                    }
                });

                // Close mobile menu on window resize to desktop size
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768) {
                        const mobileMenu = document.getElementById('mobile-nav-menu');
                        if (mobileMenu) {
                            mobileMenu.classList.remove('active');
                        }
                    }
                });
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('admin_token', data.token);
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        this.showError(data.message);
                    }
                } catch (error) {
                    console.error('Login failed:', error);
                    this.showError('Login failed. Please try again.');
                }
            }

            logout() {
                localStorage.removeItem('admin_token');
                this.currentUser = null;
                this.showLogin();
            }

            showError(message) {
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            switchTab(tabName) {
                // Update active tab for desktop navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const desktopTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                if (desktopTab) {
                    desktopTab.classList.add('active');
                }

                // Update active tab for mobile navigation
                document.querySelectorAll('.mobile-nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const mobileTab = document.querySelector(`.mobile-nav-tab[data-tab="${tabName}"]`);
                if (mobileTab) {
                    mobileTab.classList.add('active');
                }

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load data for specific tabs
                if (tabName === 'settings') {
                    this.loadSettings();
                } else if (tabName === 'options') {
                    this.loadOptions();
                    this.loadCombinations();
                } else if (tabName === 'orders') {
                    // Ensure settings are fresh when switching to orders tab
                    // This ensures pickup restrictions are up-to-date
                    this.loadSettings();
                }
            }

            async loadData() {
                await Promise.all([
                    this.loadOrders(),
                    this.loadSettings()
                ]);
            }

            async loadOrders() {
                try {
                    // Load ALL orders including picked_up and abandoned for admin filtering
                    const response = await fetch('/api/orders?show_picked_up=true');
                    if (response.ok) {
                        this.orders = await response.json();
                        this.filteredOrders = [...this.orders];
                        
                        // Apply default "Active" filter on page load
                        this.applyDefaultActiveFilter();
                        
                        this.displayOrders();
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Failed to load orders:', error);
                }
            }

            async loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (response.ok) {
                        this.settings = await response.json();
                        this.populateSettingsForm();
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }

            displayOrders() {
                console.log('🖥️ displayOrders called');
                const container = document.getElementById('orders-container');
                // Use filteredOrders if it has been sorted or if filters are active, otherwise use all orders
                const ordersToDisplay = (this.currentSort.column || Object.keys(this.activeFilters).length > 0) ? this.filteredOrders : this.orders;
                console.log('🖥️ Orders to display:', ordersToDisplay.length);
                console.log('🖥️ Active filters:', Object.keys(this.activeFilters).length);
                console.log('🖥️ Current sort column:', this.currentSort.column);
                
                if (ordersToDisplay.length === 0) {
                    const message = Object.keys(this.activeFilters).length > 0 ? 
                        'No orders match your current filters' : 
                        'No orders found';
                    container.innerHTML = `<div class="loading">${message}</div>`;
                    return;
                }

                const ordersHTML = ordersToDisplay.map(order => `
                    <tr class="order-row" onclick="viewOrder(${order.id})" title="Click to view order details">
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td>
                            <span class="status-badge status-${order.status} clickable-status" 
                                  data-status="${order.status}"
                                  onclick="event.stopPropagation(); showStatusDropdown(${order.id}, '${order.status}')" 
                                  title="Click to change status">
                                ${this.formatStatusText(order.status)}
                            </span>
                        </td>
                        <td>
                            <span class="date-chip clickable-date" onclick="event.stopPropagation(); showDateDropdown(${order.id}, '${order.pickup_date || ''}', '${order.pickup_time || ''}')" title="Click to change pickup date and time">
                                📅 ${this.formatPickupDateTime(order.pickup_date, order.pickup_time)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); editOrder(${order.id})" title="Edit">✏️</button>
                            <button class="btn btn-danger-mauve" onclick="event.stopPropagation(); deleteOrder(${order.id})" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th onclick="sortOrders('order_number')">Order #<span class="sort-indicator" data-column="order_number"></span></th>
                                <th onclick="sortOrders('customer_name')">Customer<span class="sort-indicator" data-column="customer_name"></span></th>
                                <th onclick="sortOrders('phone')">Phone<span class="sort-indicator" data-column="phone"></span></th>
                                <th onclick="sortOrders('email')">Email<span class="sort-indicator" data-column="email"></span></th>
                                <th onclick="sortOrders('status')">Status<span class="sort-indicator" data-column="status"></span></th>
                                <th onclick="sortOrders('pickup_date')">Pickup Date & Time<span class="sort-indicator" data-column="pickup_date"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
                
                // Apply color settings to the newly rendered order table
                this.updateOrderTableColors();
            }

            updateStats() {
                // Always count from all orders (not filtered) for the stat tiles
                const allOrders = this.orders;
                const activeOrders = allOrders.filter(o => !['picked_up', 'abandoned'].includes(o.status)).length;
                const readyOrders = allOrders.filter(o => o.status === 'ready_for_pickup').length;
                const paidOrders = allOrders.filter(o => o.status === 'paid').length;

                document.getElementById('active-orders').textContent = activeOrders;
                document.getElementById('ready-orders').textContent = readyOrders;
                document.getElementById('paid-orders').textContent = paidOrders;
            }

            applyColorSettings() {
                if (!this.settings.status_colors) return;

                const colors = this.settings.status_colors;
                
                // Apply colors to status badges in filter section
                const statusBadges = {
                    'status-received': colors.received,
                    'status-paid': colors.paid,
                    'status-in_progress': colors.in_progress,
                    'status-ready_for_pickup': colors.ready_for_pickup
                };

                Object.entries(statusBadges).forEach(([id, colorData]) => {
                    const badge = document.querySelector(`#${id} + .status-badge`);
                    if (badge) {
                        // Handle both old format (string) and new format (object)
                        if (typeof colorData === 'string') {
                            badge.style.backgroundColor = colorData;
                            badge.style.color = this.getContrastColor(colorData);
                        } else if (colorData && colorData.background) {
                            badge.style.backgroundColor = colorData.background;
                            badge.style.color = colorData.text;
                        }
                    }
                });

                // Apply colors to order table status chips
                this.updateOrderTableColors();
            }

            getContrastColor(hexColor) {
                // Convert hex to RGB
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                
                // Calculate luminance
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Return black for light colors, white for dark colors
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }

            updateOrderTableColors() {
                if (!this.settings.status_colors) return;

                const colors = this.settings.status_colors;
                
                // Update all status badges in the orders table
                const statusBadges = document.querySelectorAll('.status-badge');
                statusBadges.forEach(badge => {
                    const status = badge.getAttribute('data-status');
                    if (colors[status]) {
                        // Handle both old format (string) and new format (object)
                        if (typeof colors[status] === 'string') {
                            badge.style.backgroundColor = colors[status];
                            badge.style.color = this.getContrastColor(colors[status]);
                        } else if (colors[status] && colors[status].background) {
                            badge.style.backgroundColor = colors[status].background;
                            badge.style.color = colors[status].text;
                        }
                    }
                });
            }

            filterOrders(searchTerm) {
                // Use the current filtered orders as base, or all orders if no advanced filters
                const baseOrders = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                
                const filtered = baseOrders.filter(order => 
                    order.order_number.toString().includes(searchTerm) ||
                    order.customer_first_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_last_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_phone.includes(searchTerm)
                );

                // Update display with filtered results
                const container = document.getElementById('orders-container');
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="loading">No orders match your search</div>';
                    return;
                }

                const ordersHTML = filtered.map(order => `
                    <tr class="order-row" onclick="viewOrder(${order.id})" title="Click to view order details">
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.replace('_', ' ')}</span></td>
                        <td>${order.pickup_date || 'TBD'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); editOrder(${order.id})" title="Edit">✏️</button>
                            <button class="btn btn-danger-mauve" onclick="event.stopPropagation(); deleteOrder(${order.id})" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th onclick="sortOrders('order_number')">Order #<span class="sort-indicator" data-column="order_number"></span></th>
                                <th onclick="sortOrders('customer_name')">Customer<span class="sort-indicator" data-column="customer_name"></span></th>
                                <th onclick="sortOrders('phone')">Phone<span class="sort-indicator" data-column="phone"></span></th>
                                <th onclick="sortOrders('email')">Email<span class="sort-indicator" data-column="email"></span></th>
                                <th onclick="sortOrders('status')">Status<span class="sort-indicator" data-column="status"></span></th>
                                <th onclick="sortOrders('pickup_date')">Pickup Date & Time<span class="sort-indicator" data-column="pickup_date"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
            }

            populateSettingsForm() {
                document.getElementById('display-mode').value = this.settings.display_mode || 'dark';
                document.getElementById('rotation-seconds').value = this.settings.page_rotation_seconds || 10;
                
                if (this.settings.status_colors) {
                    // Handle both old format (just hex strings) and new format (objects with background/text)
                    const getBackgroundColor = (color) => {
                        if (typeof color === 'string') {
                            return color; // Old format
                        } else if (color && color.background) {
                            return color.background; // New format
                        }
                        return '#3B82F6'; // Default fallback
                    };

                    const getTextColor = (color) => {
                        if (typeof color === 'string') {
                            return this.getContrastColor(color); // Old format - calculate contrast
                        } else if (color && color.text) {
                            return color.text; // New format
                        }
                        return '#000000'; // Default fallback
                    };

                    // Set background colors
                    document.getElementById('color-received-bg').value = getBackgroundColor(this.settings.status_colors.received);
                    document.getElementById('color-paid-bg').value = getBackgroundColor(this.settings.status_colors.paid);
                    document.getElementById('color-in_progress-bg').value = getBackgroundColor(this.settings.status_colors.in_progress);
                    document.getElementById('color-ready_for_pickup-bg').value = getBackgroundColor(this.settings.status_colors.ready_for_pickup);

                    // Set text colors
                    document.getElementById('color-received-text').value = getTextColor(this.settings.status_colors.received);
                    document.getElementById('color-paid-text').value = getTextColor(this.settings.status_colors.paid);
                    document.getElementById('color-in_progress-text').value = getTextColor(this.settings.status_colors.in_progress);
                    document.getElementById('color-ready_for_pickup-text').value = getTextColor(this.settings.status_colors.ready_for_pickup);
                    
                    // Apply colors to the page
                    this.applyColorSettings();
                }

        // Populate pickup settings
        if (this.settings.pickup_settings) {
            // Convert 24-hour format to 12-hour format for display
            const convertTo12Hour = (time24h) => {
                if (!time24h) return '9:00 AM';
                const [hours, minutes] = time24h.split(':');
                const hour24 = parseInt(hours);
                const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                const period = hour24 >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${period}`;
            };
            
            document.getElementById('pickup-start-time').value = convertTo12Hour(this.settings.pickup_settings.pickup_start_time);
            document.getElementById('pickup-end-time').value = convertTo12Hour(this.settings.pickup_settings.pickup_end_time);
            document.getElementById('time-increment').value = this.settings.pickup_settings.time_increment || '30';
            
            if (this.settings.pickup_settings.pickup_days) {
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                days.forEach(day => {
                    const checkbox = document.getElementById(`day-${day}`);
                    if (checkbox) {
                        checkbox.checked = this.settings.pickup_settings.pickup_days[day] || false;
                    }
                });
            }
            
            // Initialize flatpickr for time inputs in settings (no restrictions)
            this.initializeSettingsTimePickers();
            
            // Update unavailable dates display
            updateUnavailableDatesDisplay();
        }
            }

            async saveSettings() {
                const settings = {
                    display_mode: document.getElementById('display-mode').value,
                    page_rotation_seconds: parseInt(document.getElementById('rotation-seconds').value),
                    status_colors: {
                        received: {
                            background: document.getElementById('color-received-bg').value,
                            text: document.getElementById('color-received-text').value
                        },
                        paid: {
                            background: document.getElementById('color-paid-bg').value,
                            text: document.getElementById('color-paid-text').value
                        },
                        in_progress: {
                            background: document.getElementById('color-in_progress-bg').value,
                            text: document.getElementById('color-in_progress-text').value
                        },
                        ready_for_pickup: {
                            background: document.getElementById('color-ready_for_pickup-bg').value,
                            text: document.getElementById('color-ready_for_pickup-text').value
                        }
                    },
            pickup_settings: {
                pickup_start_time: (() => {
                    // Convert 12-hour format to 24-hour format for backend
                    const time12h = document.getElementById('pickup-start-time').value;
                    if (time12h) {
                        const [time, period] = time12h.split(' ');
                        const [hours, minutes] = time.split(':');
                        let hour24 = parseInt(hours);
                        if (period === 'PM' && hour24 !== 12) hour24 += 12;
                        if (period === 'AM' && hour24 === 12) hour24 = 0;
                        return `${hour24.toString().padStart(2, '0')}:${minutes}`;
                    }
                    return time12h;
                })(),
                pickup_end_time: (() => {
                    // Convert 12-hour format to 24-hour format for backend
                    const time12h = document.getElementById('pickup-end-time').value;
                    if (time12h) {
                        const [time, period] = time12h.split(' ');
                        const [hours, minutes] = time.split(':');
                        let hour24 = parseInt(hours);
                        if (period === 'PM' && hour24 !== 12) hour24 += 12;
                        if (period === 'AM' && hour24 === 12) hour24 = 0;
                        return `${hour24.toString().padStart(2, '0')}:${minutes}`;
                    }
                    return time12h;
                })(),
                time_increment: document.getElementById('time-increment').value,
                pickup_days: {
                    sunday: document.getElementById('day-sunday').checked,
                    monday: document.getElementById('day-monday').checked,
                    tuesday: document.getElementById('day-tuesday').checked,
                    wednesday: document.getElementById('day-wednesday').checked,
                    thursday: document.getElementById('day-thursday').checked,
                    friday: document.getElementById('day-friday').checked,
                    saturday: document.getElementById('day-saturday').checked
                },
                unavailable_dates: this.settings.pickup_settings.unavailable_dates || []
            }
                };

                try {
                    const token = localStorage.getItem('admin_token');
                    
                    if (!token) {
                        this.showAlert('Authentication required. Please log in again.', 'error');
                        this.showLogin();
                        return;
                    }
                    
                    const response = await fetch('/api/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        this.showAlert('Settings saved successfully!', 'success');
                        
                        // Reload settings from server to ensure local object is updated
                        await this.loadSettings();
                        
                        // Apply color settings to the current page
                        this.applyColorSettings();
                        
                        // Update all existing flatpickr instances with new settings
                        this.updateFlatpickrInstances();
                        
                        // Show additional notification that changes are applied
                        setTimeout(() => {
                            this.showAlert('Pickup restrictions updated across all forms!', 'info');
                        }, 1000);
                    } else if (response.status === 401 || response.status === 403) {
                        // Token expired or invalid
                        this.showAlert('Session expired. Please log in again.', 'error');
                        localStorage.removeItem('admin_token');
                        this.showLogin();
                    } else {
                        this.showAlert('Failed to save settings', 'error');
                    }
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    this.showAlert('Failed to save settings', 'error');
                }
            }

            async exportOrders() {
                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch('/api/orders/export/csv', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        this.showAlert('Orders exported successfully!', 'success');
                    } else {
                        this.showAlert('Failed to export orders', 'error');
                    }
                } catch (error) {
                    console.error('Failed to export orders:', error);
                    this.showAlert('Failed to export orders', 'error');
                }
            }

            async saveOrder() {
                // Check if form is valid before proceeding
                if (!this.checkModalFormValidity()) {
                    this.showAlert('Please fix all validation errors before saving.', 'error');
                    return;
                }

                const orderId = document.getElementById('order-id').value;
                const isEdit = orderId !== '';
                
                // Parse flatpickr datetime value
                const datetimeValue = document.getElementById('pickup-datetime').value;
                let pickupDatetime = '';
                if (datetimeValue) {
                    const dateTime = new Date(datetimeValue);
                    const date = dateTime.toISOString().split('T')[0]; // YYYY-MM-DD format
                    const time = dateTime.toTimeString().split(' ')[0].substring(0, 5); // HH:MM format
                    pickupDatetime = `${date} ${time}`;
                }
                
                // Handle file upload if present
                let fileInfo = null;
                const fileInput = document.getElementById('modal-file-input');
                if (fileInput && fileInput.files[0]) {
                    console.log('📁 Uploading file:', fileInput.files[0].name);
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    
                    const uploadResponse = await fetch('/api/upload/admin', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const uploadData = await uploadResponse.json();
                        fileInfo = uploadData.file;
                        console.log('✅ File uploaded successfully:', fileInfo);
                    } else {
                        const errorText = await uploadResponse.text();
                        console.error('❌ File upload failed:', uploadResponse.status, errorText);
                        throw new Error('File upload failed');
                    }
                }

                const orderData = {
                    customer_first_name: document.getElementById('customer-first-name').value,
                    customer_last_name: document.getElementById('customer-last-name').value,
                    customer_phone: document.getElementById('customer-phone').value,
                    customer_email: document.getElementById('customer-email').value,
                    customer_address: document.getElementById('customer-address').value,
                    pickup_datetime: pickupDatetime,
                    status: document.getElementById('status').value,
                    copies: parseInt(document.getElementById('copies').value),
                    order_description: document.getElementById('order-description').value,
                    special_instructions: document.getElementById('special-instructions').value,
                    notes: document.getElementById('notes').value
                };

                // Add file information if uploaded
                if (fileInfo) {
                    orderData.file_path = fileInfo.path;
                    orderData.file_name = fileInfo.originalName;
                    orderData.file_size = fileInfo.size;
                }

                console.log('📋 Order data being sent:', orderData);

                try {
                    const token = localStorage.getItem('admin_token');
                    const url = isEdit ? `/api/orders/${orderId}` : '/api/orders';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    console.log(`🚀 Sending ${method} request to:`, url);
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(orderData)
                    });

                    console.log('📡 Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ Order creation failed:', response.status, errorText);
                        throw new Error(`Order creation failed: ${response.status} ${errorText}`);
                    }

                    console.log('✅ Order created successfully!');
                    this.showAlert(isEdit ? 'Order updated successfully!' : 'Order created successfully!', 'success');
                    this.closeOrderModal();
                    this.loadOrders();
                } catch (error) {
                    console.error('Failed to save order:', error);
                    this.showAlert('Failed to save order', 'error');
                }
            }

            closeOrderModal() {
                document.getElementById('order-modal').style.display = 'none';
                // Clear file upload
                const fileInput = document.getElementById('modal-file-input');
                const fileInfo = document.getElementById('modal-file-info');
                if (fileInput) fileInput.value = '';
                if (fileInfo) fileInfo.style.display = 'none';
            }

            // Advanced Filtering Methods
            applyFilters() {
                this.activeFilters = this.getFilterValues();
                this.filteredOrders = this.applyAdvancedFilters(this.orders, this.activeFilters);
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            getFilterValues() {
                const filters = {};
                
                // Date filters
                const createdFrom = document.getElementById('filter-created-from').value;
                const createdTo = document.getElementById('filter-created-to').value;
                const pickupFrom = document.getElementById('filter-pickup-from').value;
                const pickupTo = document.getElementById('filter-pickup-to').value;
                
                if (createdFrom) filters.createdFrom = createdFrom;
                if (createdTo) filters.createdTo = createdTo;
                if (pickupFrom) filters.pickupFrom = pickupFrom;
                if (pickupTo) filters.pickupTo = pickupTo;
                
                // Status filters
                const statusFilters = [];
                document.querySelectorAll('.status-filters input[type="checkbox"]:checked').forEach(checkbox => {
                    statusFilters.push(checkbox.value);
                });
                if (statusFilters.length > 0) filters.statuses = statusFilters;
                
                // Customer filters
                const customerName = document.getElementById('filter-customer-name').value.trim();
                const phone = document.getElementById('filter-phone').value.trim();
                const email = document.getElementById('filter-email').value.trim();
                
                if (customerName) filters.customerName = customerName;
                if (phone) filters.phone = phone;
                if (email) filters.email = email;
                
                // Order details
                const orderFrom = document.getElementById('filter-order-from').value;
                const orderTo = document.getElementById('filter-order-to').value;
                const description = document.getElementById('filter-description').value.trim();
                
                if (orderFrom) filters.orderFrom = parseInt(orderFrom);
                if (orderTo) filters.orderTo = parseInt(orderTo);
                if (description) filters.description = description;
                
                return filters;
            }

            applyAdvancedFilters(orders, filters) {
                return orders.filter(order => {
                    // Date filters
                    if (filters.createdFrom && new Date(order.created_at) < new Date(filters.createdFrom)) {
                        return false;
                    }
                    if (filters.createdTo && new Date(order.created_at) > new Date(filters.createdTo + 'T23:59:59')) {
                        return false;
                    }
                    if (filters.pickupFrom && order.pickup_date && new Date(order.pickup_date) < new Date(filters.pickupFrom)) {
                        return false;
                    }
                    if (filters.pickupTo && order.pickup_date && new Date(order.pickup_date) > new Date(filters.pickupTo + 'T23:59:59')) {
                        return false;
                    }
                    
                    // Status filters
                    if (filters.statuses && filters.statuses.length > 0 && !filters.statuses.includes(order.status)) {
                        return false;
                    }
                    
                    // Customer filters
                    if (filters.customerName) {
                        const fullName = `${order.customer_first_name} ${order.customer_last_name}`.toLowerCase();
                        if (!fullName.includes(filters.customerName.toLowerCase())) {
                            return false;
                        }
                    }
                    if (filters.phone && !order.customer_phone.includes(filters.phone)) {
                        return false;
                    }
                    if (filters.email && !order.customer_email.toLowerCase().includes(filters.email.toLowerCase())) {
                        return false;
                    }
                    
                    // Order details
                    if (filters.orderFrom && order.order_number < filters.orderFrom) {
                        return false;
                    }
                    if (filters.orderTo && order.order_number > filters.orderTo) {
                        return false;
                    }
                    if (filters.description) {
                        const searchText = `${order.order_description || ''} ${order.notes || ''}`.toLowerCase();
                        if (!searchText.includes(filters.description.toLowerCase())) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            updateActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('active-filters');
                const filterChipsDiv = document.getElementById('filter-chips');
                
                if (Object.keys(this.activeFilters).length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                filterChipsDiv.innerHTML = '';
                
                Object.entries(this.activeFilters).forEach(([key, value]) => {
                    const chip = this.createFilterChip(key, value);
                    filterChipsDiv.appendChild(chip);
                });
            }

            createFilterChip(key, value) {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                
                let displayText = '';
                switch (key) {
                    case 'createdFrom':
                        displayText = `Created from: ${value}`;
                        break;
                    case 'createdTo':
                        displayText = `Created to: ${value}`;
                        break;
                    case 'pickupFrom':
                        displayText = `Pickup from: ${value}`;
                        break;
                    case 'pickupTo':
                        displayText = `Pickup to: ${value}`;
                        break;
                    case 'statuses':
                        // Check if this is the "Active" combination
                        if (value.length === 4 && 
                            value.includes('received') && value.includes('paid') && 
                            value.includes('in_progress') && value.includes('ready_for_pickup')) {
                            displayText = 'Active';
                        } else {
                            // Format individual status values
                            const formattedStatuses = value.map(status => this.formatStatusText(status));
                            displayText = `Status: ${formattedStatuses.join(', ')}`;
                        }
                        break;
                    case 'customerName':
                        displayText = `Customer: ${value}`;
                        break;
                    case 'phone':
                        displayText = `Phone: ${value}`;
                        break;
                    case 'email':
                        displayText = `Email: ${value}`;
                        break;
                    case 'orderFrom':
                        displayText = `Order from: ${value}`;
                        break;
                    case 'orderTo':
                        displayText = `Order to: ${value}`;
                        break;
                    case 'description':
                        displayText = `Description: ${value}`;
                        break;
                }
                
                chip.innerHTML = `
                    <span>${displayText}</span>
                    <span class="remove" onclick="removeFilter('${key}')">&times;</span>
                `;
                
                return chip;
            }

            formatStatusText(status) {
                const statusMap = {
                    'received': 'Received',
                    'paid': 'Paid', 
                    'in_progress': 'In Progress',
                    'ready_for_pickup': 'Ready for Pickup',
                    'picked_up': 'Picked Up',
                    'abandoned': 'Abandoned'
                };
                return statusMap[status] || status;
            }

            formatPickupDateTime(date, time) {
                if (!date) return 'TBD';
                
                try {
                    // Parse the date (assuming YYYY-MM-DD format)
                    const dateObj = new Date(date + 'T00:00:00');
                    
                    // Format date as M/D/YY
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const year = dateObj.getFullYear().toString().slice(-2);
                    const formattedDate = `${month}/${day}/${year}`;
                    
                    if (!time) {
                        return formattedDate;
                    }
                    
                    // Parse and format time (assuming HH:MM format)
                    const [hours, minutes] = time.split(':');
                    const hour24 = parseInt(hours);
                    const minute = parseInt(minutes);
                    
                    // Convert to 12-hour format
                    let hour12 = hour24;
                    let ampm = 'AM';
                    
                    if (hour24 === 0) {
                        hour12 = 12;
                    } else if (hour24 === 12) {
                        ampm = 'PM';
                    } else if (hour24 > 12) {
                        hour12 = hour24 - 12;
                        ampm = 'PM';
                    }
                    
                    const formattedTime = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;
                    
                    return `${formattedDate} ${formattedTime}`;
                } catch (error) {
                    console.error('Error formatting date/time:', error);
                    return date || 'TBD';
                }
            }

            clearAllFilters() {
                // Clear all filter inputs
                document.querySelectorAll('.filter-panel input').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                this.activeFilters = {};
                this.filteredOrders = [...this.orders];
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            applyDefaultActiveFilter() {
                // Set the "Active" status checkboxes as checked
                const activeStatuses = ['received', 'paid', 'in_progress', 'ready_for_pickup'];
                activeStatuses.forEach(status => {
                    const checkbox = document.getElementById(`status-${status}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // Apply the active filter
                this.activeFilters = this.getFilterValues();
                this.filteredOrders = this.applyAdvancedFilters(this.orders, this.activeFilters);
                this.updateActiveFiltersDisplay();
            }

            applyStatusFilter(statusType) {
                // Clear all existing filters first
                this.clearAllFilters();
                
                if (statusType === 'active') {
                    // Apply "Active" filter (all statuses except picked_up and abandoned)
                    const activeStatuses = ['received', 'paid', 'in_progress', 'ready_for_pickup'];
                    activeStatuses.forEach(status => {
                        const checkbox = document.getElementById(`status-${status}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                } else {
                    // Apply single status filter
                    const checkbox = document.getElementById(`status-${statusType}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }

                // Apply the filter
                this.activeFilters = this.getFilterValues();
                this.filteredOrders = this.applyAdvancedFilters(this.orders, this.activeFilters);
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            applyQuickFilter(type) {
                this.clearAllFilters();
                
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                switch (type) {
                    case 'active':
                        // Check all statuses except picked_up and abandoned
                        document.getElementById('status-received').checked = true;
                        document.getElementById('status-paid').checked = true;
                        document.getElementById('status-in_progress').checked = true;
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'today':
                        document.getElementById('filter-created-from').value = startOfDay.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisWeek':
                        const startOfWeek = new Date(startOfDay);
                        startOfWeek.setDate(startOfDay.getDate() - startOfDay.getDay());
                        document.getElementById('filter-created-from').value = startOfWeek.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisMonth':
                        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                        document.getElementById('filter-created-from').value = startOfMonth.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'ready':
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'overdue':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('filter-pickup-to').value = yesterday.toISOString().split('T')[0];
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'abandoned':
                        document.getElementById('status-abandoned').checked = true;
                        break;
                }
                
                this.applyFilters();
            }

            // Inline editing methods
            async updateOrderStatus(orderId, newStatus) {
                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            this.orders[orderIndex].status = newStatus;
                        }
                        
                        // Also update in filteredOrders if it exists
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            this.filteredOrders[filteredIndex].status = newStatus;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, status: newStatus });
                        }
                    } else {
                        console.error('Failed to update order status');
                        alert('Failed to update order status');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    alert('Error updating order status');
                }
            }

            async updateOrderPickupDateTime(orderId, newDate, newTime) {
                try {
                    const updateData = {};
                    if (newDate !== undefined) updateData.pickup_date = newDate;
                    if (newTime !== undefined) updateData.pickup_time = newTime;
                    
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            if (newDate !== undefined) this.orders[orderIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.orders[orderIndex].pickup_time = newTime;
                        }
                        
                        // Also update in filteredOrders if it exists
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            if (newDate !== undefined) this.filteredOrders[filteredIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.filteredOrders[filteredIndex].pickup_time = newTime;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, ...updateData });
                        }
                    } else {
                        console.error('Failed to update pickup date/time');
                        alert('Failed to update pickup date/time');
                    }
                } catch (error) {
                    console.error('Error updating pickup date/time:', error);
                    alert('Error updating pickup date/time');
                }
            }

            setupSocket() {
                this.socket = io();
                
                this.socket.on('order_created', () => {
                    this.loadOrders();
                });

                this.socket.on('order_updated', () => {
                    this.loadOrders();
                });

                this.socket.on('order_deleted', () => {
                    this.loadOrders();
                });
            }

            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                
                const mainContent = document.querySelector('.main-content');
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            updateFlatpickrInstances() {
                console.log('Updating all flatpickr instances with new settings...');
                
                if (!this.settings.pickup_settings) {
                    console.log('No pickup settings available for updating flatpickr instances');
                    return;
                }
                
                const pickupSettings = this.settings.pickup_settings;
                
                // Build disabled days array
                const disabledDays = [];
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                dayNames.forEach((dayName, index) => {
                    if (!pickupSettings.pickup_days[dayName]) {
                        disabledDays.push(index);
                    }
                });
                
                console.log('Updating flatpickr instances with:', {
                    disabledDays,
                    timeIncrement: pickupSettings.time_increment,
                    minTime: pickupSettings.pickup_start_time,
                    maxTime: pickupSettings.pickup_end_time
                });
                
                // Update each flatpickr instance
                this.flatpickrInstances.forEach((instance, index) => {
                    if (instance && typeof instance.set === 'function') {
                        try {
                        instance.set('disable', [
                            function(date) {
                                // Disable specific days of the week
                                const dayOfWeek = date.getDay();
                                if (disabledDays.includes(dayOfWeek)) {
                                    return true;
                                }
                                
                                // Disable unavailable dates
                                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                                if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                                    return true;
                                }
                                
                                return false;
                            }
                        ]);
                            instance.set('minuteIncrement', parseInt(pickupSettings.time_increment));
                            instance.set('minTime', pickupSettings.pickup_start_time);
                            instance.set('maxTime', pickupSettings.pickup_end_time);
                            console.log(`Updated flatpickr instance ${index}`);
                        } catch (error) {
                            console.error(`Error updating flatpickr instance ${index}:`, error);
                        }
                    }
                });
            }

            initializeSettingsTimePickers() {
            // Initialize flatpickr for start time (time only, no restrictions)
            const startTimeInput = document.getElementById('pickup-start-time');
            if (startTimeInput) {
                flatpickr(startTimeInput, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K", // 12-hour format: 9:00 AM
                    time_24hr: false,
                    minuteIncrement: 15,
                    defaultDate: startTimeInput.value || "9:00 AM"
                });
            }

            // Initialize flatpickr for end time (time only, no restrictions)
            const endTimeInput = document.getElementById('pickup-end-time');
            if (endTimeInput) {
                flatpickr(endTimeInput, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K", // 12-hour format: 5:00 PM
                    time_24hr: false,
                    minuteIncrement: 15,
                    defaultDate: endTimeInput.value || "5:00 PM"
                });
            }
        }

        // Options & Prices Management Methods
        async loadOptions() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const options = await response.json();
                    this.displayOptions(options);
                } else {
                    this.showAlert('Failed to load options', 'error');
                }
            } catch (error) {
                console.error('Failed to load options:', error);
                this.showAlert('Failed to load options', 'error');
            }
        }

        async loadCombinations() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options/combinations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const combinations = await response.json();
                    this.displayCombinations(combinations);
                } else {
                    this.showAlert('Failed to load combinations', 'error');
                }
            } catch (error) {
                console.error('Failed to load combinations:', error);
                this.showAlert('Failed to load combinations', 'error');
            }
        }

        displayOptions(options) {
            // Display paper sizes
            const paperSizesList = document.getElementById('paper-sizes-list');
            paperSizesList.innerHTML = options.paperSizes.map(size => `
                <div class="option-item" data-id="${size.id}" data-sort-order="${size.sort_order}">
                    <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
                    <input type="text" class="option-display" value="${size.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('paper-sizes', ${size.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${size.sort_order}" onchange="updateOption('paper-sizes', ${size.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger-mauve" onclick="deleteOption('paper-sizes', ${size.id})" title="Delete">🗑️</button>
                </div>
            `).join('');

            // Display paper types
            const paperTypesList = document.getElementById('paper-types-list');
            paperTypesList.innerHTML = options.paperTypes.map(type => `
                <div class="option-item" data-id="${type.id}" data-sort-order="${type.sort_order}">
                    <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
                    <input type="text" class="option-display" value="${type.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('paper-types', ${type.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${type.sort_order}" onchange="updateOption('paper-types', ${type.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger-mauve" onclick="deleteOption('paper-types', ${type.id})" title="Delete">🗑️</button>
                </div>
            `).join('');

            // Display color modes
            const colorModesList = document.getElementById('color-modes-list');
            colorModesList.innerHTML = options.colorModes.map(mode => `
                <div class="option-item" data-id="${mode.id}" data-sort-order="${mode.sort_order}">
                    <div class="drag-handle" title="Drag to reorder">⋮⋮</div>
                    <input type="text" class="option-display" value="${mode.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('color-modes', ${mode.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${mode.sort_order}" onchange="updateOption('color-modes', ${mode.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger-mauve" onclick="deleteOption('color-modes', ${mode.id})" title="Delete">🗑️</button>
                </div>
            `).join('');

            // Initialize sortable functionality after rendering
            this.initializeSortable();
        }

        displayCombinations(combinations) {
            const tbody = document.getElementById('combinations-tbody');
            tbody.innerHTML = combinations.map(combo => `
                <tr class="${combo.is_available ? '' : 'unavailable'}">
                    <td>${combo.paper_size_display}</td>
                    <td>${combo.paper_type_display}</td>
                    <td>${combo.color_mode_display}</td>
                    <td>
                        <input type="number" 
                               value="${combo.price}" 
                               step="0.01" 
                               min="0"
                               ${combo.is_available ? '' : 'disabled'}
                               onchange="updateCombination(${combo.id}, 'price', this.value)">
                    </td>
                    <td>
                        <span class="status-chip ${combo.is_available ? 'available' : 'unavailable'}" 
                              onclick="toggleAvailability(${combo.id}, ${combo.is_available})">
                            ${combo.is_available ? 'Available' : 'Unavailable'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        async addOption(type, data) {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`/api/options/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    this.showAlert(`${type} added successfully!`, 'success');
                    this.loadOptions();
                    this.loadCombinations();
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || `Failed to add ${type}`, 'error');
                }
            } catch (error) {
                console.error(`Failed to add ${type}:`, error);
                this.showAlert(`Failed to add ${type}`, 'error');
            }
        }

        async updateOption(type, id, field, value) {
            try {
                const token = localStorage.getItem('admin_token');
                const updateData = { [field]: value };
                
                const response = await fetch(`/api/options/${type}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    this.showAlert(`${type} updated successfully!`, 'success');
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || `Failed to update ${type}`, 'error');
                }
            } catch (error) {
                console.error(`Failed to update ${type}:`, error);
                this.showAlert(`Failed to update ${type}`, 'error');
            }
        }

        async deleteOption(type, id) {
            // Get the option name for display in modal
            let optionName = 'Unknown';
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const options = await response.json();
                    if (type === 'paper-sizes' && options.paperSizes) {
                        const option = options.paperSizes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    } else if (type === 'paper-types' && options.paperTypes) {
                        const option = options.paperTypes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    } else if (type === 'color-modes' && options.colorModes) {
                        const option = options.colorModes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    }
                }
            } catch (error) {
                console.error('Error getting option name:', error);
            }
            
            // Open modal instead of using confirm()
            openDeleteOptionModal(type, id, optionName);
        }

        async updateCombination(id, field, value) {
            try {
                const token = localStorage.getItem('admin_token');
                const updateData = { [field]: value };
                console.log(`Sending update for combination ${id}:`, updateData);
                
                const response = await fetch(`/api/options/combinations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    this.showAlert('Combination updated successfully!', 'success');
                    // Reload combinations to update the display
                    this.loadCombinations();
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || 'Failed to update combination', 'error');
                }
            } catch (error) {
                console.error('Failed to update combination:', error);
                this.showAlert('Failed to update combination', 'error');
            }
        }

        initializeSortable() {
            // Initialize sortable for paper sizes
            const paperSizesList = document.getElementById('paper-sizes-list');
            if (paperSizesList && !paperSizesList.sortableInstance) {
                paperSizesList.sortableInstance = new Sortable(paperSizesList, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        this.updateSortOrder('paper-sizes', evt.oldIndex, evt.newIndex);
                    }
                });
            }

            // Initialize sortable for paper types
            const paperTypesList = document.getElementById('paper-types-list');
            if (paperTypesList && !paperTypesList.sortableInstance) {
                paperTypesList.sortableInstance = new Sortable(paperTypesList, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        this.updateSortOrder('paper-types', evt.oldIndex, evt.newIndex);
                    }
                });
            }

            // Initialize sortable for color modes
            const colorModesList = document.getElementById('color-modes-list');
            if (colorModesList && !colorModesList.sortableInstance) {
                colorModesList.sortableInstance = new Sortable(colorModesList, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: (evt) => {
                        this.updateSortOrder('color-modes', evt.oldIndex, evt.newIndex);
                    }
                });
            }
        }

            async updateSortOrder(optionType, oldIndex, newIndex) {
                try {
                    const listElement = document.getElementById(`${optionType.replace('-', '-')}-list`);
                    if (!listElement) return;

                    // Show loading state
                    listElement.style.opacity = '0.6';
                    listElement.style.pointerEvents = 'none';

                    const items = Array.from(listElement.children);
                    const updates = [];

                    // Calculate new sort orders for all items
                    items.forEach((item, index) => {
                        const id = item.getAttribute('data-id');
                        const newSortOrder = index + 1;
                        updates.push({ id: parseInt(id), sort_order: newSortOrder });
                    });

                    // Update all sort orders via API
                    const token = localStorage.getItem('admin_token');
                    const promises = updates.map(update => 
                        fetch(`/api/options/${optionType}/${update.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ sort_order: update.sort_order })
                        })
                    );

                    await Promise.all(promises);
                    
                    // Update data attributes to reflect new sort order
                    items.forEach((item, index) => {
                        item.setAttribute('data-sort-order', index + 1);
                        const sortInput = item.querySelector('.option-sort');
                        if (sortInput) {
                            sortInput.value = index + 1;
                        }
                    });

                    // Restore normal state
                    listElement.style.opacity = '1';
                    listElement.style.pointerEvents = 'auto';

                    this.showAlert(`${optionType} reordered successfully!`, 'success');
                } catch (error) {
                    console.error('Failed to update sort order:', error);
                    
                    // Restore normal state on error
                    const listElement = document.getElementById(`${optionType.replace('-', '-')}-list`);
                    if (listElement) {
                        listElement.style.opacity = '1';
                        listElement.style.pointerEvents = 'auto';
                    }
                    
                    this.showAlert('Failed to update sort order', 'error');
                    // Reload options to restore correct order
                    this.loadOptions();
                }
            }

            sortOrders(column) {
                console.log('🔍 sortOrders called with column:', column);
                console.log('📊 Current filteredOrders length:', this.filteredOrders.length);
                console.log('📊 Current sort state:', this.currentSort);

                // Determine sort direction
                let direction = 'asc';
                if (this.currentSort.column === column && this.currentSort.direction === 'asc') {
                    direction = 'desc';
                }

                console.log('🔄 New sort direction:', direction);

                // Update sort state
                this.currentSort = { column, direction };

                // Update sort indicators
                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                    indicator.classList.remove('active', 'asc', 'desc');
                });

                const activeIndicator = document.querySelector(`[data-column="${column}"]`);
                if (activeIndicator) {
                    activeIndicator.classList.add('active', direction);
                    console.log('✅ Updated sort indicator for column:', column);
                } else {
                    console.log('❌ Could not find sort indicator for column:', column);
                }

                // Sort the filtered orders
                console.log('🔄 Sorting orders...');
                this.filteredOrders.sort((a, b) => {
                    let aVal, bVal;

                    switch (column) {
                        case 'order_number':
                            aVal = parseInt(a.order_number);
                            bVal = parseInt(b.order_number);
                            break;
                        case 'customer_name':
                            aVal = `${a.customer_first_name} ${a.customer_last_name}`.toLowerCase();
                            bVal = `${b.customer_first_name} ${b.customer_last_name}`.toLowerCase();
                            break;
                        case 'phone':
                            aVal = a.customer_phone;
                            bVal = b.customer_phone;
                            break;
                        case 'email':
                            aVal = a.customer_email.toLowerCase();
                            bVal = b.customer_email.toLowerCase();
                            break;
                        case 'status':
                            aVal = a.status;
                            bVal = b.status;
                            break;
                        case 'pickup_date':
                            aVal = a.pickup_date || '';
                            bVal = b.pickup_date || '';
                            break;
                        default:
                            return 0;
                    }

                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                console.log('✅ Orders sorted. First few orders:', this.filteredOrders.slice(0, 3));

                // Re-render the orders
                console.log('🔄 Calling displayOrders...');
                this.displayOrders();
            }

            setupModalValidation() {
                // Phone number formatting and validation
                const phoneInput = document.getElementById('customer-phone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', (e) => {
                        this.formatModalPhoneNumber(e.target);
                        this.validateModalPhone(e.target.value);
                    });

                    phoneInput.addEventListener('paste', (e) => {
                        setTimeout(() => {
                            this.formatModalPhoneNumber(e.target);
                            this.validateModalPhone(e.target.value);
                        }, 10);
                    });
                }

                // Email validation
                const emailInput = document.getElementById('customer-email');
                if (emailInput) {
                    emailInput.addEventListener('input', (e) => {
                        this.validateModalEmail(e.target.value);
                    });
                }

                // First name validation
                const firstNameInput = document.getElementById('customer-first-name');
                if (firstNameInput) {
                    firstNameInput.addEventListener('input', (e) => {
                        this.validateModalName(e.target.value, 'modal-first-name-indicator');
                    });
                }

                // Last name validation
                const lastNameInput = document.getElementById('customer-last-name');
                if (lastNameInput) {
                    lastNameInput.addEventListener('input', (e) => {
                        this.validateModalName(e.target.value, 'modal-last-name-indicator');
                    });
                }

                // Check form validity on any input change
                const form = document.getElementById('order-form');
                if (form) {
                    form.addEventListener('input', () => {
                        this.checkModalFormValidity();
                    });
                }
            }

            formatModalPhoneNumber(input) {
                let value = input.value.replace(/\D/g, ''); // Remove all non-digits
                
                // Limit to 10 digits
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                
                // Format as (XXX) XXX-XXXX
                if (value.length >= 6) {
                    value = `(${value.substring(0, 3)}) ${value.substring(3, 6)}-${value.substring(6)}`;
                } else if (value.length >= 3) {
                    value = `(${value.substring(0, 3)}) ${value.substring(3)}`;
                } else if (value.length > 0) {
                    value = `(${value}`;
                }
                
                input.value = value;
            }

            validateModalPhone(phone) {
                const phoneRegex = /^\(\d{3}\) \d{3}-\d{4}$/;
                const isValid = phoneRegex.test(phone);
                const indicator = document.getElementById('modal-phone-indicator');
                const message = document.getElementById('modal-phone-message');
                
                if (phone.length === 0) {
                    indicator.textContent = '';
                    indicator.className = 'validation-indicator';
                    message.textContent = '';
                    message.className = 'validation-message';
                } else if (isValid) {
                    indicator.textContent = '✓';
                    indicator.className = 'validation-indicator valid';
                    message.textContent = 'Valid phone number';
                    message.className = 'validation-message success';
                } else {
                    indicator.textContent = '✗';
                    indicator.className = 'validation-indicator invalid';
                    message.textContent = 'Please enter a valid phone number';
                    message.className = 'validation-message error';
                }
                
                return isValid;
            }

            validateModalEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const isValid = emailRegex.test(email);
                const indicator = document.getElementById('modal-email-indicator');
                const message = document.getElementById('modal-email-message');
                
                if (email.length === 0) {
                    indicator.textContent = '';
                    indicator.className = 'validation-indicator';
                    message.textContent = '';
                    message.className = 'validation-message';
                } else if (isValid) {
                    indicator.textContent = '✓';
                    indicator.className = 'validation-indicator valid';
                    message.textContent = 'Valid email address';
                    message.className = 'validation-message success';
                } else {
                    indicator.textContent = '✗';
                    indicator.className = 'validation-indicator invalid';
                    message.textContent = 'Please enter a valid email address';
                    message.className = 'validation-message error';
                }
                
                return isValid;
            }

            validateModalName(name, indicatorId) {
                const isValid = name.trim().length > 0;
                const indicator = document.getElementById(indicatorId);
                
                if (name.length === 0) {
                    indicator.textContent = '';
                    indicator.className = 'validation-indicator';
                } else if (isValid) {
                    indicator.textContent = '✓';
                    indicator.className = 'validation-indicator valid';
                }
                
                return isValid;
            }

            checkModalFormValidity() {
                const phone = document.getElementById('customer-phone').value;
                const email = document.getElementById('customer-email').value;
                const firstName = document.getElementById('customer-first-name').value;
                const lastName = document.getElementById('customer-last-name').value;
                
                const isPhoneValid = this.validateModalPhone(phone);
                const isEmailValid = this.validateModalEmail(email);
                const isFirstNameValid = this.validateModalName(firstName, 'modal-first-name-indicator');
                const isLastNameValid = this.validateModalName(lastName, 'modal-last-name-indicator');
                
                const submitButton = document.querySelector('#order-form button[type="submit"]');
                const isFormValid = isPhoneValid && isEmailValid && isFirstNameValid && isLastNameValid;
                
                if (submitButton) {
                    submitButton.disabled = !isFormValid;
                }
                
                return isFormValid;
            }
    }

        // Global functions for order management
        function openOrderModal(orderId = null) {
            // Ensure settings are loaded before opening modal
            if (!adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('Settings not loaded yet for edit modal, loading settings first...');
                adminPanel.loadSettings().then(() => {
                    openOrderModal(orderId);
                });
                return;
            }
            
            const modal = document.getElementById('order-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('order-form');
            
            if (orderId) {
                title.textContent = 'Edit Order';
                // Load order data
                const order = adminPanel.orders.find(o => o.id === orderId);
                if (order) {
                    document.getElementById('order-id').value = order.id;
                    document.getElementById('customer-first-name').value = order.customer_first_name;
                    document.getElementById('customer-last-name').value = order.customer_last_name;
                    document.getElementById('customer-phone').value = order.customer_phone;
                    document.getElementById('customer-email').value = order.customer_email;
                    document.getElementById('customer-address').value = order.customer_address;
                    // Combine date and time for flatpickr and format for display
                    let datetimeValue = '';
                    if (order.pickup_date) {
                        datetimeValue = order.pickup_date;
                        if (order.pickup_time) {
                            datetimeValue += ' ' + order.pickup_time;
                        }
                        // Convert from database format (YYYY-MM-DD HH:MM) to display format (n/j/Y h:i K)
                        const dateTime = new Date(datetimeValue);
                        if (!isNaN(dateTime.getTime())) {
                            const month = dateTime.getMonth() + 1; // 0-based to 1-based
                            const day = dateTime.getDate();
                            const year = dateTime.getFullYear();
                            const hours = dateTime.getHours();
                            const minutes = dateTime.getMinutes();
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            const displayHours = hours % 12 || 12; // Convert to 12-hour format
                            const displayMinutes = minutes.toString().padStart(2, '0');
                            datetimeValue = `${month}/${day}/${year} ${displayHours}:${displayMinutes} ${ampm}`;
                        }
                    }
                    document.getElementById('pickup-datetime').value = datetimeValue;
                    document.getElementById('status').value = order.status;
                    document.getElementById('copies').value = order.copies || 1;
                    document.getElementById('order-description').value = order.order_description || '';
                    document.getElementById('special-instructions').value = order.special_instructions || '';
                    document.getElementById('notes').value = order.notes || '';
                }
            } else {
                title.textContent = 'Add New Order';
                form.reset();
                document.getElementById('order-id').value = '';
            }
            
            modal.style.display = 'block';
            
            // Apply pickup restrictions to the edit order modal
            setTimeout(() => {
                applyPickupRestrictionsToEditModal();
                // Trigger validation for existing data
                adminPanel.checkModalFormValidity();
            }, 100);
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
            // Clear file upload
            const fileInput = document.getElementById('modal-file-input');
            const fileInfo = document.getElementById('modal-file-info');
            if (fileInput) fileInput.value = '';
            if (fileInfo) fileInfo.style.display = 'none';
        }

        function viewOrder(orderId) {
            const order = adminPanel.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            // Set up order navigation
            setupOrderNavigation(orderId);

            // Update modal title
            document.getElementById('view-modal-title').textContent = `Order Details - #${order.order_number}`;

            // Populate order details
            document.getElementById('view-customer-name').textContent = `${order.customer_first_name} ${order.customer_last_name}`;
            document.getElementById('view-customer-phone').textContent = order.customer_phone;
            document.getElementById('view-customer-email').textContent = order.customer_email;
            document.getElementById('view-customer-address').textContent = order.customer_address;
            document.getElementById('view-order-number').textContent = order.order_number;
            document.getElementById('view-status').innerHTML = `<span class="status-badge status-${order.status}">${adminPanel.formatStatusText(order.status)}</span>`;
            document.getElementById('view-copies').textContent = order.copies || 1;
            document.getElementById('view-pickup-date').textContent = adminPanel.formatPickupDateTime(order.pickup_date, order.pickup_time);
            
            // Print specifications
            document.getElementById('view-paper-size').textContent = order.paper_size || 'Not specified';
            document.getElementById('view-paper-type').textContent = order.paper_type || 'Not specified';
            document.getElementById('view-color-mode').textContent = order.color_mode || 'Not specified';
            document.getElementById('view-double-sided').textContent = order.double_sided ? 'Yes' : 'No';
            document.getElementById('view-print-ready').textContent = order.print_ready ? 'Yes' : 'No';
            document.getElementById('view-binding').textContent = order.binding_type || 'None';
            document.getElementById('view-finishing').textContent = order.finishing_options || 'None';
            document.getElementById('view-rush-order').textContent = order.rush_order ? 'Yes' : 'No';
            
            // Additional information
            document.getElementById('view-description').textContent = order.order_description || 'None';
            document.getElementById('view-special-instructions').textContent = order.special_instructions || 'None';
            document.getElementById('view-notes').textContent = order.notes || 'None';

            // Load file preview
            loadFilePreview(order);

            // Show modal
            document.getElementById('view-order-modal').style.display = 'block';
        }
        
        function setupOrderNavigation(currentOrderId) {
            // Get the same filtered/sorted orders that the table is using
            // This matches the logic in displayOrders()
            filteredOrders = (adminPanel.currentSort.column || Object.keys(adminPanel.activeFilters).length > 0) 
                ? adminPanel.filteredOrders 
                : adminPanel.orders;
            
            // Find current order index
            currentOrderIndex = filteredOrders.findIndex(order => order.id === currentOrderId);
            
            // Show/hide navigation based on number of orders
            const navigation = document.getElementById('order-navigation');
            if (filteredOrders.length > 1) {
                navigation.style.display = 'flex';
                updateOrderNavigation();
                
                // Set up event listeners
                document.getElementById('prev-order-btn').onclick = () => navigateToOrder('prev');
                document.getElementById('next-order-btn').onclick = () => navigateToOrder('next');
            } else {
                navigation.style.display = 'none';
            }
        }
        
        function updateOrderNavigation() {
            const position = document.getElementById('order-position');
            const prevBtn = document.getElementById('prev-order-btn');
            const nextBtn = document.getElementById('next-order-btn');
            
            // Update position text
            position.textContent = `${currentOrderIndex + 1} of ${filteredOrders.length}`;
            
            // Update button states
            prevBtn.disabled = currentOrderIndex === 0;
            nextBtn.disabled = currentOrderIndex === filteredOrders.length - 1;
        }
        
        function navigateToOrder(direction) {
            if (direction === 'prev' && currentOrderIndex > 0) {
                currentOrderIndex--;
            } else if (direction === 'next' && currentOrderIndex < filteredOrders.length - 1) {
                currentOrderIndex++;
            } else {
                return; // No navigation needed
            }
            
            // Load the new order
            const newOrder = filteredOrders[currentOrderIndex];
            loadOrderInModal(newOrder);
            updateOrderNavigation();
        }
        
        function loadOrderInModal(order) {
            // Update modal title
            document.getElementById('view-modal-title').textContent = `Order Details - #${order.order_number}`;
            
            // Populate order details
            document.getElementById('view-customer-name').textContent = `${order.customer_first_name} ${order.customer_last_name}`;
            document.getElementById('view-customer-phone').textContent = order.customer_phone;
            document.getElementById('view-customer-email').textContent = order.customer_email;
            document.getElementById('view-customer-address').textContent = order.customer_address;
            document.getElementById('view-order-number').textContent = order.order_number;
            document.getElementById('view-status').innerHTML = `<span class="status-badge status-${order.status}">${adminPanel.formatStatusText(order.status)}</span>`;
            document.getElementById('view-copies').textContent = order.copies || 1;
            document.getElementById('view-pickup-date').textContent = adminPanel.formatPickupDateTime(order.pickup_date, order.pickup_time);
            
            // Print specifications
            document.getElementById('view-paper-size').textContent = order.paper_size || 'Not specified';
            document.getElementById('view-paper-type').textContent = order.paper_type || 'Not specified';
            document.getElementById('view-color-mode').textContent = order.color_mode || 'Not specified';
            document.getElementById('view-double-sided').textContent = order.double_sided ? 'Yes' : 'No';
            document.getElementById('view-print-ready').textContent = order.print_ready ? 'Yes' : 'No';
            document.getElementById('view-binding').textContent = order.binding_type || 'None';
            document.getElementById('view-finishing').textContent = order.finishing_options || 'None';
            document.getElementById('view-rush-order').textContent = order.rush_order ? 'Yes' : 'No';
            
            // Additional information
            document.getElementById('view-description').textContent = order.order_description || 'None';
            document.getElementById('view-special-instructions').textContent = order.special_instructions || 'None';
            document.getElementById('view-notes').textContent = order.notes || 'None';
            
            // Load file preview
            loadFilePreview(order);
        }

        function closeViewOrderModal() {
            document.getElementById('view-order-modal').style.display = 'none';
            // Clear file preview
            const previewContainer = document.getElementById('file-preview');
            previewContainer.innerHTML = `
                <div class="preview-placeholder">
                    <div class="preview-icon">📄</div>
                    <p>File preview will appear here</p>
                </div>
            `;
            // Reset container styling
            previewContainer.style.display = 'flex';
            previewContainer.style.textAlign = 'initial';
            document.getElementById('download-file-btn').style.display = 'none';
            document.getElementById('pdf-controls').style.display = 'none';
            
            // Reset PDF state
            currentPDF = null;
            currentPage = 1;
            currentScale = 1;
            isAutoFit = true;
            
            // Highlight the current order row and navigate to its page if needed
            if (filteredOrders.length > 0 && currentOrderIndex >= 0) {
                const currentOrder = filteredOrders[currentOrderIndex];
                highlightOrderRow(currentOrder.id);
            }
            
            // Reset navigation state
            filteredOrders = [];
            currentOrderIndex = 0;
        }
        
        function highlightOrderRow(orderId) {
            // Find the order row in the table
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (orderRow) {
                // Remove any existing highlights
                document.querySelectorAll('.order-row').forEach(row => {
                    row.classList.remove('highlighted');
                });
                
                // Highlight the current row
                orderRow.classList.add('highlighted');
                
                // Scroll the row into view
                orderRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function loadFilePreview(order) {
            const previewContainer = document.getElementById('file-preview');
            const downloadBtn = document.getElementById('download-file-btn');
            const pdfControls = document.getElementById('pdf-controls');
            
            // Hide PDF controls by default (will be shown if it's a PDF)
            pdfControls.style.display = 'none';
            
            if (!order.file_path) {
                previewContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <div class="preview-icon">📄</div>
                        <p>No file uploaded</p>
                    </div>
                `;
                downloadBtn.style.display = 'none';
                return;
            }

            // Show loading state
            previewContainer.innerHTML = `
                <div class="preview-placeholder">
                    <div class="preview-icon">⏳</div>
                    <p>Loading preview...</p>
                </div>
            `;

            try {
                // Use the filename directly (now stored as relative path)
                const fileName = order.file_path;
                const fileUrl = `/uploads/${fileName}`;
                const fileExtension = fileName.split('.').pop().toLowerCase();

                // Set up download button
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = fileName;
                    link.click();
                };

                if (fileExtension === 'pdf') {
                    await loadPDFPreview(fileUrl, previewContainer);
                } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                    loadImagePreview(fileUrl, previewContainer);
                } else {
                    previewContainer.innerHTML = `
                        <div class="preview-placeholder">
                            <div class="preview-icon">📄</div>
                            <p>Preview not available for ${fileExtension.toUpperCase()} files</p>
                            <p>File: ${fileName}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading file preview:', error);
                previewContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <div class="preview-icon">❌</div>
                        <p>Error loading preview</p>
                        <p>File: ${fileName || order.file_path}</p>
                    </div>
                `;
            }
        }

        // Global PDF state
        let currentPDF = null;
        let currentPage = 1;
        let currentScale = 1;
        let isAutoFit = true; // Track if we're in auto-fit mode
        
        // Global order navigation state
        let filteredOrders = [];
        let currentOrderIndex = 0;

        async function loadPDFPreview(fileUrl, container) {
            try {
                // Set up PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                currentPDF = await pdfjsLib.getDocument(fileUrl).promise;
                currentPage = 1;
                currentScale = 1;
                isAutoFit = true;
                
                // Calculate initial auto-fit scale
                const container = document.getElementById('file-preview');
                const page = await currentPDF.getPage(1);
                const containerWidth = container.clientWidth - 40;
                const containerHeight = container.clientHeight - 40;
                const viewport = page.getViewport({ scale: 1 });
                const scaleX = containerWidth / viewport.width;
                const scaleY = containerHeight / viewport.height;
                const initialScale = Math.min(scaleX, scaleY, 1.5);
                currentScale = initialScale; // Set the actual auto-fit scale
                
                // Show PDF controls
                const pdfControls = document.getElementById('pdf-controls');
                pdfControls.style.display = 'block';
                
                // Setup PDF controls
                setupPDFControls();
                
                // Render first page
                await renderPDFPage();
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                container.innerHTML = `
                    <div class="preview-placeholder">
                        <div class="preview-icon">❌</div>
                        <p>Error loading PDF preview</p>
                    </div>
                `;
            }
        }

        async function renderPDFPage() {
            if (!currentPDF) return;
            
            const container = document.getElementById('file-preview');
            const page = await currentPDF.getPage(currentPage);
            
            // Calculate scale
            let scale = currentScale;
            
            if (isAutoFit) {
                // Auto-fit scale - fit to width only
                const containerWidth = container.clientWidth - 40;
                const viewport = page.getViewport({ scale: 1 });
                
                const scaleX = containerWidth / viewport.width;
                scale = Math.min(scaleX, 1.5); // Fit to width, max 150%
            }
            // For manual zoom, use currentScale directly (no auto-fitting)
            
            const scaledViewport = page.getViewport({ scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;
            canvas.className = 'pdf-viewer';
            
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport
            };
            
            await page.render(renderContext).promise;
            
            container.innerHTML = '';
            container.appendChild(canvas);
            
            // For PDFs, remove flex centering and use margin positioning
            container.style.display = 'block';
            container.style.textAlign = 'center';
            
            // Update controls
            updatePDFControls();
        }

        function setupPDFControls() {
            // Page navigation
            document.getElementById('prev-page-btn').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPDFPage();
                }
            };
            
            document.getElementById('next-page-btn').onclick = () => {
                if (currentPage < currentPDF.numPages) {
                    currentPage++;
                    renderPDFPage();
                }
            };
            
            // Zoom controls
            document.getElementById('zoom-in-btn').onclick = () => {
                isAutoFit = false; // Exit auto-fit mode
                currentScale = Math.min(currentScale * 1.2, 5); // Allow up to 500% zoom
                renderPDFPage();
            };
            
            document.getElementById('zoom-out-btn').onclick = () => {
                isAutoFit = false; // Exit auto-fit mode
                currentScale = Math.max(currentScale / 1.2, 0.1); // Allow down to 10% zoom
                renderPDFPage();
            };
            
            document.getElementById('fit-width-btn').onclick = () => {
                isAutoFit = true; // Enter auto-fit mode
                // Don't reset currentScale here - let auto-fit calculate it
                renderPDFPage();
            };
            
        }

        function updatePDFControls() {
            // Update page info
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${currentPDF.numPages}`;
            
            // Update zoom level
            let zoomPercent;
            if (isAutoFit) {
                zoomPercent = 'Auto';
            } else {
                zoomPercent = Math.round(currentScale * 100);
            }
            document.getElementById('zoom-level').textContent = `${zoomPercent}%`;
            
            // Update button states
            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= currentPDF.numPages;
        }


        function loadImagePreview(fileUrl, container) {
            const img = document.createElement('img');
            img.src = fileUrl;
            img.className = 'image-viewer';
            img.onload = () => {
                container.innerHTML = '';
                container.appendChild(img);
                // Reset container styling for images
                container.style.display = 'flex';
                container.style.textAlign = 'initial';
            };
            img.onerror = () => {
                container.innerHTML = `
                    <div class="preview-placeholder">
                        <div class="preview-icon">❌</div>
                        <p>Error loading image preview</p>
                    </div>
                `;
                // Reset container styling for error state
                container.style.display = 'flex';
                container.style.textAlign = 'initial';
            };
        }

        function editOrder(orderId) {
            openOrderModal(orderId);
        }

        function deleteOrder(orderId) {
            openDeleteConfirmationModal(orderId);
        }

        function logout() {
            adminPanel.logout();
        }

        function saveSettings() {
            adminPanel.saveSettings();
        }

        function resetToDefaultColors() {
            // Default colors from the CSS
            const defaultColors = {
                received: { background: '#DBEAFE', text: '#1E40AF' },
                paid: { background: '#D1FAE5', text: '#065F46' },
                in_progress: { background: '#FEF3C7', text: '#92400E' },
                ready_for_pickup: { background: '#FEF3C7', text: '#92400E' }
            };

            // Set the background color picker values to defaults
            document.getElementById('color-received-bg').value = defaultColors.received.background;
            document.getElementById('color-paid-bg').value = defaultColors.paid.background;
            document.getElementById('color-in_progress-bg').value = defaultColors.in_progress.background;
            document.getElementById('color-ready_for_pickup-bg').value = defaultColors.ready_for_pickup.background;

            // Set the text color picker values to defaults
            document.getElementById('color-received-text').value = defaultColors.received.text;
            document.getElementById('color-paid-text').value = defaultColors.paid.text;
            document.getElementById('color-in_progress-text').value = defaultColors.in_progress.text;
            document.getElementById('color-ready_for_pickup-text').value = defaultColors.ready_for_pickup.text;

            // Show confirmation message
            adminPanel.showAlert('Colors reset to defaults! Click "Save Settings" to apply.', 'info');
        }

        function exportOrders() {
            adminPanel.exportOrders();
        }

        // Options & Prices Global Functions
        function addPaperSize() {
            const displayName = document.getElementById('new-paper-size-display').value;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('paper-sizes', { display_name: displayName, sort_order: 0 });
            
            // Clear form
            document.getElementById('new-paper-size-display').value = '';
        }

        function addPaperType() {
            const displayName = document.getElementById('new-paper-type-display').value;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('paper-types', { display_name: displayName, sort_order: 0 });
            
            // Clear form
            document.getElementById('new-paper-type-display').value = '';
        }

        function addColorMode() {
            const displayName = document.getElementById('new-color-mode-display').value;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('color-modes', { display_name: displayName, sort_order: 0 });
            
            // Clear form
            document.getElementById('new-color-mode-display').value = '';
        }

        function updateOption(type, id, field, value) {
            adminPanel.updateOption(type, id, field, value);
        }

        function deleteOption(type, id) {
            adminPanel.deleteOption(type, id);
        }

        function updateCombination(id, field, value) {
            adminPanel.updateCombination(id, field, value);
        }

        // Debounce timer for availability toggles
        let availabilityDebounceTimers = {};

        function toggleAvailability(id, currentStatus) {
            const newStatus = !currentStatus;
            
            // Clear any existing timer for this combination
            if (availabilityDebounceTimers[id]) {
                clearTimeout(availabilityDebounceTimers[id]);
            }
            
            // Update the UI immediately for visual feedback
            const chip = document.querySelector(`[onclick*="toggleAvailability(${id}"]`);
            if (chip) {
                chip.textContent = newStatus ? 'Available' : 'Unavailable';
                chip.className = `status-chip ${newStatus ? 'available' : 'unavailable'}`;
            }
            
            // Set a new timer to make the API call after 300ms
            availabilityDebounceTimers[id] = setTimeout(() => {
                adminPanel.updateCombination(id, 'is_available', newStatus);
                // Clean up the timer reference
                delete availabilityDebounceTimers[id];
            }, 300);
        }

        function sortOrders(column) {
            console.log('🌐 Global sortOrders function called with column:', column);
            console.log('🌐 adminPanel exists:', !!adminPanel);
            if (adminPanel) {
                adminPanel.sortOrders(column);
            } else {
                console.log('❌ adminPanel is not available');
            }
        }

        function applyStatusFilter(statusType) {
            adminPanel.applyStatusFilter(statusType);
        }

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const mobileMenu = document.getElementById('mobile-nav-menu');
            mobileMenu.classList.toggle('active');
        }

        function switchTab(tabName) {
            // Close mobile menu
            const mobileMenu = document.getElementById('mobile-nav-menu');
            mobileMenu.classList.remove('active');
            
            // Switch to the tab
            adminPanel.switchTab(tabName);
        }

        // Delete confirmation modal functions
        let orderToDelete = null;

        function openDeleteConfirmationModal(orderId) {
            // Find the order details
            const order = adminPanel.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            orderToDelete = orderId;

            // Populate order details
            const orderDetails = document.getElementById('delete-order-details');
            orderDetails.innerHTML = `
                <strong>Order #${order.order_number}</strong><br>
                Customer: ${order.customer_first_name} ${order.customer_last_name}<br>
                Phone: ${order.customer_phone}<br>
                Status: ${adminPanel.formatStatusText(order.status)}
            `;

            // Show modal
            const modal = document.getElementById('delete-confirmation-modal');
            modal.style.display = 'block';
        }

        function closeDeleteConfirmationModal() {
            const modal = document.getElementById('delete-confirmation-modal');
            modal.style.display = 'none';
            orderToDelete = null;
        }

        async function confirmDeleteOrder() {
            if (!orderToDelete) {
                console.error('No order selected for deletion');
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    adminPanel.showAlert('Authentication required. Please log in again.', 'error');
                    return;
                }

                const response = await fetch(`/api/orders/${orderToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    adminPanel.showAlert('Order deleted successfully!', 'success');
                    
                    // Close modal
                    closeDeleteConfirmationModal();
                    
                    // Reload orders
                    await adminPanel.loadOrders();
                    
                    // Emit socket event for real-time updates
                    if (window.io) {
                        const socket = io();
                        socket.emit('order_deleted', { orderId: orderToDelete });
                    }
                } else if (response.status === 401 || response.status === 403) {
                    adminPanel.showAlert('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    adminPanel.showAlert(errorData.error || 'Failed to delete order', 'error');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                adminPanel.showAlert('An error occurred while deleting the order', 'error');
            }
        }

        // Option Delete Modal Functions
        let optionToDelete = null;

        function openDeleteOptionModal(type, id, optionName) {
            optionToDelete = { type, id, optionName };
            
            // Update modal content
            const message = document.getElementById('delete-option-message');
            const details = document.getElementById('delete-option-details');
            
            // Format type name with proper capitalization
            let formattedType = type.replace('-', ' ');
            if (formattedType === 'paper sizes') {
                formattedType = 'Paper Size';
            } else if (formattedType === 'paper types') {
                formattedType = 'Paper Type';
            } else if (formattedType === 'color modes') {
                formattedType = 'Color Mode';
            }
            
            message.textContent = `Are you sure you want to delete this ${formattedType}?`;
            details.innerHTML = `
                <strong>Option:</strong> ${optionName}<br>
                <strong>Type:</strong> ${formattedType}
            `;
            
            // Show modal
            const modal = document.getElementById('delete-option-modal');
            modal.style.display = 'block';
        }

        function closeDeleteOptionModal() {
            const modal = document.getElementById('delete-option-modal');
            modal.style.display = 'none';
            optionToDelete = null;
        }

        async function confirmDeleteOption() {
            if (!optionToDelete) {
                console.error('No option selected for deletion');
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    adminPanel.showAlert('Authentication required. Please log in again.', 'error');
                    return;
                }

                const response = await fetch(`/api/options/${optionToDelete.type}/${optionToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    adminPanel.showAlert(`${optionToDelete.type.replace('-', ' ')} deleted successfully!`, 'success');
                    
                    // Close modal
                    closeDeleteOptionModal();
                    
                    // Reload options and combinations
                    await adminPanel.loadOptions();
                    await adminPanel.loadCombinations();
                } else if (response.status === 401 || response.status === 403) {
                    adminPanel.showAlert('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    adminPanel.showAlert(errorData.error || 'Failed to delete option', 'error');
                }
            } catch (error) {
                console.error('Error deleting option:', error);
                adminPanel.showAlert('An error occurred while deleting the option', 'error');
            }
        }

        // Advanced Filter Functions
        function toggleFilterPanel() {
            const content = document.getElementById('filter-content');
            const toggleText = document.getElementById('filter-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'Hide Filters';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'Show Filters';
            }
        }

        function applyFilters() {
            adminPanel.applyFilters();
        }

        function clearAllFilters() {
            adminPanel.clearAllFilters();
        }

        function applyQuickFilter(type) {
            adminPanel.applyQuickFilter(type);
        }

        function removeFilter(key) {
            // Clear the specific filter
            switch (key) {
                case 'createdFrom':
                    document.getElementById('filter-created-from').value = '';
                    break;
                case 'createdTo':
                    document.getElementById('filter-created-to').value = '';
                    break;
                case 'pickupFrom':
                    document.getElementById('filter-pickup-from').value = '';
                    break;
                case 'pickupTo':
                    document.getElementById('filter-pickup-to').value = '';
                    break;
                case 'statuses':
                    document.querySelectorAll('.status-filters input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    break;
                case 'customerName':
                    document.getElementById('filter-customer-name').value = '';
                    break;
                case 'phone':
                    document.getElementById('filter-phone').value = '';
                    break;
                case 'email':
                    document.getElementById('filter-email').value = '';
                    break;
                case 'orderFrom':
                    document.getElementById('filter-order-from').value = '';
                    break;
                case 'orderTo':
                    document.getElementById('filter-order-to').value = '';
                    break;
                case 'description':
                    document.getElementById('filter-description').value = '';
                    break;
            }
            
            // Reapply filters
            adminPanel.applyFilters();
        }

        function saveFilterPreset() {
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName) {
                const filters = adminPanel.getFilterValues();
                localStorage.setItem(`filter_preset_${presetName}`, JSON.stringify(filters));
                adminPanel.showAlert(`Filter preset "${presetName}" saved!`, 'success');
            }
        }

        // Initialize the admin panel
        let adminPanel;
        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const orderModal = document.getElementById('order-modal');
            const viewOrderModal = document.getElementById('view-order-modal');
            const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
            const deleteOptionModal = document.getElementById('delete-option-modal');
            
            if (event.target === orderModal) {
                closeOrderModal();
            } else if (event.target === viewOrderModal) {
                closeViewOrderModal();
            } else if (event.target === deleteConfirmationModal) {
                closeDeleteConfirmationModal();
            } else if (event.target === deleteOptionModal) {
                closeDeleteOptionModal();
            }
        }

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const viewOrderModal = document.getElementById('view-order-modal');
                const orderModal = document.getElementById('order-modal');
                const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
                const deleteOptionModal = document.getElementById('delete-option-modal');
                
                if (viewOrderModal.style.display === 'block') {
                    closeViewOrderModal();
                } else if (orderModal.style.display === 'block') {
                    closeOrderModal();
                } else if (deleteConfirmationModal.style.display === 'block') {
                    closeDeleteConfirmationModal();
                } else if (deleteOptionModal.style.display === 'block') {
                    closeDeleteOptionModal();
                }
            }
        });

        // Global functions for inline editing
        function showStatusDropdown(orderId, currentStatus) {
            // Remove any existing dropdowns
            const existingDropdown = document.querySelector('.status-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }

            const statusOptions = [
                { value: 'received', label: 'Received' },
                { value: 'paid', label: 'Paid' },
                { value: 'in_progress', label: 'In Progress' },
                { value: 'ready_for_pickup', label: 'Ready for Pickup' },
                { value: 'picked_up', label: 'Picked Up' },
                { value: 'abandoned', label: 'Abandoned' }
            ];

            // Find the clicked status element
            const statusElement = event.target;
            
            const rect = statusElement.getBoundingClientRect();
            
            // Create dropdown first to calculate its height
            const dropdown = document.createElement('div');
            dropdown.className = 'status-dropdown';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 10) + 'px'; // Temporary position
            dropdown.style.visibility = 'hidden'; // Hide while calculating
            
            // Add status options to calculate height
            statusOptions.forEach(status => {
                const option = document.createElement('div');
                option.className = 'status-option';
                option.innerHTML = `
                    <span class="status-badge status-${status.value}">${status.label}</span>
                `;
                dropdown.appendChild(option);
            });
            
            // Add to DOM temporarily to measure
            document.body.appendChild(dropdown);
            
            // Calculate dropdown height and available space
            const dropdownHeight = dropdown.offsetHeight;
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Determine optimal position
            let topPosition;
            if (spaceBelow >= dropdownHeight + 10) {
                // Enough space below - position below the chip
                topPosition = rect.bottom + 10;
            } else if (spaceAbove >= dropdownHeight + 10) {
                // Not enough space below, but enough above - position above the chip
                topPosition = rect.top - dropdownHeight - 10;
            } else {
                // Not enough space above or below - position below but adjust for viewport
                topPosition = Math.min(rect.bottom + 10, window.innerHeight - dropdownHeight - 10);
            }
            
            // Set final position and make visible
            dropdown.style.top = topPosition + 'px';
            dropdown.style.visibility = 'visible';

            // Add click handlers to existing options
            const options = dropdown.querySelectorAll('.status-option');
            options.forEach((option, index) => {
                const status = statusOptions[index];
                
                if (status.value === currentStatus) {
                    option.style.backgroundColor = '#e5e7eb';
                }
                
                option.addEventListener('click', () => {
                    adminPanel.updateOrderStatus(orderId, status.value);
                    dropdown.remove();
                });
            });

            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== statusElement) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                    window.removeEventListener('scroll', closeDropdown);
                }
            };

            // Close dropdown when scrolling
            const closeOnScroll = () => {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
                window.removeEventListener('scroll', closeOnScroll);
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
                window.addEventListener('scroll', closeOnScroll);
            }, 100);
        }

        function showDateDropdown(orderId, currentDate, currentTime) {
            // Ensure settings are loaded before opening picker
            if (!adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('Settings not loaded yet, loading settings first...');
                adminPanel.loadSettings().then(() => {
                    showDateDropdown(orderId, currentDate, currentTime);
                });
                return;
            }

            // Remove any existing dropdowns
            const existingDropdown = document.querySelector('.date-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }

            // Find the clicked date element
            const dateElement = event.target;
            const rect = dateElement.getBoundingClientRect();

            // Create dropdown container
            const dropdown = document.createElement('div');
            dropdown.className = 'date-dropdown';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 10) + 'px';

            // Create hidden input for Flatpickr
            const input = document.createElement('input');
            input.type = 'text';
            input.style.display = 'none';
            dropdown.appendChild(input);

            // Add to DOM first
            document.body.appendChild(dropdown);

            // Format current date/time for Flatpickr
            let defaultDateTimeValue = '';
            if (currentDate) {
                defaultDateTimeValue = currentDate;
                if (currentTime) {
                    defaultDateTimeValue += ' ' + currentTime;
                }
            }

            // Initialize Flatpickr with simplified config
            
            const flatpickrInstance = flatpickr(input, {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: false,
                defaultDate: defaultDateTimeValue || undefined,
                minDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const selectedDate = selectedDates[0];
                        const newDate = selectedDate.toISOString().split('T')[0];
                        const newTime = selectedDate.toTimeString().split(' ')[0].substring(0, 5);
                        
                        // Update the order
                        adminPanel.updateOrderPickupDateTime(orderId, newDate, newTime);
                        
                        // Close dropdown
                        dropdown.remove();
                    }
                },
                onClose: function() {
                    // Close dropdown when Flatpickr closes
                    setTimeout(() => {
                        if (dropdown.parentNode) {
                            dropdown.remove();
                        }
                    }, 100);
                }
            });

            // Check if Flatpickr was initialized properly
            if (!flatpickrInstance) {
                console.error('Failed to initialize Flatpickr');
                dropdown.remove();
                return;
            }
            
            // Get the actual instance (Flatpickr returns an array)
            const fpInstance = Array.isArray(flatpickrInstance) ? flatpickrInstance[0] : flatpickrInstance;

            // Step 1: Calculate smart positioning BEFORE opening Flatpickr
            const targetLeft = rect.left;
            
            // Estimate calendar height (approximate)
            const estimatedCalendarHeight = 350; // Flatpickr calendar is roughly 350px tall
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            let targetTop;
            if (spaceBelow >= estimatedCalendarHeight + 10) {
                // Enough space below - position below the chip
                targetTop = rect.bottom + 10;
                console.log('📐 Positioning below chip (space below:', spaceBelow, 'px)');
            } else if (spaceAbove >= estimatedCalendarHeight + 10) {
                // Not enough space below, but enough above - position above the chip
                targetTop = rect.top - estimatedCalendarHeight - 10;
                console.log('📐 Positioning above chip (space above:', spaceAbove, 'px)');
            } else {
                // Not enough space above or below - position below but adjust for viewport
                targetTop = Math.min(rect.bottom + 10, window.innerHeight - estimatedCalendarHeight - 10);
                console.log('📐 Positioning below with viewport adjustment');
            }
            
            // Step 2: Open Flatpickr
            if (fpInstance && fpInstance.open) {
                fpInstance.open();
                
                // Step 3: Immediately position and show (no delay)
                // Use requestAnimationFrame for immediate positioning
                requestAnimationFrame(() => {
                    const calendars = document.querySelectorAll('.flatpickr-calendar');
                    
                    // Find the most recent calendar
                    const calendar = calendars[calendars.length - 1];
                    
                    if (calendar) {
                        // Force position immediately
                        calendar.style.position = 'fixed';
                        calendar.style.left = targetLeft + 'px';
                        calendar.style.top = targetTop + 'px';
                        calendar.style.zIndex = '1001';
                        calendar.style.visibility = 'visible';
                    }
                });
            } else {
                console.error('Cannot open Flatpickr - no valid instance or open method');
                dropdown.remove();
                return;
            }

            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== dateElement) {
                    // Also close any open Flatpickr calendars
                    const calendars = document.querySelectorAll('.flatpickr-calendar');
                    calendars.forEach(cal => cal.remove());
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                    window.removeEventListener('scroll', closeOnScroll);
                }
            };

            // Close dropdown when scrolling
            const closeOnScroll = () => {
                // Close any open Flatpickr calendars
                const calendars = document.querySelectorAll('.flatpickr-calendar');
                calendars.forEach(cal => cal.remove());
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
                window.removeEventListener('scroll', closeOnScroll);
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
                window.addEventListener('scroll', closeOnScroll);
            }, 100);
        }

        function showDatePicker(orderId, currentDate, currentTime) {
            // Ensure settings are loaded before opening picker
            if (!adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('Settings not loaded yet, loading settings first...');
                adminPanel.loadSettings().then(() => {
                    showDatePicker(orderId, currentDate, currentTime);
                });
                return;
            }
            
            // Remove any existing date picker
            const existingPicker = document.querySelector('.date-picker-overlay');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            // Format current date/time for display (convert from database format to display format)
            let defaultDateTimeValue = '';
            if (currentDate) {
                defaultDateTimeValue = currentDate;
                if (currentTime) {
                    defaultDateTimeValue += ' ' + currentTime;
                }
                // Convert from database format (YYYY-MM-DD HH:MM) to display format (n/j/Y h:i K)
                const dateTime = new Date(defaultDateTimeValue);
                if (!isNaN(dateTime.getTime())) {
                    const month = dateTime.getMonth() + 1; // 0-based to 1-based
                    const day = dateTime.getDate();
                    const year = dateTime.getFullYear();
                    const hours = dateTime.getHours();
                    const minutes = dateTime.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours % 12 || 12; // Convert to 12-hour format
                    const displayMinutes = minutes.toString().padStart(2, '0');
                    defaultDateTimeValue = `${month}/${day}/${year} ${displayHours}:${displayMinutes} ${ampm}`;
                }
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'date-picker-overlay';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'date-picker-modal';
            
            modal.innerHTML = `
                <div class="date-picker-header">
                    <h3>Set Pickup Date & Time</h3>
                    <button onclick="closeDatePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="pickup-datetime-input">Pickup Date & Time:</label>
                    <input type="text" id="pickup-datetime-input" placeholder="Select date and time" value="${defaultDateTimeValue}" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div class="date-picker-actions">
                    <button class="btn btn-secondary" onclick="closeDatePicker()">Cancel</button>
                    <button class="btn btn-primary" onclick="savePickupDateTime(${orderId})">Save</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Apply pickup settings restrictions with a small delay to ensure DOM is ready
            setTimeout(() => {
                applyPickupRestrictions();
            }, 100);

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDatePicker();
                }
            });
        }

        function closeDatePicker() {
            const picker = document.querySelector('.date-picker-overlay');
            if (picker) {
                picker.remove();
            }
        }

        function savePickupDateTime(orderId) {
            const datetimeInput = document.getElementById('pickup-datetime-input');
            const datetimeValue = datetimeInput.value;
            
            if (datetimeValue) {
                // Parse the datetime value to extract date and time
                const dateTime = new Date(datetimeValue);
                const newDate = dateTime.toISOString().split('T')[0]; // YYYY-MM-DD format
                const newTime = dateTime.toTimeString().split(' ')[0].substring(0, 5); // HH:MM format
                
                // Update both date and time
                adminPanel.updateOrderPickupDateTime(orderId, newDate, newTime);
            } else {
                // Clear the pickup date/time
                adminPanel.updateOrderPickupDateTime(orderId, null, null);
            }
            
            closeDatePicker();
        }

        function applyPickupRestrictions() {
            console.log('=== APPLYING FLATPICKR RESTRICTIONS ===');
            
            if (!adminPanel || !adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('No pickup settings available, skipping restrictions');
                return;
            }
            
            const pickupSettings = adminPanel.settings.pickup_settings;
            const datetimeInput = document.getElementById('pickup-datetime-input');
            
            console.log('Pickup settings:', pickupSettings);
            console.log('Datetime input found:', !!datetimeInput);
            
            if (!datetimeInput) {
                console.log('Datetime input not found');
                return;
            }
            
            // Build disabled days array (flatpickr uses 0=Sunday, 1=Monday, etc.)
            const disabledDays = [];
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            dayNames.forEach((dayName, index) => {
                if (!pickupSettings.pickup_days[dayName]) {
                    disabledDays.push(index);
                }
            });
            
            console.log('Pickup days settings:', pickupSettings.pickup_days);
            console.log('Disabled days array:', disabledDays);
            console.log('Day names mapping:', dayNames);
            
            // Initialize flatpickr with restrictions
            const fpInstance = flatpickr(datetimeInput, {
                enableTime: true,
                dateFormat: "n/j/Y h:i K", // Format: 9/30/25 3:15 PM
                time_24hr: false,
                minuteIncrement: parseInt(pickupSettings.time_increment),
                minTime: pickupSettings.pickup_start_time,
                maxTime: pickupSettings.pickup_end_time,
                disable: [
                    function(date) {
                        // Disable specific days of the week
                        const dayOfWeek = date.getDay();
                        if (disabledDays.includes(dayOfWeek)) {
                            return true;
                        }
                        
                        // Disable unavailable dates
                        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                        if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                            return true;
                        }
                        
                        return false;
                    }
                ],
                defaultDate: datetimeInput.value || null,
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('Flatpickr date changed:', dateStr);
                }
            });
            
            // Store the instance for dynamic updates
            adminPanel.flatpickrInstances.push(fpInstance);
            
            console.log('=== FLATPICKR RESTRICTIONS APPLIED ===');
        }

        function applyPickupRestrictionsToEditModal() {
            console.log('=== APPLYING FLATPICKR RESTRICTIONS TO EDIT MODAL ===');
            
            if (!adminPanel || !adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('No pickup settings available for edit modal, skipping restrictions');
                return;
            }
            
            const pickupSettings = adminPanel.settings.pickup_settings;
            const datetimeInput = document.getElementById('pickup-datetime');
            
            console.log('Edit modal - Pickup settings:', pickupSettings);
            console.log('Edit modal - Datetime input found:', !!datetimeInput);
            
            if (!datetimeInput) {
                console.log('Edit modal - Datetime input not found');
                return;
            }
            
            // Build disabled days array (flatpickr uses 0=Sunday, 1=Monday, etc.)
            const disabledDays = [];
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            dayNames.forEach((dayName, index) => {
                if (!pickupSettings.pickup_days[dayName]) {
                    disabledDays.push(index);
                }
            });
            
            console.log('Edit modal - Pickup days settings:', pickupSettings.pickup_days);
            console.log('Edit modal - Disabled days array:', disabledDays);
            console.log('Edit modal - Day names mapping:', dayNames);
            
            // Initialize flatpickr with restrictions
            const fpInstance = flatpickr(datetimeInput, {
                enableTime: true,
                dateFormat: "n/j/Y h:i K", // Format: 9/30/25 3:15 PM
                time_24hr: false,
                minuteIncrement: parseInt(pickupSettings.time_increment),
                minTime: pickupSettings.pickup_start_time,
                maxTime: pickupSettings.pickup_end_time,
                disable: [
                    function(date) {
                        // Disable specific days of the week
                        const dayOfWeek = date.getDay();
                        if (disabledDays.includes(dayOfWeek)) {
                            return true;
                        }
                        
                        // Disable unavailable dates
                        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                        if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                            return true;
                        }
                        
                        return false;
                    }
                ],
                defaultDate: datetimeInput.value || null,
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('Edit modal - Flatpickr date changed:', dateStr);
                }
            });
            
            // Store the instance for dynamic updates
            adminPanel.flatpickrInstances.push(fpInstance);
            
            console.log('=== EDIT MODAL FLATPICKR RESTRICTIONS APPLIED ===');
        }
        
        // Unavailable Dates Functions
        function openUnavailableDatesModal() {
            const modal = document.getElementById('unavailable-dates-modal');
            if (!modal) {
                console.error('Unavailable dates modal not found');
                return;
            }
            modal.style.display = 'flex';
            
            // Initialize flatpickr for date selection (date only, no time)
            const dateInput = document.getElementById('unavailable-date-input');
            if (dateInput && !dateInput._flatpickr) {
                flatpickr(dateInput, {
                    enableTime: false,
                    dateFormat: "Y-m-d", // Store in YYYY-MM-DD format
                    minDate: "today", // Can't select past dates
                    onChange: function(selectedDates, dateStr, instance) {
                        // Auto-close modal and add date when selected
                        if (dateStr) {
                            addUnavailableDateFromString(dateStr);
                            closeUnavailableDatesModal();
                        }
                    }
                });
            }
        }
        
        function closeUnavailableDatesModal() {
            const modal = document.getElementById('unavailable-dates-modal');
            if (!modal) {
                console.error('Unavailable dates modal not found');
                return;
            }
            modal.style.display = 'none';
            
            // Clear the input
            const dateInput = document.getElementById('unavailable-date-input');
            if (dateInput) {
                dateInput.value = '';
            }
        }
        
        function addUnavailableDate() {
            const dateInput = document.getElementById('unavailable-date-input');
            const dateStr = dateInput.value;
            if (dateStr) {
                addUnavailableDateFromString(dateStr);
                closeUnavailableDatesModal();
            }
        }
        
        function addUnavailableDateFromString(dateStr) {
            // Add to settings if not already present
            if (!adminPanel.settings.pickup_settings.unavailable_dates) {
                adminPanel.settings.pickup_settings.unavailable_dates = [];
            }
            
            if (!adminPanel.settings.pickup_settings.unavailable_dates.includes(dateStr)) {
                adminPanel.settings.pickup_settings.unavailable_dates.push(dateStr);
                updateUnavailableDatesDisplay();
            }
        }
        
        function removeUnavailableDate(dateStr) {
            if (adminPanel.settings.pickup_settings.unavailable_dates) {
                const index = adminPanel.settings.pickup_settings.unavailable_dates.indexOf(dateStr);
                if (index > -1) {
                    adminPanel.settings.pickup_settings.unavailable_dates.splice(index, 1);
                    updateUnavailableDatesDisplay();
                }
            }
        }
        
        function updateUnavailableDatesDisplay() {
            const container = document.getElementById('unavailable-dates-chips');
            if (!container) {
                console.log('Unavailable dates chips container not found');
                return;
            }
            
            container.innerHTML = '';
            
            if (adminPanel.settings.pickup_settings.unavailable_dates) {
                adminPanel.settings.pickup_settings.unavailable_dates.forEach(dateStr => {
                    const chip = document.createElement('div');
                    chip.className = 'unavailable-date-chip';
                    
                    // Format date for display (convert YYYY-MM-DD to M/D/YY)
                    // Parse date string manually to avoid timezone issues
                    const [year, month, day] = dateStr.split('-');
                    const displayDate = `${parseInt(month)}/${parseInt(day)}/${year.slice(-2)}`;
                    
                    chip.innerHTML = `
                        ${displayDate}
                        <button class="remove-btn" onclick="removeUnavailableDate('${dateStr}')" title="Remove date">&times;</button>
                    `;
                    
                    container.appendChild(chip);
                });
            }
        }
    </script>
    
    <!-- Unavailable Dates Modal -->
    <div id="unavailable-dates-modal" class="date-picker-overlay" style="display: none;">
        <div class="date-picker-modal">
            <div class="date-picker-header">
                <h3>Select Unavailable Date</h3>
                <button onclick="closeUnavailableDatesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="margin-bottom: 16px;">
                <label for="unavailable-date-input">Select Date:</label>
                <input type="text" id="unavailable-date-input" placeholder="Select date" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            <div class="date-picker-actions">
                <button class="btn btn-secondary" onclick="closeUnavailableDatesModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- View Order Modal -->
    <div id="view-order-modal" class="modal" style="display: none;">
        <div class="modal-content view-modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 id="view-modal-title">Order Details - #123</h2>
                    <div id="order-navigation" class="order-navigation" style="display: none;">
                        <button id="prev-order-btn" class="btn btn-sm btn-secondary" title="Previous Order">‹‹</button>
                        <span id="order-position" class="order-position">1 of 1</span>
                        <button id="next-order-btn" class="btn btn-sm btn-secondary" title="Next Order">››</button>
                    </div>
                </div>
                <span class="close" onclick="closeViewOrderModal()">&times;</span>
            </div>
            <div class="view-modal-body">
                <div class="view-modal-left">
                        <div class="file-preview-container">
                            <!-- PDF Controls (hidden by default) -->
                            <div id="pdf-controls" class="pdf-controls" style="display: none;">
                                <div class="pdf-controls-row">
                                    <div class="pdf-controls-left">
                                        <button id="prev-page-btn" class="btn btn-sm btn-secondary" title="Previous Page">‹</button>
                                        <span id="page-info" class="page-info">Page 1 of 1</span>
                                        <button id="next-page-btn" class="btn btn-sm btn-secondary" title="Next Page">›</button>
                                    </div>
                                    <div class="pdf-controls-right">
                                        <button id="zoom-out-btn" class="btn btn-sm btn-secondary" title="Zoom Out">-</button>
                                        <span id="zoom-level" class="zoom-level">100%</span>
                                        <button id="zoom-in-btn" class="btn btn-sm btn-secondary" title="Zoom In">+</button>
                                        <button id="fit-width-btn" class="btn btn-sm btn-secondary" title="Fit to Width">Fit Width</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="file-preview" class="file-preview">
                                <div class="preview-placeholder">
                                    <div class="preview-icon">📄</div>
                                    <p>File preview will appear here</p>
                                </div>
                            </div>
                            
                            <div class="preview-controls">
                                <button id="download-file-btn" class="btn btn-primary" style="display: none;">
                                    📥 Download File
                                </button>
                            </div>
                        </div>
                </div>
                <div class="view-modal-right">
                    <div class="order-details">
                        <div class="detail-section">
                            <h3>Customer Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Name:</span>
                                <span id="view-customer-name" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span id="view-customer-phone" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span id="view-customer-email" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Address:</span>
                                <span id="view-customer-address" class="detail-value"></span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Order Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Order #:</span>
                                <span id="view-order-number" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span id="view-status" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Copies:</span>
                                <span id="view-copies" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Pickup Date:</span>
                                <span id="view-pickup-date" class="detail-value"></span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Print Specifications</h3>
                            <div class="detail-row">
                                <span class="detail-label">Paper Size:</span>
                                <span id="view-paper-size" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Paper Type:</span>
                                <span id="view-paper-type" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Color Mode:</span>
                                <span id="view-color-mode" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Double Sided:</span>
                                <span id="view-double-sided" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Print Ready:</span>
                                <span id="view-print-ready" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Binding:</span>
                                <span id="view-binding" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Finishing:</span>
                                <span id="view-finishing" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Rush Order:</span>
                                <span id="view-rush-order" class="detail-value"></span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Additional Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Description:</span>
                                <span id="view-description" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Special Instructions:</span>
                                <span id="view-special-instructions" class="detail-value"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span id="view-notes" class="detail-value"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close" onclick="closeDeleteConfirmationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this order?</p>
                <p><strong>This action cannot be undone.</strong></p>
                <div id="delete-order-details" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <!-- Order details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteConfirmationModal()">Cancel</button>
                <button class="btn btn-danger-mauve" onclick="confirmDeleteOrder()">Delete Order</button>
            </div>
        </div>
    </div>

    <!-- Option Delete Confirmation Modal -->
    <div id="delete-option-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete Option</h3>
                <span class="close" onclick="closeDeleteOptionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-option-message">Are you sure you want to delete this option?</p>
                <p><strong>This will also delete all related combinations and cannot be undone.</strong></p>
                <div id="delete-option-details" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <!-- Option details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteOptionModal()">Cancel</button>
                <button class="btn btn-danger-mauve" onclick="confirmDeleteOption()">Delete Option</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</body>
</html>
