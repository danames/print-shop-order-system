<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pioneer Party - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #2d2d2d;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            height: 40px;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background-color: #444;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-tab.active {
            background-color: #10B981;
        }

        .nav-tab:hover {
            background-color: #555;
        }

        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #10B981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4B5563;
        }

        .btn-danger {
            background-color: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #DC2626;
        }

        .btn-full {
            width: 100%;
        }

        .orders-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .orders-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .orders-table tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-received { background-color: #DBEAFE; color: #1E40AF; }
        .status-paid { background-color: #D1FAE5; color: #065F46; }
        .status-in_progress { background-color: #FEF3C7; color: #92400E; }
        .status-ready_for_pickup { background-color: #FEF3C7; color: #92400E; }
        .status-picked_up { background-color: #F3F4F6; color: #374151; }
        .status-abandoned { background-color: #F3F4F6; color: #374151; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #10B981;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-picker input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Advanced Filter Styles */
        .filter-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .filter-header h3 {
            margin: 0;
            color: #333;
        }

        .filter-content {
            padding: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .filter-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .status-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .checkbox-label:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .quick-filters {
            margin-bottom: 20px;
        }

        .quick-filters h4 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .quick-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-filter-buttons .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .active-filters {
            padding: 15px 20px;
            background-color: #e3f2fd;
            border-top: 1px solid #bbdefb;
        }

        .active-filters h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            background-color: #1976d2;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .filter-chip .remove:hover {
            opacity: 1;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
        }

        /* Inline editing styles */
        .clickable-status {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .clickable-date {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 4px;
        }

        .clickable-date:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .status-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
            padding: 8px 0;
        }

        .status-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:hover {
            background-color: #f3f4f6;
        }

        .status-option .status-badge {
            margin: 0;
            font-size: 11px;
        }

        .date-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-picker-modal {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-picker-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Form -->
        <div id="login-form" class="login-form">
            <h2>Admin Login</h2>
            <form id="login">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Login</button>
            </form>
            <div id="login-error" class="alert alert-error" style="display: none;"></div>
        </div>

        <!-- Main App -->
        <div id="main-app" style="display: none;">
            <div class="header">
                <img src="/logo.svg" alt="Pioneer Party" class="logo">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="orders">Orders</button>
                    <button class="nav-tab" data-tab="settings">Settings</button>
                    <button class="nav-tab" data-tab="export">Export</button>
                    <button class="nav-tab" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="active-orders">0</div>
                            <div class="stat-label">Active Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ready-orders">0</div>
                            <div class="stat-label">Ready for Pickup</div>
                        </div>
                    </div>

                    <!-- Advanced Filter Panel -->
                    <div class="filter-panel">
                        <div class="filter-header">
                            <h3>Advanced Filters</h3>
                            <button class="btn btn-secondary" onclick="toggleFilterPanel()" id="filter-toggle">
                                <span id="filter-toggle-text">Show Filters</span>
                            </button>
                        </div>
                        
                        <div class="filter-content" id="filter-content" style="display: none;">
                            <div class="filter-grid">
                                <!-- Date Range Filters -->
                                <div class="filter-section">
                                    <h4>Date Range</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Created Date From:</label>
                                            <input type="date" id="filter-created-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Created Date To:</label>
                                            <input type="date" id="filter-created-to">
                                        </div>
                                    </div>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Pickup Date From:</label>
                                            <input type="date" id="filter-pickup-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Pickup Date To:</label>
                                            <input type="date" id="filter-pickup-to">
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Filters -->
                                <div class="filter-section">
                                    <h4>Status</h4>
                                    <div class="status-filters">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-received" value="received">
                                            <span class="status-badge status-received">Received</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-paid" value="paid">
                                            <span class="status-badge status-paid">Paid</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-in_progress" value="in_progress">
                                            <span class="status-badge status-in_progress">In Progress</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-ready_for_pickup" value="ready_for_pickup">
                                            <span class="status-badge status-ready_for_pickup">Ready for Pickup</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-picked_up" value="picked_up">
                                            <span class="status-badge status-picked_up">Picked Up</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-abandoned" value="abandoned">
                                            <span class="status-badge status-abandoned">Abandoned</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Customer Filters -->
                                <div class="filter-section">
                                    <h4>Customer</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Customer Name:</label>
                                            <input type="text" id="filter-customer-name" placeholder="Search by name...">
                                        </div>
                                        <div class="filter-group">
                                            <label>Phone:</label>
                                            <input type="text" id="filter-phone" placeholder="Search by phone...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Email:</label>
                                        <input type="text" id="filter-email" placeholder="Search by email...">
                                    </div>
                                </div>

                                <!-- Order Details -->
                                <div class="filter-section">
                                    <h4>Order Details</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Order Number From:</label>
                                            <input type="number" id="filter-order-from" placeholder="e.g., 1000">
                                        </div>
                                        <div class="filter-group">
                                            <label>Order Number To:</label>
                                            <input type="number" id="filter-order-to" placeholder="e.g., 2000">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Description/Notes:</label>
                                        <input type="text" id="filter-description" placeholder="Search in description or notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filters -->
                            <div class="quick-filters">
                                <h4>Quick Filters</h4>
                                <div class="quick-filter-buttons">
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('active')">Active Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('today')">Today's Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisWeek')">This Week</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisMonth')">This Month</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('ready')">Ready for Pickup</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('overdue')">Overdue</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('abandoned')">Abandoned</button>
                                </div>
                            </div>

                            <!-- Filter Actions -->
                            <div class="filter-actions">
                                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                                <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                                <button class="btn btn-secondary" onclick="saveFilterPreset()">Save Preset</button>
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div class="active-filters" id="active-filters" style="display: none;">
                            <h4>Active Filters:</h4>
                            <div class="filter-chips" id="filter-chips"></div>
                        </div>
                    </div>

                    <!-- Simple Search Bar (kept for backward compatibility) -->
                    <div class="search-bar">
                        <input type="text" id="search-orders" placeholder="Quick search by number, name, or phone...">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openOrderModal()">Add New Order</button>
                    </div>

                    <div id="orders-container">
                        <div class="loading">Loading orders...</div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Display Settings</h3>
                            <div class="form-group">
                                <label for="display-mode">Display Mode:</label>
                                <select id="display-mode" class="form-control">
                                    <option value="dark">Dark Mode</option>
                                    <option value="light">Light Mode</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rotation-seconds">Page Rotation (seconds):</label>
                                <input type="number" id="rotation-seconds" min="5" max="60" value="10">
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Status Colors</h3>
                            <div class="color-picker">
                                <label>Received:</label>
                                <input type="color" id="color-received" value="#3B82F6">
                            </div>
                            <div class="color-picker">
                                <label>Paid:</label>
                                <input type="color" id="color-paid" value="#10B981">
                            </div>
                            <div class="color-picker">
                                <label>In Progress:</label>
                                <input type="color" id="color-in_progress" value="#F59E0B">
                            </div>
                            <div class="color-picker">
                                <label>Ready for Pickup:</label>
                                <input type="color" id="color-ready_for_pickup" value="#FCD34D">
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="export-tab" class="tab-content">
                    <div class="settings-section">
                        <h3>Export Orders</h3>
                        <p>Export all orders to a CSV file for backup or analysis.</p>
                        <button class="btn btn-primary" onclick="exportOrders()">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Modal -->
        <div id="order-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Add New Order</h2>
                    <span class="close" onclick="closeOrderModal()">&times;</span>
                </div>
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-first-name">First Name:</label>
                            <input type="text" id="customer-first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-last-name">Last Name:</label>
                            <input type="text" id="customer-last-name" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-phone">Phone:</label>
                            <input type="tel" id="customer-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-email">Email:</label>
                            <input type="email" id="customer-email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customer-address">Address:</label>
                        <input type="text" id="customer-address" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pickup-date">Pickup Date:</label>
                            <input type="date" id="pickup-date" required>
                        </div>
                        <div class="form-group">
                            <label for="pickup-time">Pickup Time:</label>
                            <input type="time" id="pickup-time">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status">
                                <option value="received">Received</option>
                                <option value="paid">Paid</option>
                                <option value="in_progress">In Progress</option>
                                <option value="ready_for_pickup">Ready for Pickup</option>
                                <option value="picked_up">Picked Up</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="copies">Copies:</label>
                            <input type="number" id="copies" min="1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="order-description">Order Description:</label>
                        <textarea id="order-description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="special-instructions">Special Instructions:</label>
                        <textarea id="special-instructions" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" rows="2"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        class AdminPanel {
            constructor() {
                this.orders = [];
                this.filteredOrders = [];
                this.settings = {};
                this.currentUser = null;
                this.socket = null;
                this.activeFilters = {};
                
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
            }

            checkAuth() {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    this.verifyToken(token);
                } else {
                    this.showLogin();
                }
            }

            async verifyToken(token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        this.showLogin();
                    }
                } catch (error) {
                    console.error('Token verification failed:', error);
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }

            showMainApp() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                this.setupSocket();
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Order form
                document.getElementById('order-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveOrder();
                });

                // Search
                document.getElementById('search-orders').addEventListener('input', (e) => {
                    this.filterOrders(e.target.value);
                });
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('admin_token', data.token);
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        this.showError(data.message);
                    }
                } catch (error) {
                    console.error('Login failed:', error);
                    this.showError('Login failed. Please try again.');
                }
            }

            logout() {
                localStorage.removeItem('admin_token');
                this.currentUser = null;
                this.showLogin();
            }

            showError(message) {
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            switchTab(tabName) {
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load data for specific tabs
                if (tabName === 'settings') {
                    this.loadSettings();
                }
            }

            async loadData() {
                await Promise.all([
                    this.loadOrders(),
                    this.loadSettings()
                ]);
            }

            async loadOrders() {
                try {
                    // Load ALL orders including picked_up and abandoned for admin filtering
                    const response = await fetch('/api/orders?show_picked_up=true');
                    if (response.ok) {
                        this.orders = await response.json();
                        this.filteredOrders = [...this.orders];
                        this.displayOrders();
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Failed to load orders:', error);
                }
            }

            async loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (response.ok) {
                        this.settings = await response.json();
                        this.populateSettingsForm();
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }

            displayOrders() {
                const container = document.getElementById('orders-container');
                // Always use filteredOrders if filters are active, otherwise use all orders
                const ordersToDisplay = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                
                if (ordersToDisplay.length === 0) {
                    const message = Object.keys(this.activeFilters).length > 0 ? 
                        'No orders match your current filters' : 
                        'No orders found';
                    container.innerHTML = `<div class="loading">${message}</div>`;
                    return;
                }

                const ordersHTML = ordersToDisplay.map(order => `
                    <tr>
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td>
                            <span class="status-badge status-${order.status} clickable-status" 
                                  onclick="showStatusDropdown(${order.id}, '${order.status}')" 
                                  title="Click to change status">
                                ${this.formatStatusText(order.status)}
                            </span>
                        </td>
                        <td class="clickable-date" onclick="showDatePicker(${order.id}, '${order.pickup_date || ''}', '${order.pickup_time || ''}')" title="Click to change pickup date and time">
                            ${this.formatPickupDateTime(order.pickup_date, order.pickup_time)}
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editOrder(${order.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Pickup Date & Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
            }

            updateStats() {
                const ordersToCount = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                const totalOrders = ordersToCount.length;
                const activeOrders = ordersToCount.filter(o => !['picked_up', 'abandoned'].includes(o.status)).length;
                const readyOrders = ordersToCount.filter(o => o.status === 'ready_for_pickup').length;

                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('active-orders').textContent = activeOrders;
                document.getElementById('ready-orders').textContent = readyOrders;
            }

            filterOrders(searchTerm) {
                // Use the current filtered orders as base, or all orders if no advanced filters
                const baseOrders = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                
                const filtered = baseOrders.filter(order => 
                    order.order_number.toString().includes(searchTerm) ||
                    order.customer_first_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_last_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_phone.includes(searchTerm)
                );

                // Update display with filtered results
                const container = document.getElementById('orders-container');
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="loading">No orders match your search</div>';
                    return;
                }

                const ordersHTML = filtered.map(order => `
                    <tr>
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.replace('_', ' ')}</span></td>
                        <td>${order.pickup_date || 'TBD'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editOrder(${order.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Pickup Date & Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
            }

            populateSettingsForm() {
                document.getElementById('display-mode').value = this.settings.display_mode || 'dark';
                document.getElementById('rotation-seconds').value = this.settings.page_rotation_seconds || 10;
                
                if (this.settings.status_colors) {
                    document.getElementById('color-received').value = this.settings.status_colors.received || '#3B82F6';
                    document.getElementById('color-paid').value = this.settings.status_colors.paid || '#10B981';
                    document.getElementById('color-in_progress').value = this.settings.status_colors.in_progress || '#F59E0B';
                    document.getElementById('color-ready_for_pickup').value = this.settings.status_colors.ready_for_pickup || '#FCD34D';
                }
            }

            async saveSettings() {
                const settings = {
                    display_mode: document.getElementById('display-mode').value,
                    page_rotation_seconds: parseInt(document.getElementById('rotation-seconds').value),
                    status_colors: {
                        received: document.getElementById('color-received').value,
                        paid: document.getElementById('color-paid').value,
                        in_progress: document.getElementById('color-in_progress').value,
                        ready_for_pickup: document.getElementById('color-ready_for_pickup').value
                    }
                };

                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch('/api/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        this.showAlert('Settings saved successfully!', 'success');
                    } else {
                        this.showAlert('Failed to save settings', 'error');
                    }
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    this.showAlert('Failed to save settings', 'error');
                }
            }

            async exportOrders() {
                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch('/api/orders/export/csv', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        this.showAlert('Orders exported successfully!', 'success');
                    } else {
                        this.showAlert('Failed to export orders', 'error');
                    }
                } catch (error) {
                    console.error('Failed to export orders:', error);
                    this.showAlert('Failed to export orders', 'error');
                }
            }

            async saveOrder() {
                const orderId = document.getElementById('order-id').value;
                const isEdit = orderId !== '';
                
                const orderData = {
                    customer_first_name: document.getElementById('customer-first-name').value,
                    customer_last_name: document.getElementById('customer-last-name').value,
                    customer_phone: document.getElementById('customer-phone').value,
                    customer_email: document.getElementById('customer-email').value,
                    customer_address: document.getElementById('customer-address').value,
                    pickup_date: document.getElementById('pickup-date').value,
                    pickup_time: document.getElementById('pickup-time').value,
                    status: document.getElementById('status').value,
                    copies: parseInt(document.getElementById('copies').value),
                    order_description: document.getElementById('order-description').value,
                    special_instructions: document.getElementById('special-instructions').value,
                    notes: document.getElementById('notes').value
                };

                try {
                    const token = localStorage.getItem('admin_token');
                    const url = isEdit ? `/api/orders/${orderId}` : '/api/orders';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (response.ok) {
                        this.showAlert(isEdit ? 'Order updated successfully!' : 'Order created successfully!', 'success');
                        this.closeOrderModal();
                        this.loadOrders();
                    } else {
                        const errorData = await response.json();
                        this.showAlert(errorData.message || 'Failed to save order', 'error');
                    }
                } catch (error) {
                    console.error('Failed to save order:', error);
                    this.showAlert('Failed to save order', 'error');
                }
            }

            closeOrderModal() {
                document.getElementById('order-modal').style.display = 'none';
            }

            // Advanced Filtering Methods
            applyFilters() {
                this.activeFilters = this.getFilterValues();
                this.filteredOrders = this.applyAdvancedFilters(this.orders, this.activeFilters);
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            getFilterValues() {
                const filters = {};
                
                // Date filters
                const createdFrom = document.getElementById('filter-created-from').value;
                const createdTo = document.getElementById('filter-created-to').value;
                const pickupFrom = document.getElementById('filter-pickup-from').value;
                const pickupTo = document.getElementById('filter-pickup-to').value;
                
                if (createdFrom) filters.createdFrom = createdFrom;
                if (createdTo) filters.createdTo = createdTo;
                if (pickupFrom) filters.pickupFrom = pickupFrom;
                if (pickupTo) filters.pickupTo = pickupTo;
                
                // Status filters
                const statusFilters = [];
                document.querySelectorAll('.status-filters input[type="checkbox"]:checked').forEach(checkbox => {
                    statusFilters.push(checkbox.value);
                });
                if (statusFilters.length > 0) filters.statuses = statusFilters;
                
                // Customer filters
                const customerName = document.getElementById('filter-customer-name').value.trim();
                const phone = document.getElementById('filter-phone').value.trim();
                const email = document.getElementById('filter-email').value.trim();
                
                if (customerName) filters.customerName = customerName;
                if (phone) filters.phone = phone;
                if (email) filters.email = email;
                
                // Order details
                const orderFrom = document.getElementById('filter-order-from').value;
                const orderTo = document.getElementById('filter-order-to').value;
                const description = document.getElementById('filter-description').value.trim();
                
                if (orderFrom) filters.orderFrom = parseInt(orderFrom);
                if (orderTo) filters.orderTo = parseInt(orderTo);
                if (description) filters.description = description;
                
                return filters;
            }

            applyAdvancedFilters(orders, filters) {
                return orders.filter(order => {
                    // Date filters
                    if (filters.createdFrom && new Date(order.created_at) < new Date(filters.createdFrom)) {
                        return false;
                    }
                    if (filters.createdTo && new Date(order.created_at) > new Date(filters.createdTo + 'T23:59:59')) {
                        return false;
                    }
                    if (filters.pickupFrom && order.pickup_date && new Date(order.pickup_date) < new Date(filters.pickupFrom)) {
                        return false;
                    }
                    if (filters.pickupTo && order.pickup_date && new Date(order.pickup_date) > new Date(filters.pickupTo + 'T23:59:59')) {
                        return false;
                    }
                    
                    // Status filters
                    if (filters.statuses && filters.statuses.length > 0 && !filters.statuses.includes(order.status)) {
                        return false;
                    }
                    
                    // Customer filters
                    if (filters.customerName) {
                        const fullName = `${order.customer_first_name} ${order.customer_last_name}`.toLowerCase();
                        if (!fullName.includes(filters.customerName.toLowerCase())) {
                            return false;
                        }
                    }
                    if (filters.phone && !order.customer_phone.includes(filters.phone)) {
                        return false;
                    }
                    if (filters.email && !order.customer_email.toLowerCase().includes(filters.email.toLowerCase())) {
                        return false;
                    }
                    
                    // Order details
                    if (filters.orderFrom && order.order_number < filters.orderFrom) {
                        return false;
                    }
                    if (filters.orderTo && order.order_number > filters.orderTo) {
                        return false;
                    }
                    if (filters.description) {
                        const searchText = `${order.order_description || ''} ${order.notes || ''}`.toLowerCase();
                        if (!searchText.includes(filters.description.toLowerCase())) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            updateActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('active-filters');
                const filterChipsDiv = document.getElementById('filter-chips');
                
                if (Object.keys(this.activeFilters).length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                filterChipsDiv.innerHTML = '';
                
                Object.entries(this.activeFilters).forEach(([key, value]) => {
                    const chip = this.createFilterChip(key, value);
                    filterChipsDiv.appendChild(chip);
                });
            }

            createFilterChip(key, value) {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                
                let displayText = '';
                switch (key) {
                    case 'createdFrom':
                        displayText = `Created from: ${value}`;
                        break;
                    case 'createdTo':
                        displayText = `Created to: ${value}`;
                        break;
                    case 'pickupFrom':
                        displayText = `Pickup from: ${value}`;
                        break;
                    case 'pickupTo':
                        displayText = `Pickup to: ${value}`;
                        break;
                    case 'statuses':
                        // Check if this is the "Active" combination
                        if (value.length === 4 && 
                            value.includes('received') && value.includes('paid') && 
                            value.includes('in_progress') && value.includes('ready_for_pickup')) {
                            displayText = 'Active';
                        } else {
                            // Format individual status values
                            const formattedStatuses = value.map(status => this.formatStatusText(status));
                            displayText = `Status: ${formattedStatuses.join(', ')}`;
                        }
                        break;
                    case 'customerName':
                        displayText = `Customer: ${value}`;
                        break;
                    case 'phone':
                        displayText = `Phone: ${value}`;
                        break;
                    case 'email':
                        displayText = `Email: ${value}`;
                        break;
                    case 'orderFrom':
                        displayText = `Order from: ${value}`;
                        break;
                    case 'orderTo':
                        displayText = `Order to: ${value}`;
                        break;
                    case 'description':
                        displayText = `Description: ${value}`;
                        break;
                }
                
                chip.innerHTML = `
                    <span>${displayText}</span>
                    <span class="remove" onclick="removeFilter('${key}')">&times;</span>
                `;
                
                return chip;
            }

            formatStatusText(status) {
                const statusMap = {
                    'received': 'Received',
                    'paid': 'Paid', 
                    'in_progress': 'In Progress',
                    'ready_for_pickup': 'Ready for Pickup',
                    'picked_up': 'Picked Up',
                    'abandoned': 'Abandoned'
                };
                return statusMap[status] || status;
            }

            formatPickupDateTime(date, time) {
                if (!date) return 'TBD';
                
                try {
                    // Parse the date (assuming YYYY-MM-DD format)
                    const dateObj = new Date(date + 'T00:00:00');
                    
                    // Format date as M/D/YY
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const year = dateObj.getFullYear().toString().slice(-2);
                    const formattedDate = `${month}/${day}/${year}`;
                    
                    if (!time) {
                        return formattedDate;
                    }
                    
                    // Parse and format time (assuming HH:MM format)
                    const [hours, minutes] = time.split(':');
                    const hour24 = parseInt(hours);
                    const minute = parseInt(minutes);
                    
                    // Convert to 12-hour format
                    let hour12 = hour24;
                    let ampm = 'AM';
                    
                    if (hour24 === 0) {
                        hour12 = 12;
                    } else if (hour24 === 12) {
                        ampm = 'PM';
                    } else if (hour24 > 12) {
                        hour12 = hour24 - 12;
                        ampm = 'PM';
                    }
                    
                    const formattedTime = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;
                    
                    return `${formattedDate} ${formattedTime}`;
                } catch (error) {
                    console.error('Error formatting date/time:', error);
                    return date || 'TBD';
                }
            }

            clearAllFilters() {
                // Clear all filter inputs
                document.querySelectorAll('.filter-panel input').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                this.activeFilters = {};
                this.filteredOrders = [...this.orders];
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            applyQuickFilter(type) {
                this.clearAllFilters();
                
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                switch (type) {
                    case 'active':
                        // Check all statuses except picked_up and abandoned
                        document.getElementById('status-received').checked = true;
                        document.getElementById('status-paid').checked = true;
                        document.getElementById('status-in_progress').checked = true;
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'today':
                        document.getElementById('filter-created-from').value = startOfDay.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisWeek':
                        const startOfWeek = new Date(startOfDay);
                        startOfWeek.setDate(startOfDay.getDate() - startOfDay.getDay());
                        document.getElementById('filter-created-from').value = startOfWeek.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisMonth':
                        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                        document.getElementById('filter-created-from').value = startOfMonth.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'ready':
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'overdue':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('filter-pickup-to').value = yesterday.toISOString().split('T')[0];
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'abandoned':
                        document.getElementById('status-abandoned').checked = true;
                        break;
                }
                
                this.applyFilters();
            }

            // Inline editing methods
            async updateOrderStatus(orderId, newStatus) {
                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            this.orders[orderIndex].status = newStatus;
                        }
                        
                        // Update filtered orders if they exist
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            this.filteredOrders[filteredIndex].status = newStatus;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, status: newStatus });
                        }
                    } else {
                        console.error('Failed to update order status');
                        alert('Failed to update order status');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    alert('Error updating order status');
                }
            }

            async updateOrderPickupDateTime(orderId, newDate, newTime) {
                try {
                    const updateData = {};
                    if (newDate !== undefined) updateData.pickup_date = newDate;
                    if (newTime !== undefined) updateData.pickup_time = newTime;
                    
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            if (newDate !== undefined) this.orders[orderIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.orders[orderIndex].pickup_time = newTime;
                        }
                        
                        // Update filtered orders if they exist
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            if (newDate !== undefined) this.filteredOrders[filteredIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.filteredOrders[filteredIndex].pickup_time = newTime;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, ...updateData });
                        }
                    } else {
                        console.error('Failed to update pickup date/time');
                        alert('Failed to update pickup date/time');
                    }
                } catch (error) {
                    console.error('Error updating pickup date/time:', error);
                    alert('Error updating pickup date/time');
                }
            }

            setupSocket() {
                this.socket = io();
                
                this.socket.on('order_created', () => {
                    this.loadOrders();
                });

                this.socket.on('order_updated', () => {
                    this.loadOrders();
                });

                this.socket.on('order_deleted', () => {
                    this.loadOrders();
                });
            }

            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                
                const mainContent = document.querySelector('.main-content');
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        // Global functions for order management
        function openOrderModal(orderId = null) {
            const modal = document.getElementById('order-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('order-form');
            
            if (orderId) {
                title.textContent = 'Edit Order';
                // Load order data
                const order = adminPanel.orders.find(o => o.id === orderId);
                if (order) {
                    document.getElementById('order-id').value = order.id;
                    document.getElementById('customer-first-name').value = order.customer_first_name;
                    document.getElementById('customer-last-name').value = order.customer_last_name;
                    document.getElementById('customer-phone').value = order.customer_phone;
                    document.getElementById('customer-email').value = order.customer_email;
                    document.getElementById('customer-address').value = order.customer_address;
                    document.getElementById('pickup-date').value = order.pickup_date || '';
                    document.getElementById('pickup-time').value = order.pickup_time || '';
                    document.getElementById('status').value = order.status;
                    document.getElementById('copies').value = order.copies || 1;
                    document.getElementById('order-description').value = order.order_description || '';
                    document.getElementById('special-instructions').value = order.special_instructions || '';
                    document.getElementById('notes').value = order.notes || '';
                }
            } else {
                title.textContent = 'Add New Order';
                form.reset();
                document.getElementById('order-id').value = '';
            }
            
            modal.style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function editOrder(orderId) {
            openOrderModal(orderId);
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) {
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    adminPanel.loadOrders();
                    adminPanel.showAlert('Order deleted successfully!', 'success');
                } else {
                    adminPanel.showAlert('Failed to delete order', 'error');
                }
            } catch (error) {
                console.error('Failed to delete order:', error);
                adminPanel.showAlert('Failed to delete order', 'error');
            }
        }

        function logout() {
            adminPanel.logout();
        }

        function saveSettings() {
            adminPanel.saveSettings();
        }

        function exportOrders() {
            adminPanel.exportOrders();
        }

        // Advanced Filter Functions
        function toggleFilterPanel() {
            const content = document.getElementById('filter-content');
            const toggleText = document.getElementById('filter-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'Hide Filters';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'Show Filters';
            }
        }

        function applyFilters() {
            adminPanel.applyFilters();
        }

        function clearAllFilters() {
            adminPanel.clearAllFilters();
        }

        function applyQuickFilter(type) {
            adminPanel.applyQuickFilter(type);
        }

        function removeFilter(key) {
            // Clear the specific filter
            switch (key) {
                case 'createdFrom':
                    document.getElementById('filter-created-from').value = '';
                    break;
                case 'createdTo':
                    document.getElementById('filter-created-to').value = '';
                    break;
                case 'pickupFrom':
                    document.getElementById('filter-pickup-from').value = '';
                    break;
                case 'pickupTo':
                    document.getElementById('filter-pickup-to').value = '';
                    break;
                case 'statuses':
                    document.querySelectorAll('.status-filters input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    break;
                case 'customerName':
                    document.getElementById('filter-customer-name').value = '';
                    break;
                case 'phone':
                    document.getElementById('filter-phone').value = '';
                    break;
                case 'email':
                    document.getElementById('filter-email').value = '';
                    break;
                case 'orderFrom':
                    document.getElementById('filter-order-from').value = '';
                    break;
                case 'orderTo':
                    document.getElementById('filter-order-to').value = '';
                    break;
                case 'description':
                    document.getElementById('filter-description').value = '';
                    break;
            }
            
            // Reapply filters
            adminPanel.applyFilters();
        }

        function saveFilterPreset() {
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName) {
                const filters = adminPanel.getFilterValues();
                localStorage.setItem(`filter_preset_${presetName}`, JSON.stringify(filters));
                adminPanel.showAlert(`Filter preset "${presetName}" saved!`, 'success');
            }
        }

        // Initialize the admin panel
        let adminPanel;
        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('order-modal');
            if (event.target === modal) {
                closeOrderModal();
            }
        }

        // Global functions for inline editing
        function showStatusDropdown(orderId, currentStatus) {
            // Remove any existing dropdowns
            const existingDropdown = document.querySelector('.status-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }

            const statusOptions = [
                { value: 'received', label: 'Received' },
                { value: 'paid', label: 'Paid' },
                { value: 'in_progress', label: 'In Progress' },
                { value: 'ready_for_pickup', label: 'Ready for Pickup' },
                { value: 'picked_up', label: 'Picked Up' },
                { value: 'abandoned', label: 'Abandoned' }
            ];

            // Find the clicked status element
            const statusElement = event.target;
            const rect = statusElement.getBoundingClientRect();
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'status-dropdown';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 5) + 'px';

            // Add status options
            statusOptions.forEach(status => {
                const option = document.createElement('div');
                option.className = 'status-option';
                option.innerHTML = `
                    <span class="status-badge status-${status.value}">${status.label}</span>
                `;
                
                if (status.value === currentStatus) {
                    option.style.backgroundColor = '#e5e7eb';
                }
                
                option.addEventListener('click', () => {
                    adminPanel.updateOrderStatus(orderId, status.value);
                    dropdown.remove();
                });
                
                dropdown.appendChild(option);
            });

            document.body.appendChild(dropdown);

            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== statusElement) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 100);
        }

        function showDatePicker(orderId, currentDate, currentTime) {
            // Remove any existing date picker
            const existingPicker = document.querySelector('.date-picker-overlay');
            if (existingPicker) {
                existingPicker.remove();
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'date-picker-overlay';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'date-picker-modal';
            
            modal.innerHTML = `
                <div class="date-picker-header">
                    <h3>Set Pickup Date & Time</h3>
                    <button onclick="closeDatePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="pickup-date-input">Pickup Date:</label>
                    <input type="date" id="pickup-date-input" value="${currentDate}" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="pickup-time-input">Pickup Time (optional):</label>
                    <input type="time" id="pickup-time-input" value="${currentTime || ''}" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div class="date-picker-actions">
                    <button class="btn btn-secondary" onclick="closeDatePicker()">Cancel</button>
                    <button class="btn btn-primary" onclick="savePickupDateTime(${orderId})">Save</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDatePicker();
                }
            });
        }

        function closeDatePicker() {
            const picker = document.querySelector('.date-picker-overlay');
            if (picker) {
                picker.remove();
            }
        }

        function savePickupDateTime(orderId) {
            const dateInput = document.getElementById('pickup-date-input');
            const timeInput = document.getElementById('pickup-time-input');
            const newDate = dateInput.value;
            const newTime = timeInput.value;
            
            // Update both date and time
            adminPanel.updateOrderPickupDateTime(orderId, newDate || null, newTime || null);
            
            closeDatePicker();
        }
    </script>
</body>
</html>
