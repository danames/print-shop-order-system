<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pioneer Party - Admin Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #2d2d2d;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            height: 40px;
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
        }

        .nav-tab {
            padding: 10px 20px;
            background-color: #444;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-tab.active {
            background-color: #10B981;
        }

        .nav-tab:hover {
            background-color: #555;
        }

        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #10B981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4B5563;
        }

        .btn-danger {
            background-color: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #DC2626;
        }

        .btn-full {
            width: 100%;
        }

        .orders-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .orders-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .orders-table tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-received { background-color: #DBEAFE; color: #1E40AF; }
        .status-paid { background-color: #D1FAE5; color: #065F46; }
        .status-in_progress { background-color: #FEF3C7; color: #92400E; }
        .status-ready_for_pickup { background-color: #FEF3C7; color: #92400E; }
        .status-picked_up { background-color: #F3F4F6; color: #374151; }
        .status-abandoned { background-color: #F3F4F6; color: #374151; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #10B981;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Options & Prices Styles */
        .options-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .options-section h4 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #10B981;
            padding-bottom: 5px;
        }

        .options-list {
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
        }

        .option-item input {
            margin-right: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .option-item .option-name {
            min-width: 120px;
        }

        .option-item .option-display {
            min-width: 300px;
            flex: 1;
        }

        .option-item .option-sort {
            min-width: 80px;
        }

        .add-option {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .add-option input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 150px;
        }

        .add-option input[placeholder*="Display Name"] {
            min-width: 300px;
            flex: 1;
        }

        .combinations-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .combinations-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .combinations-table th {
            background: #10B981;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .combinations-table td {
            padding: 12px;
            border-bottom: 1px solid #e1e5e9;
        }

        .combinations-table tr:hover {
            background: #f8f9fa;
        }

        .combinations-table tr.unavailable {
            background: #f5f5f5;
            color: #666;
        }

        .combinations-table tr.unavailable input {
            background: #f5f5f5;
            color: #666;
        }

        .combinations-table input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .combinations-table input[type="checkbox"] {
            transform: scale(1.2);
        }

        .availability-status {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .availability-status.available {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .availability-status.unavailable {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-picker input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Advanced Filter Styles */
        .filter-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .filter-header h3 {
            margin: 0;
            color: #333;
        }

        .filter-content {
            padding: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .filter-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .status-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .checkbox-label:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .quick-filters {
            margin-bottom: 20px;
        }

        .quick-filters h4 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .quick-filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-filter-buttons .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .active-filters {
            padding: 15px 20px;
            background-color: #e3f2fd;
            border-top: 1px solid #bbdefb;
        }

        .active-filters h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 14px;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            background-color: #1976d2;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .filter-chip .remove:hover {
            opacity: 1;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
        }

        /* Inline editing styles */
        .clickable-status {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clickable-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .clickable-date {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px;
            border-radius: 4px;
        }

        .clickable-date:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .status-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
            padding: 8px 0;
        }

        .status-option {
            padding: 8px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:hover {
            background-color: #f3f4f6;
        }

        .status-option .status-badge {
            margin: 0;
            font-size: 11px;
        }

        .date-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-picker-modal {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-picker-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Day selector styles */
        .day-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .day-box {
            position: relative;
            width: 40px;
            height: 40px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .day-box:hover {
            border-color: #3b82f6;
            background-color: #f3f4f6;
        }

        .day-box.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }

        .day-label {
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
        }

        .day-checkbox {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .day-checkbox:checked + .day-label {
            color: white;
        }

        .day-box:has(.day-checkbox:checked) {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        
        .unavailable-dates-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .unavailable-date-chip {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 16px;
            padding: 4px 8px 4px 12px;
            font-size: 14px;
            color: #374151;
        }
        
        .unavailable-date-chip .remove-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            margin-left: 6px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .unavailable-date-chip .remove-btn:hover {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Form -->
        <div id="login-form" class="login-form">
            <h2>Admin Login</h2>
            <form id="login">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Login</button>
            </form>
            <div id="login-error" class="alert alert-error" style="display: none;"></div>
        </div>

        <!-- Main App -->
        <div id="main-app" style="display: none;">
            <div class="header">
                <img src="/logo.svg" alt="Pioneer Party" class="logo">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-tab="orders">Orders</button>
                    <button class="nav-tab" data-tab="settings">Settings</button>
                    <button class="nav-tab" data-tab="options">Options & Prices</button>
                    <button class="nav-tab" data-tab="export">Export</button>
                    <button class="nav-tab" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders">0</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="active-orders">0</div>
                            <div class="stat-label">Active Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ready-orders">0</div>
                            <div class="stat-label">Ready for Pickup</div>
                        </div>
                    </div>

                    <!-- Advanced Filter Panel -->
                    <div class="filter-panel">
                        <div class="filter-header">
                            <h3>Advanced Filters</h3>
                            <button class="btn btn-secondary" onclick="toggleFilterPanel()" id="filter-toggle">
                                <span id="filter-toggle-text">Show Filters</span>
                            </button>
                        </div>
                        
                        <div class="filter-content" id="filter-content" style="display: none;">
                            <div class="filter-grid">
                                <!-- Date Range Filters -->
                                <div class="filter-section">
                                    <h4>Date Range</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Created Date From:</label>
                                            <input type="date" id="filter-created-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Created Date To:</label>
                                            <input type="date" id="filter-created-to">
                                        </div>
                                    </div>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Pickup Date From:</label>
                                            <input type="date" id="filter-pickup-from">
                                        </div>
                                        <div class="filter-group">
                                            <label>Pickup Date To:</label>
                                            <input type="date" id="filter-pickup-to">
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Filters -->
                                <div class="filter-section">
                                    <h4>Status</h4>
                                    <div class="status-filters">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-received" value="received">
                                            <span class="status-badge status-received">Received</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-paid" value="paid">
                                            <span class="status-badge status-paid">Paid</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-in_progress" value="in_progress">
                                            <span class="status-badge status-in_progress">In Progress</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-ready_for_pickup" value="ready_for_pickup">
                                            <span class="status-badge status-ready_for_pickup">Ready for Pickup</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-picked_up" value="picked_up">
                                            <span class="status-badge status-picked_up">Picked Up</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="status-abandoned" value="abandoned">
                                            <span class="status-badge status-abandoned">Abandoned</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Customer Filters -->
                                <div class="filter-section">
                                    <h4>Customer</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Customer Name:</label>
                                            <input type="text" id="filter-customer-name" placeholder="Search by name...">
                                        </div>
                                        <div class="filter-group">
                                            <label>Phone:</label>
                                            <input type="text" id="filter-phone" placeholder="Search by phone...">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Email:</label>
                                        <input type="text" id="filter-email" placeholder="Search by email...">
                                    </div>
                                </div>

                                <!-- Order Details -->
                                <div class="filter-section">
                                    <h4>Order Details</h4>
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label>Order Number From:</label>
                                            <input type="number" id="filter-order-from" placeholder="e.g., 1000">
                                        </div>
                                        <div class="filter-group">
                                            <label>Order Number To:</label>
                                            <input type="number" id="filter-order-to" placeholder="e.g., 2000">
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <label>Description/Notes:</label>
                                        <input type="text" id="filter-description" placeholder="Search in description or notes...">
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Filters -->
                            <div class="quick-filters">
                                <h4>Quick Filters</h4>
                                <div class="quick-filter-buttons">
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('active')">Active Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('today')">Today's Orders</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisWeek')">This Week</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('thisMonth')">This Month</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('ready')">Ready for Pickup</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('overdue')">Overdue</button>
                                    <button class="btn btn-secondary" onclick="applyQuickFilter('abandoned')">Abandoned</button>
                                </div>
                            </div>

                            <!-- Filter Actions -->
                            <div class="filter-actions">
                                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                                <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All</button>
                                <button class="btn btn-secondary" onclick="saveFilterPreset()">Save Preset</button>
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div class="active-filters" id="active-filters" style="display: none;">
                            <h4>Active Filters:</h4>
                            <div class="filter-chips" id="filter-chips"></div>
                        </div>
                    </div>

                    <!-- Simple Search Bar (kept for backward compatibility) -->
                    <div class="search-bar">
                        <input type="text" id="search-orders" placeholder="Quick search by number, name, or phone...">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openOrderModal()">Add New Order</button>
                    </div>

                    <div id="orders-container">
                        <div class="loading">Loading orders...</div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Display Settings</h3>
                            <div class="form-group">
                                <label for="display-mode">Display Mode:</label>
                                <select id="display-mode" class="form-control">
                                    <option value="dark">Dark Mode</option>
                                    <option value="light">Light Mode</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rotation-seconds">Page Rotation (seconds):</label>
                                <input type="number" id="rotation-seconds" min="5" max="60" value="10">
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Status Colors</h3>
                            <div class="color-picker">
                                <label>Received:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-received-bg" value="#3B82F6">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-received-text" value="#1E40AF">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>Paid:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-paid-bg" value="#10B981">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-paid-text" value="#065F46">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>In Progress:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-in_progress-bg" value="#F59E0B">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-in_progress-text" value="#92400E">
                                    </div>
                                </div>
                            </div>
                            <div class="color-picker">
                                <label>Ready for Pickup:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Background:</label>
                                        <input type="color" id="color-ready_for_pickup-bg" value="#FCD34D">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #666;">Text:</label>
                                        <input type="color" id="color-ready_for_pickup-text" value="#92400E">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button type="button" class="btn btn-secondary" onclick="resetToDefaultColors()">
                                    Reset to Default Colors
                                </button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Pickup Date & Time</h3>
                            <div class="form-group">
                                <label for="pickup-start-time">Pickup Start Time:</label>
                                <input type="text" id="pickup-start-time" placeholder="Select start time" value="9:00 AM">
                            </div>
                            <div class="form-group">
                                <label for="pickup-end-time">Pickup End Time:</label>
                                <input type="text" id="pickup-end-time" placeholder="Select end time" value="5:00 PM">
                            </div>
                            <div class="form-group">
                                <label>Available Pickup Days:</label>
                                <div class="day-selector">
                                    <div class="day-box" data-day="sunday">
                                        <span class="day-label">S</span>
                                        <input type="checkbox" id="day-sunday" class="day-checkbox">
                                    </div>
                                    <div class="day-box" data-day="monday">
                                        <span class="day-label">M</span>
                                        <input type="checkbox" id="day-monday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="tuesday">
                                        <span class="day-label">T</span>
                                        <input type="checkbox" id="day-tuesday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="wednesday">
                                        <span class="day-label">W</span>
                                        <input type="checkbox" id="day-wednesday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="thursday">
                                        <span class="day-label">Th</span>
                                        <input type="checkbox" id="day-thursday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="friday">
                                        <span class="day-label">F</span>
                                        <input type="checkbox" id="day-friday" class="day-checkbox" checked>
                                    </div>
                                    <div class="day-box" data-day="saturday">
                                        <span class="day-label">S</span>
                                        <input type="checkbox" id="day-saturday" class="day-checkbox" checked>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="time-increment">Time Increment:</label>
                                <select id="time-increment" class="form-control">
                                    <option value="15">15 Minutes</option>
                                    <option value="30">30 Minutes</option>
                                    <option value="60">Hourly</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Unavailable Dates:</label>
                                <button type="button" class="btn btn-secondary" onclick="openUnavailableDatesModal()" style="margin-bottom: 10px;">
                                    Add Unavailable Date
                                </button>
                                <div id="unavailable-dates-chips" class="unavailable-dates-container">
                                    <!-- Date chips will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Options & Prices Tab -->
                <div id="options-tab" class="tab-content">
                    <div class="settings-section">
                        <h3>Paper Options Management</h3>
                        <p>Manage available paper sizes, types, and color modes for the order form.</p>
                        
                        <!-- Paper Sizes Section -->
                        <div class="options-section">
                            <h4>Paper Sizes</h4>
                            <div class="options-list" id="paper-sizes-list">
                                <!-- Paper sizes will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-paper-size-display" placeholder="Display Name (e.g., Letter (8.5\" x 11\"))" class="form-input">
                                <input type="number" id="new-paper-size-sort" placeholder="Sort Order" class="form-input" value="0">
                                <button class="btn btn-secondary" onclick="addPaperSize()">Add Paper Size</button>
                            </div>
                        </div>

                        <!-- Paper Types Section -->
                        <div class="options-section">
                            <h4>Paper Types</h4>
                            <div class="options-list" id="paper-types-list">
                                <!-- Paper types will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-paper-type-display" placeholder="Display Name (e.g., Standard Paper)" class="form-input">
                                <input type="number" id="new-paper-type-sort" placeholder="Sort Order" class="form-input" value="0">
                                <button class="btn btn-secondary" onclick="addPaperType()">Add Paper Type</button>
                            </div>
                        </div>

                        <!-- Color Modes Section -->
                        <div class="options-section">
                            <h4>Color Modes</h4>
                            <div class="options-list" id="color-modes-list">
                                <!-- Color modes will be loaded here -->
                            </div>
                            <div class="add-option">
                                <input type="text" id="new-color-mode-display" placeholder="Display Name (e.g., Black & White)" class="form-input">
                                <input type="number" id="new-color-mode-sort" placeholder="Sort Order" class="form-input" value="0">
                                <button class="btn btn-secondary" onclick="addColorMode()">Add Color Mode</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Price Combinations</h3>
                        <p>Set prices and availability for each combination of paper options.</p>
                        
                        <div class="combinations-table-container">
                            <table class="combinations-table" id="combinations-table">
                                <thead>
                                    <tr>
                                        <th>Paper Size</th>
                                        <th>Paper Type</th>
                                        <th>Color Mode</th>
                                        <th>Price ($)</th>
                                        <th>Available</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="combinations-tbody">
                                    <!-- Combinations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="export-tab" class="tab-content">
                    <div class="settings-section">
                        <h3>Export Orders</h3>
                        <p>Export all orders to a CSV file for backup or analysis.</p>
                        <button class="btn btn-primary" onclick="exportOrders()">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Modal -->
        <div id="order-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Add New Order</h2>
                    <span class="close" onclick="closeOrderModal()">&times;</span>
                </div>
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-first-name">First Name:</label>
                            <input type="text" id="customer-first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-last-name">Last Name:</label>
                            <input type="text" id="customer-last-name" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer-phone">Phone:</label>
                            <input type="tel" id="customer-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-email">Email:</label>
                            <input type="email" id="customer-email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customer-address">Address:</label>
                        <input type="text" id="customer-address" required>
                    </div>

                    <div class="form-group">
                        <label for="pickup-datetime">Pickup Date & Time:</label>
                        <input type="text" id="pickup-datetime" placeholder="Select date and time">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status">
                                <option value="received">Received</option>
                                <option value="paid">Paid</option>
                                <option value="in_progress">In Progress</option>
                                <option value="ready_for_pickup">Ready for Pickup</option>
                                <option value="picked_up">Picked Up</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="copies">Copies:</label>
                            <input type="number" id="copies" min="1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="order-description">Order Description:</label>
                        <textarea id="order-description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="special-instructions">Special Instructions:</label>
                        <textarea id="special-instructions" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" rows="2"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        class AdminPanel {
            constructor() {
                this.orders = [];
                this.filteredOrders = [];
                this.settings = {};
                this.currentUser = null;
                this.socket = null;
                this.activeFilters = {};
                this.flatpickrInstances = []; // Store flatpickr instances for dynamic updates
                
                this.init();
            }

            init() {
                this.checkAuth();
                this.setupEventListeners();
            }

            checkAuth() {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    this.verifyToken(token);
                } else {
                    this.showLogin();
                }
            }

            async verifyToken(token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        // Token expired or invalid
                        localStorage.removeItem('admin_token');
                        this.showLogin();
                    }
                } catch (error) {
                    console.error('Token verification failed:', error);
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }

            showMainApp() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                this.setupSocket();
            }

            setupEventListeners() {
                // Login form
                document.getElementById('login').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Order form
                document.getElementById('order-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveOrder();
                });

                // Search
                document.getElementById('search-orders').addEventListener('input', (e) => {
                    this.filterOrders(e.target.value);
                });

                // Day selector click handlers
                document.querySelectorAll('.day-box').forEach(dayBox => {
                    dayBox.addEventListener('click', (e) => {
                        const checkbox = dayBox.querySelector('.day-checkbox');
                        checkbox.checked = !checkbox.checked;
                    });
                });
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('admin_token', data.token);
                        this.currentUser = data.user;
                        this.showMainApp();
                        this.loadData();
                    } else {
                        this.showError(data.message);
                    }
                } catch (error) {
                    console.error('Login failed:', error);
                    this.showError('Login failed. Please try again.');
                }
            }

            logout() {
                localStorage.removeItem('admin_token');
                this.currentUser = null;
                this.showLogin();
            }

            showError(message) {
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            switchTab(tabName) {
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load data for specific tabs
                if (tabName === 'settings') {
                    this.loadSettings();
                } else if (tabName === 'options') {
                    this.loadOptions();
                    this.loadCombinations();
                } else if (tabName === 'orders') {
                    // Ensure settings are fresh when switching to orders tab
                    // This ensures pickup restrictions are up-to-date
                    this.loadSettings();
                }
            }

            async loadData() {
                await Promise.all([
                    this.loadOrders(),
                    this.loadSettings()
                ]);
            }

            async loadOrders() {
                try {
                    // Load ALL orders including picked_up and abandoned for admin filtering
                    const response = await fetch('/api/orders?show_picked_up=true');
                    if (response.ok) {
                        this.orders = await response.json();
                        this.filteredOrders = [...this.orders];
                        this.displayOrders();
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Failed to load orders:', error);
                }
            }

            async loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (response.ok) {
                        this.settings = await response.json();
                        this.populateSettingsForm();
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }

            displayOrders() {
                const container = document.getElementById('orders-container');
                // Always use filteredOrders if filters are active, otherwise use all orders
                const ordersToDisplay = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                
                if (ordersToDisplay.length === 0) {
                    const message = Object.keys(this.activeFilters).length > 0 ? 
                        'No orders match your current filters' : 
                        'No orders found';
                    container.innerHTML = `<div class="loading">${message}</div>`;
                    return;
                }

                const ordersHTML = ordersToDisplay.map(order => `
                    <tr>
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td>
                            <span class="status-badge status-${order.status} clickable-status" 
                                  data-status="${order.status}"
                                  onclick="showStatusDropdown(${order.id}, '${order.status}')" 
                                  title="Click to change status">
                                ${this.formatStatusText(order.status)}
                            </span>
                        </td>
                        <td class="clickable-date" onclick="showDatePicker(${order.id}, '${order.pickup_date || ''}', '${order.pickup_time || ''}')" title="Click to change pickup date and time">
                            ${this.formatPickupDateTime(order.pickup_date, order.pickup_time)}
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editOrder(${order.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Pickup Date & Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
                
                // Apply color settings to the newly rendered order table
                this.updateOrderTableColors();
            }

            updateStats() {
                const ordersToCount = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                const totalOrders = ordersToCount.length;
                const activeOrders = ordersToCount.filter(o => !['picked_up', 'abandoned'].includes(o.status)).length;
                const readyOrders = ordersToCount.filter(o => o.status === 'ready_for_pickup').length;

                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('active-orders').textContent = activeOrders;
                document.getElementById('ready-orders').textContent = readyOrders;
            }

            applyColorSettings() {
                if (!this.settings.status_colors) return;

                const colors = this.settings.status_colors;
                
                // Apply colors to status badges in filter section
                const statusBadges = {
                    'status-received': colors.received,
                    'status-paid': colors.paid,
                    'status-in_progress': colors.in_progress,
                    'status-ready_for_pickup': colors.ready_for_pickup
                };

                Object.entries(statusBadges).forEach(([id, colorData]) => {
                    const badge = document.querySelector(`#${id} + .status-badge`);
                    if (badge) {
                        // Handle both old format (string) and new format (object)
                        if (typeof colorData === 'string') {
                            badge.style.backgroundColor = colorData;
                            badge.style.color = this.getContrastColor(colorData);
                        } else if (colorData && colorData.background) {
                            badge.style.backgroundColor = colorData.background;
                            badge.style.color = colorData.text;
                        }
                    }
                });

                // Apply colors to order table status chips
                this.updateOrderTableColors();
            }

            getContrastColor(hexColor) {
                // Convert hex to RGB
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                
                // Calculate luminance
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // Return black for light colors, white for dark colors
                return luminance > 0.5 ? '#000000' : '#ffffff';
            }

            updateOrderTableColors() {
                if (!this.settings.status_colors) return;

                const colors = this.settings.status_colors;
                
                // Update all status badges in the orders table
                const statusBadges = document.querySelectorAll('.status-badge');
                statusBadges.forEach(badge => {
                    const status = badge.getAttribute('data-status');
                    if (colors[status]) {
                        // Handle both old format (string) and new format (object)
                        if (typeof colors[status] === 'string') {
                            badge.style.backgroundColor = colors[status];
                            badge.style.color = this.getContrastColor(colors[status]);
                        } else if (colors[status] && colors[status].background) {
                            badge.style.backgroundColor = colors[status].background;
                            badge.style.color = colors[status].text;
                        }
                    }
                });
            }

            filterOrders(searchTerm) {
                // Use the current filtered orders as base, or all orders if no advanced filters
                const baseOrders = Object.keys(this.activeFilters).length > 0 ? this.filteredOrders : this.orders;
                
                const filtered = baseOrders.filter(order => 
                    order.order_number.toString().includes(searchTerm) ||
                    order.customer_first_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_last_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    order.customer_phone.includes(searchTerm)
                );

                // Update display with filtered results
                const container = document.getElementById('orders-container');
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="loading">No orders match your search</div>';
                    return;
                }

                const ordersHTML = filtered.map(order => `
                    <tr>
                        <td>#${order.order_number}</td>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                        <td>${order.customer_phone}</td>
                        <td>${order.customer_email}</td>
                        <td><span class="status-badge status-${order.status}">${order.status.replace('_', ' ')}</span></td>
                        <td>${order.pickup_date || 'TBD'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editOrder(${order.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Pickup Date & Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHTML}
                        </tbody>
                    </table>
                `;
            }

            populateSettingsForm() {
                document.getElementById('display-mode').value = this.settings.display_mode || 'dark';
                document.getElementById('rotation-seconds').value = this.settings.page_rotation_seconds || 10;
                
                if (this.settings.status_colors) {
                    // Handle both old format (just hex strings) and new format (objects with background/text)
                    const getBackgroundColor = (color) => {
                        if (typeof color === 'string') {
                            return color; // Old format
                        } else if (color && color.background) {
                            return color.background; // New format
                        }
                        return '#3B82F6'; // Default fallback
                    };

                    const getTextColor = (color) => {
                        if (typeof color === 'string') {
                            return this.getContrastColor(color); // Old format - calculate contrast
                        } else if (color && color.text) {
                            return color.text; // New format
                        }
                        return '#000000'; // Default fallback
                    };

                    // Set background colors
                    document.getElementById('color-received-bg').value = getBackgroundColor(this.settings.status_colors.received);
                    document.getElementById('color-paid-bg').value = getBackgroundColor(this.settings.status_colors.paid);
                    document.getElementById('color-in_progress-bg').value = getBackgroundColor(this.settings.status_colors.in_progress);
                    document.getElementById('color-ready_for_pickup-bg').value = getBackgroundColor(this.settings.status_colors.ready_for_pickup);

                    // Set text colors
                    document.getElementById('color-received-text').value = getTextColor(this.settings.status_colors.received);
                    document.getElementById('color-paid-text').value = getTextColor(this.settings.status_colors.paid);
                    document.getElementById('color-in_progress-text').value = getTextColor(this.settings.status_colors.in_progress);
                    document.getElementById('color-ready_for_pickup-text').value = getTextColor(this.settings.status_colors.ready_for_pickup);
                    
                    // Apply colors to the page
                    this.applyColorSettings();
                }

        // Populate pickup settings
        if (this.settings.pickup_settings) {
            // Convert 24-hour format to 12-hour format for display
            const convertTo12Hour = (time24h) => {
                if (!time24h) return '9:00 AM';
                const [hours, minutes] = time24h.split(':');
                const hour24 = parseInt(hours);
                const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
                const period = hour24 >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${period}`;
            };
            
            document.getElementById('pickup-start-time').value = convertTo12Hour(this.settings.pickup_settings.pickup_start_time);
            document.getElementById('pickup-end-time').value = convertTo12Hour(this.settings.pickup_settings.pickup_end_time);
            document.getElementById('time-increment').value = this.settings.pickup_settings.time_increment || '30';
            
            if (this.settings.pickup_settings.pickup_days) {
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                days.forEach(day => {
                    const checkbox = document.getElementById(`day-${day}`);
                    if (checkbox) {
                        checkbox.checked = this.settings.pickup_settings.pickup_days[day] || false;
                    }
                });
            }
            
            // Initialize flatpickr for time inputs in settings (no restrictions)
            this.initializeSettingsTimePickers();
            
            // Update unavailable dates display
            updateUnavailableDatesDisplay();
        }
            }

            async saveSettings() {
                const settings = {
                    display_mode: document.getElementById('display-mode').value,
                    page_rotation_seconds: parseInt(document.getElementById('rotation-seconds').value),
                    status_colors: {
                        received: {
                            background: document.getElementById('color-received-bg').value,
                            text: document.getElementById('color-received-text').value
                        },
                        paid: {
                            background: document.getElementById('color-paid-bg').value,
                            text: document.getElementById('color-paid-text').value
                        },
                        in_progress: {
                            background: document.getElementById('color-in_progress-bg').value,
                            text: document.getElementById('color-in_progress-text').value
                        },
                        ready_for_pickup: {
                            background: document.getElementById('color-ready_for_pickup-bg').value,
                            text: document.getElementById('color-ready_for_pickup-text').value
                        }
                    },
            pickup_settings: {
                pickup_start_time: (() => {
                    // Convert 12-hour format to 24-hour format for backend
                    const time12h = document.getElementById('pickup-start-time').value;
                    if (time12h) {
                        const [time, period] = time12h.split(' ');
                        const [hours, minutes] = time.split(':');
                        let hour24 = parseInt(hours);
                        if (period === 'PM' && hour24 !== 12) hour24 += 12;
                        if (period === 'AM' && hour24 === 12) hour24 = 0;
                        return `${hour24.toString().padStart(2, '0')}:${minutes}`;
                    }
                    return time12h;
                })(),
                pickup_end_time: (() => {
                    // Convert 12-hour format to 24-hour format for backend
                    const time12h = document.getElementById('pickup-end-time').value;
                    if (time12h) {
                        const [time, period] = time12h.split(' ');
                        const [hours, minutes] = time.split(':');
                        let hour24 = parseInt(hours);
                        if (period === 'PM' && hour24 !== 12) hour24 += 12;
                        if (period === 'AM' && hour24 === 12) hour24 = 0;
                        return `${hour24.toString().padStart(2, '0')}:${minutes}`;
                    }
                    return time12h;
                })(),
                time_increment: document.getElementById('time-increment').value,
                pickup_days: {
                    sunday: document.getElementById('day-sunday').checked,
                    monday: document.getElementById('day-monday').checked,
                    tuesday: document.getElementById('day-tuesday').checked,
                    wednesday: document.getElementById('day-wednesday').checked,
                    thursday: document.getElementById('day-thursday').checked,
                    friday: document.getElementById('day-friday').checked,
                    saturday: document.getElementById('day-saturday').checked
                },
                unavailable_dates: this.settings.pickup_settings.unavailable_dates || []
            }
                };

                try {
                    const token = localStorage.getItem('admin_token');
                    
                    if (!token) {
                        this.showAlert('Authentication required. Please log in again.', 'error');
                        this.showLogin();
                        return;
                    }
                    
                    const response = await fetch('/api/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        this.showAlert('Settings saved successfully!', 'success');
                        
                        // Reload settings from server to ensure local object is updated
                        await this.loadSettings();
                        
                        // Apply color settings to the current page
                        this.applyColorSettings();
                        
                        // Update all existing flatpickr instances with new settings
                        this.updateFlatpickrInstances();
                        
                        // Show additional notification that changes are applied
                        setTimeout(() => {
                            this.showAlert('Pickup restrictions updated across all forms!', 'info');
                        }, 1000);
                    } else if (response.status === 401 || response.status === 403) {
                        // Token expired or invalid
                        this.showAlert('Session expired. Please log in again.', 'error');
                        localStorage.removeItem('admin_token');
                        this.showLogin();
                    } else {
                        this.showAlert('Failed to save settings', 'error');
                    }
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    this.showAlert('Failed to save settings', 'error');
                }
            }

            async exportOrders() {
                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch('/api/orders/export/csv', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        this.showAlert('Orders exported successfully!', 'success');
                    } else {
                        this.showAlert('Failed to export orders', 'error');
                    }
                } catch (error) {
                    console.error('Failed to export orders:', error);
                    this.showAlert('Failed to export orders', 'error');
                }
            }

            async saveOrder() {
                const orderId = document.getElementById('order-id').value;
                const isEdit = orderId !== '';
                
                // Parse flatpickr datetime value
                const datetimeValue = document.getElementById('pickup-datetime').value;
                let pickupDate = '';
                let pickupTime = '';
                if (datetimeValue) {
                    const dateTime = new Date(datetimeValue);
                    pickupDate = dateTime.toISOString().split('T')[0]; // YYYY-MM-DD format
                    pickupTime = dateTime.toTimeString().split(' ')[0].substring(0, 5); // HH:MM format
                }
                
                const orderData = {
                    customer_first_name: document.getElementById('customer-first-name').value,
                    customer_last_name: document.getElementById('customer-last-name').value,
                    customer_phone: document.getElementById('customer-phone').value,
                    customer_email: document.getElementById('customer-email').value,
                    customer_address: document.getElementById('customer-address').value,
                    pickup_date: pickupDate,
                    pickup_time: pickupTime,
                    status: document.getElementById('status').value,
                    copies: parseInt(document.getElementById('copies').value),
                    order_description: document.getElementById('order-description').value,
                    special_instructions: document.getElementById('special-instructions').value,
                    notes: document.getElementById('notes').value
                };

                try {
                    const token = localStorage.getItem('admin_token');
                    const url = isEdit ? `/api/orders/${orderId}` : '/api/orders';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (response.ok) {
                        this.showAlert(isEdit ? 'Order updated successfully!' : 'Order created successfully!', 'success');
                        this.closeOrderModal();
                        this.loadOrders();
                    } else {
                        const errorData = await response.json();
                        this.showAlert(errorData.message || 'Failed to save order', 'error');
                    }
                } catch (error) {
                    console.error('Failed to save order:', error);
                    this.showAlert('Failed to save order', 'error');
                }
            }

            closeOrderModal() {
                document.getElementById('order-modal').style.display = 'none';
            }

            // Advanced Filtering Methods
            applyFilters() {
                this.activeFilters = this.getFilterValues();
                this.filteredOrders = this.applyAdvancedFilters(this.orders, this.activeFilters);
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            getFilterValues() {
                const filters = {};
                
                // Date filters
                const createdFrom = document.getElementById('filter-created-from').value;
                const createdTo = document.getElementById('filter-created-to').value;
                const pickupFrom = document.getElementById('filter-pickup-from').value;
                const pickupTo = document.getElementById('filter-pickup-to').value;
                
                if (createdFrom) filters.createdFrom = createdFrom;
                if (createdTo) filters.createdTo = createdTo;
                if (pickupFrom) filters.pickupFrom = pickupFrom;
                if (pickupTo) filters.pickupTo = pickupTo;
                
                // Status filters
                const statusFilters = [];
                document.querySelectorAll('.status-filters input[type="checkbox"]:checked').forEach(checkbox => {
                    statusFilters.push(checkbox.value);
                });
                if (statusFilters.length > 0) filters.statuses = statusFilters;
                
                // Customer filters
                const customerName = document.getElementById('filter-customer-name').value.trim();
                const phone = document.getElementById('filter-phone').value.trim();
                const email = document.getElementById('filter-email').value.trim();
                
                if (customerName) filters.customerName = customerName;
                if (phone) filters.phone = phone;
                if (email) filters.email = email;
                
                // Order details
                const orderFrom = document.getElementById('filter-order-from').value;
                const orderTo = document.getElementById('filter-order-to').value;
                const description = document.getElementById('filter-description').value.trim();
                
                if (orderFrom) filters.orderFrom = parseInt(orderFrom);
                if (orderTo) filters.orderTo = parseInt(orderTo);
                if (description) filters.description = description;
                
                return filters;
            }

            applyAdvancedFilters(orders, filters) {
                return orders.filter(order => {
                    // Date filters
                    if (filters.createdFrom && new Date(order.created_at) < new Date(filters.createdFrom)) {
                        return false;
                    }
                    if (filters.createdTo && new Date(order.created_at) > new Date(filters.createdTo + 'T23:59:59')) {
                        return false;
                    }
                    if (filters.pickupFrom && order.pickup_date && new Date(order.pickup_date) < new Date(filters.pickupFrom)) {
                        return false;
                    }
                    if (filters.pickupTo && order.pickup_date && new Date(order.pickup_date) > new Date(filters.pickupTo + 'T23:59:59')) {
                        return false;
                    }
                    
                    // Status filters
                    if (filters.statuses && filters.statuses.length > 0 && !filters.statuses.includes(order.status)) {
                        return false;
                    }
                    
                    // Customer filters
                    if (filters.customerName) {
                        const fullName = `${order.customer_first_name} ${order.customer_last_name}`.toLowerCase();
                        if (!fullName.includes(filters.customerName.toLowerCase())) {
                            return false;
                        }
                    }
                    if (filters.phone && !order.customer_phone.includes(filters.phone)) {
                        return false;
                    }
                    if (filters.email && !order.customer_email.toLowerCase().includes(filters.email.toLowerCase())) {
                        return false;
                    }
                    
                    // Order details
                    if (filters.orderFrom && order.order_number < filters.orderFrom) {
                        return false;
                    }
                    if (filters.orderTo && order.order_number > filters.orderTo) {
                        return false;
                    }
                    if (filters.description) {
                        const searchText = `${order.order_description || ''} ${order.notes || ''}`.toLowerCase();
                        if (!searchText.includes(filters.description.toLowerCase())) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            updateActiveFiltersDisplay() {
                const activeFiltersDiv = document.getElementById('active-filters');
                const filterChipsDiv = document.getElementById('filter-chips');
                
                if (Object.keys(this.activeFilters).length === 0) {
                    activeFiltersDiv.style.display = 'none';
                    return;
                }
                
                activeFiltersDiv.style.display = 'block';
                filterChipsDiv.innerHTML = '';
                
                Object.entries(this.activeFilters).forEach(([key, value]) => {
                    const chip = this.createFilterChip(key, value);
                    filterChipsDiv.appendChild(chip);
                });
            }

            createFilterChip(key, value) {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                
                let displayText = '';
                switch (key) {
                    case 'createdFrom':
                        displayText = `Created from: ${value}`;
                        break;
                    case 'createdTo':
                        displayText = `Created to: ${value}`;
                        break;
                    case 'pickupFrom':
                        displayText = `Pickup from: ${value}`;
                        break;
                    case 'pickupTo':
                        displayText = `Pickup to: ${value}`;
                        break;
                    case 'statuses':
                        // Check if this is the "Active" combination
                        if (value.length === 4 && 
                            value.includes('received') && value.includes('paid') && 
                            value.includes('in_progress') && value.includes('ready_for_pickup')) {
                            displayText = 'Active';
                        } else {
                            // Format individual status values
                            const formattedStatuses = value.map(status => this.formatStatusText(status));
                            displayText = `Status: ${formattedStatuses.join(', ')}`;
                        }
                        break;
                    case 'customerName':
                        displayText = `Customer: ${value}`;
                        break;
                    case 'phone':
                        displayText = `Phone: ${value}`;
                        break;
                    case 'email':
                        displayText = `Email: ${value}`;
                        break;
                    case 'orderFrom':
                        displayText = `Order from: ${value}`;
                        break;
                    case 'orderTo':
                        displayText = `Order to: ${value}`;
                        break;
                    case 'description':
                        displayText = `Description: ${value}`;
                        break;
                }
                
                chip.innerHTML = `
                    <span>${displayText}</span>
                    <span class="remove" onclick="removeFilter('${key}')">&times;</span>
                `;
                
                return chip;
            }

            formatStatusText(status) {
                const statusMap = {
                    'received': 'Received',
                    'paid': 'Paid', 
                    'in_progress': 'In Progress',
                    'ready_for_pickup': 'Ready for Pickup',
                    'picked_up': 'Picked Up',
                    'abandoned': 'Abandoned'
                };
                return statusMap[status] || status;
            }

            formatPickupDateTime(date, time) {
                if (!date) return 'TBD';
                
                try {
                    // Parse the date (assuming YYYY-MM-DD format)
                    const dateObj = new Date(date + 'T00:00:00');
                    
                    // Format date as M/D/YY
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const year = dateObj.getFullYear().toString().slice(-2);
                    const formattedDate = `${month}/${day}/${year}`;
                    
                    if (!time) {
                        return formattedDate;
                    }
                    
                    // Parse and format time (assuming HH:MM format)
                    const [hours, minutes] = time.split(':');
                    const hour24 = parseInt(hours);
                    const minute = parseInt(minutes);
                    
                    // Convert to 12-hour format
                    let hour12 = hour24;
                    let ampm = 'AM';
                    
                    if (hour24 === 0) {
                        hour12 = 12;
                    } else if (hour24 === 12) {
                        ampm = 'PM';
                    } else if (hour24 > 12) {
                        hour12 = hour24 - 12;
                        ampm = 'PM';
                    }
                    
                    const formattedTime = `${hour12}:${minute.toString().padStart(2, '0')} ${ampm}`;
                    
                    return `${formattedDate} ${formattedTime}`;
                } catch (error) {
                    console.error('Error formatting date/time:', error);
                    return date || 'TBD';
                }
            }

            clearAllFilters() {
                // Clear all filter inputs
                document.querySelectorAll('.filter-panel input').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                this.activeFilters = {};
                this.filteredOrders = [...this.orders];
                this.displayOrders();
                this.updateActiveFiltersDisplay();
                this.updateStats();
            }

            applyQuickFilter(type) {
                this.clearAllFilters();
                
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                switch (type) {
                    case 'active':
                        // Check all statuses except picked_up and abandoned
                        document.getElementById('status-received').checked = true;
                        document.getElementById('status-paid').checked = true;
                        document.getElementById('status-in_progress').checked = true;
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'today':
                        document.getElementById('filter-created-from').value = startOfDay.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisWeek':
                        const startOfWeek = new Date(startOfDay);
                        startOfWeek.setDate(startOfDay.getDate() - startOfDay.getDay());
                        document.getElementById('filter-created-from').value = startOfWeek.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'thisMonth':
                        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                        document.getElementById('filter-created-from').value = startOfMonth.toISOString().split('T')[0];
                        document.getElementById('filter-created-to').value = endOfDay.toISOString().split('T')[0];
                        break;
                    case 'ready':
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'overdue':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('filter-pickup-to').value = yesterday.toISOString().split('T')[0];
                        document.getElementById('status-ready_for_pickup').checked = true;
                        break;
                    case 'abandoned':
                        document.getElementById('status-abandoned').checked = true;
                        break;
                }
                
                this.applyFilters();
            }

            // Inline editing methods
            async updateOrderStatus(orderId, newStatus) {
                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            this.orders[orderIndex].status = newStatus;
                        }
                        
                        // Update filtered orders if they exist
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            this.filteredOrders[filteredIndex].status = newStatus;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, status: newStatus });
                        }
                    } else {
                        console.error('Failed to update order status');
                        alert('Failed to update order status');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    alert('Error updating order status');
                }
            }

            async updateOrderPickupDateTime(orderId, newDate, newTime) {
                try {
                    const updateData = {};
                    if (newDate !== undefined) updateData.pickup_date = newDate;
                    if (newTime !== undefined) updateData.pickup_time = newTime;
                    
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (response.ok) {
                        // Update the order in our local data
                        const orderIndex = this.orders.findIndex(order => order.id === orderId);
                        if (orderIndex !== -1) {
                            if (newDate !== undefined) this.orders[orderIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.orders[orderIndex].pickup_time = newTime;
                        }
                        
                        // Update filtered orders if they exist
                        const filteredIndex = this.filteredOrders.findIndex(order => order.id === orderId);
                        if (filteredIndex !== -1) {
                            if (newDate !== undefined) this.filteredOrders[filteredIndex].pickup_date = newDate;
                            if (newTime !== undefined) this.filteredOrders[filteredIndex].pickup_time = newTime;
                        }
                        
                        // Refresh the display
                        this.displayOrders();
                        this.updateStats();
                        
                        // Emit socket event for real-time updates
                        if (this.socket) {
                            this.socket.emit('order_updated', { orderId, ...updateData });
                        }
                    } else {
                        console.error('Failed to update pickup date/time');
                        alert('Failed to update pickup date/time');
                    }
                } catch (error) {
                    console.error('Error updating pickup date/time:', error);
                    alert('Error updating pickup date/time');
                }
            }

            setupSocket() {
                this.socket = io();
                
                this.socket.on('order_created', () => {
                    this.loadOrders();
                });

                this.socket.on('order_updated', () => {
                    this.loadOrders();
                });

                this.socket.on('order_deleted', () => {
                    this.loadOrders();
                });
            }

            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                
                const mainContent = document.querySelector('.main-content');
                mainContent.insertBefore(alertDiv, mainContent.firstChild);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            updateFlatpickrInstances() {
                console.log('Updating all flatpickr instances with new settings...');
                
                if (!this.settings.pickup_settings) {
                    console.log('No pickup settings available for updating flatpickr instances');
                    return;
                }
                
                const pickupSettings = this.settings.pickup_settings;
                
                // Build disabled days array
                const disabledDays = [];
                const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                dayNames.forEach((dayName, index) => {
                    if (!pickupSettings.pickup_days[dayName]) {
                        disabledDays.push(index);
                    }
                });
                
                console.log('Updating flatpickr instances with:', {
                    disabledDays,
                    timeIncrement: pickupSettings.time_increment,
                    minTime: pickupSettings.pickup_start_time,
                    maxTime: pickupSettings.pickup_end_time
                });
                
                // Update each flatpickr instance
                this.flatpickrInstances.forEach((instance, index) => {
                    if (instance && typeof instance.set === 'function') {
                        try {
                        instance.set('disable', [
                            function(date) {
                                // Disable specific days of the week
                                const dayOfWeek = date.getDay();
                                if (disabledDays.includes(dayOfWeek)) {
                                    return true;
                                }
                                
                                // Disable unavailable dates
                                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                                if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                                    return true;
                                }
                                
                                return false;
                            }
                        ]);
                            instance.set('minuteIncrement', parseInt(pickupSettings.time_increment));
                            instance.set('minTime', pickupSettings.pickup_start_time);
                            instance.set('maxTime', pickupSettings.pickup_end_time);
                            console.log(`Updated flatpickr instance ${index}`);
                        } catch (error) {
                            console.error(`Error updating flatpickr instance ${index}:`, error);
                        }
                    }
                });
            }

            initializeSettingsTimePickers() {
            // Initialize flatpickr for start time (time only, no restrictions)
            const startTimeInput = document.getElementById('pickup-start-time');
            if (startTimeInput) {
                flatpickr(startTimeInput, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K", // 12-hour format: 9:00 AM
                    time_24hr: false,
                    minuteIncrement: 15,
                    defaultDate: startTimeInput.value || "9:00 AM"
                });
            }

            // Initialize flatpickr for end time (time only, no restrictions)
            const endTimeInput = document.getElementById('pickup-end-time');
            if (endTimeInput) {
                flatpickr(endTimeInput, {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K", // 12-hour format: 5:00 PM
                    time_24hr: false,
                    minuteIncrement: 15,
                    defaultDate: endTimeInput.value || "5:00 PM"
                });
            }
        }

        // Options & Prices Management Methods
        async loadOptions() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const options = await response.json();
                    this.displayOptions(options);
                } else {
                    this.showAlert('Failed to load options', 'error');
                }
            } catch (error) {
                console.error('Failed to load options:', error);
                this.showAlert('Failed to load options', 'error');
            }
        }

        async loadCombinations() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options/combinations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const combinations = await response.json();
                    this.displayCombinations(combinations);
                } else {
                    this.showAlert('Failed to load combinations', 'error');
                }
            } catch (error) {
                console.error('Failed to load combinations:', error);
                this.showAlert('Failed to load combinations', 'error');
            }
        }

        displayOptions(options) {
            // Display paper sizes
            const paperSizesList = document.getElementById('paper-sizes-list');
            paperSizesList.innerHTML = options.paperSizes.map(size => `
                <div class="option-item">
                    <input type="text" class="option-display" value="${size.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('paper-sizes', ${size.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${size.sort_order}" onchange="updateOption('paper-sizes', ${size.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger" onclick="deleteOption('paper-sizes', ${size.id})">Delete</button>
                </div>
            `).join('');

            // Display paper types
            const paperTypesList = document.getElementById('paper-types-list');
            paperTypesList.innerHTML = options.paperTypes.map(type => `
                <div class="option-item">
                    <input type="text" class="option-display" value="${type.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('paper-types', ${type.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${type.sort_order}" onchange="updateOption('paper-types', ${type.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger" onclick="deleteOption('paper-types', ${type.id})">Delete</button>
                </div>
            `).join('');

            // Display color modes
            const colorModesList = document.getElementById('color-modes-list');
            colorModesList.innerHTML = options.colorModes.map(mode => `
                <div class="option-item">
                    <input type="text" class="option-display" value="${mode.display_name.replace(/"/g, '&quot;')}" onchange="updateOption('color-modes', ${mode.id}, 'display_name', this.value)">
                    <input type="number" class="option-sort" value="${mode.sort_order}" onchange="updateOption('color-modes', ${mode.id}, 'sort_order', this.value)">
                    <button class="btn btn-danger" onclick="deleteOption('color-modes', ${mode.id})">Delete</button>
                </div>
            `).join('');
        }

        displayCombinations(combinations) {
            const tbody = document.getElementById('combinations-tbody');
            tbody.innerHTML = combinations.map(combo => `
                <tr class="${combo.is_available ? '' : 'unavailable'}">
                    <td>${combo.paper_size_display}</td>
                    <td>${combo.paper_type_display}</td>
                    <td>${combo.color_mode_display}</td>
                    <td>
                        <input type="number" 
                               value="${combo.price}" 
                               step="0.01" 
                               min="0"
                               ${combo.is_available ? '' : 'disabled'}
                               onchange="updateCombination(${combo.id}, 'price', this.value)">
                    </td>
                    <td>
                        <input type="checkbox" 
                               ${combo.is_available ? 'checked' : ''}
                               onchange="updateCombination(${combo.id}, 'is_available', this.checked)">
                    </td>
                    <td>
                        <span class="availability-status ${combo.is_available ? 'available' : 'unavailable'}">${combo.is_available ? 'Available' : 'Unavailable'}</span>
                    </td>
                </tr>
            `).join('');
        }

        async addOption(type, data) {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`/api/options/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    this.showAlert(`${type} added successfully!`, 'success');
                    this.loadOptions();
                    this.loadCombinations();
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || `Failed to add ${type}`, 'error');
                }
            } catch (error) {
                console.error(`Failed to add ${type}:`, error);
                this.showAlert(`Failed to add ${type}`, 'error');
            }
        }

        async updateOption(type, id, field, value) {
            try {
                const token = localStorage.getItem('admin_token');
                const updateData = { [field]: value };
                
                const response = await fetch(`/api/options/${type}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    this.showAlert(`${type} updated successfully!`, 'success');
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || `Failed to update ${type}`, 'error');
                }
            } catch (error) {
                console.error(`Failed to update ${type}:`, error);
                this.showAlert(`Failed to update ${type}`, 'error');
            }
        }

        async deleteOption(type, id) {
            // Get the option name for display in modal
            let optionName = 'Unknown';
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch('/api/options', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const options = await response.json();
                    if (type === 'paper-sizes' && options.paperSizes) {
                        const option = options.paperSizes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    } else if (type === 'paper-types' && options.paperTypes) {
                        const option = options.paperTypes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    } else if (type === 'color-modes' && options.colorModes) {
                        const option = options.colorModes.find(opt => opt.id === parseInt(id));
                        optionName = option ? option.display_name || option.name : 'Unknown';
                    }
                }
            } catch (error) {
                console.error('Error getting option name:', error);
            }
            
            // Open modal instead of using confirm()
            openDeleteOptionModal(type, id, optionName);
        }

        async updateCombination(id, field, value) {
            try {
                const token = localStorage.getItem('admin_token');
                const updateData = { [field]: value };
                console.log(`Sending update for combination ${id}:`, updateData);
                
                const response = await fetch(`/api/options/combinations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    this.showAlert('Combination updated successfully!', 'success');
                    this.loadCombinations();
                } else {
                    const errorData = await response.json();
                    this.showAlert(errorData.error || 'Failed to update combination', 'error');
                }
            } catch (error) {
                console.error('Failed to update combination:', error);
                this.showAlert('Failed to update combination', 'error');
            }
        }
    }

        // Global functions for order management
        function openOrderModal(orderId = null) {
            // Ensure settings are loaded before opening modal
            if (!adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('Settings not loaded yet for edit modal, loading settings first...');
                adminPanel.loadSettings().then(() => {
                    openOrderModal(orderId);
                });
                return;
            }
            
            const modal = document.getElementById('order-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('order-form');
            
            if (orderId) {
                title.textContent = 'Edit Order';
                // Load order data
                const order = adminPanel.orders.find(o => o.id === orderId);
                if (order) {
                    document.getElementById('order-id').value = order.id;
                    document.getElementById('customer-first-name').value = order.customer_first_name;
                    document.getElementById('customer-last-name').value = order.customer_last_name;
                    document.getElementById('customer-phone').value = order.customer_phone;
                    document.getElementById('customer-email').value = order.customer_email;
                    document.getElementById('customer-address').value = order.customer_address;
                    // Combine date and time for flatpickr and format for display
                    let datetimeValue = '';
                    if (order.pickup_date) {
                        datetimeValue = order.pickup_date;
                        if (order.pickup_time) {
                            datetimeValue += ' ' + order.pickup_time;
                        }
                        // Convert from database format (YYYY-MM-DD HH:MM) to display format (n/j/Y h:i K)
                        const dateTime = new Date(datetimeValue);
                        if (!isNaN(dateTime.getTime())) {
                            const month = dateTime.getMonth() + 1; // 0-based to 1-based
                            const day = dateTime.getDate();
                            const year = dateTime.getFullYear();
                            const hours = dateTime.getHours();
                            const minutes = dateTime.getMinutes();
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            const displayHours = hours % 12 || 12; // Convert to 12-hour format
                            const displayMinutes = minutes.toString().padStart(2, '0');
                            datetimeValue = `${month}/${day}/${year} ${displayHours}:${displayMinutes} ${ampm}`;
                        }
                    }
                    document.getElementById('pickup-datetime').value = datetimeValue;
                    document.getElementById('status').value = order.status;
                    document.getElementById('copies').value = order.copies || 1;
                    document.getElementById('order-description').value = order.order_description || '';
                    document.getElementById('special-instructions').value = order.special_instructions || '';
                    document.getElementById('notes').value = order.notes || '';
                }
            } else {
                title.textContent = 'Add New Order';
                form.reset();
                document.getElementById('order-id').value = '';
            }
            
            modal.style.display = 'block';
            
            // Apply pickup restrictions to the edit order modal
            setTimeout(() => {
                applyPickupRestrictionsToEditModal();
            }, 100);
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function editOrder(orderId) {
            openOrderModal(orderId);
        }

        function deleteOrder(orderId) {
            openDeleteConfirmationModal(orderId);
        }

        function logout() {
            adminPanel.logout();
        }

        function saveSettings() {
            adminPanel.saveSettings();
        }

        function resetToDefaultColors() {
            // Default colors from the CSS
            const defaultColors = {
                received: { background: '#DBEAFE', text: '#1E40AF' },
                paid: { background: '#D1FAE5', text: '#065F46' },
                in_progress: { background: '#FEF3C7', text: '#92400E' },
                ready_for_pickup: { background: '#FEF3C7', text: '#92400E' }
            };

            // Set the background color picker values to defaults
            document.getElementById('color-received-bg').value = defaultColors.received.background;
            document.getElementById('color-paid-bg').value = defaultColors.paid.background;
            document.getElementById('color-in_progress-bg').value = defaultColors.in_progress.background;
            document.getElementById('color-ready_for_pickup-bg').value = defaultColors.ready_for_pickup.background;

            // Set the text color picker values to defaults
            document.getElementById('color-received-text').value = defaultColors.received.text;
            document.getElementById('color-paid-text').value = defaultColors.paid.text;
            document.getElementById('color-in_progress-text').value = defaultColors.in_progress.text;
            document.getElementById('color-ready_for_pickup-text').value = defaultColors.ready_for_pickup.text;

            // Show confirmation message
            adminPanel.showAlert('Colors reset to defaults! Click "Save Settings" to apply.', 'info');
        }

        function exportOrders() {
            adminPanel.exportOrders();
        }

        // Options & Prices Global Functions
        function addPaperSize() {
            const displayName = document.getElementById('new-paper-size-display').value;
            const sortOrder = parseInt(document.getElementById('new-paper-size-sort').value) || 0;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('paper-sizes', { display_name: displayName, sort_order: sortOrder });
            
            // Clear form
            document.getElementById('new-paper-size-display').value = '';
            document.getElementById('new-paper-size-sort').value = '0';
        }

        function addPaperType() {
            const displayName = document.getElementById('new-paper-type-display').value;
            const sortOrder = parseInt(document.getElementById('new-paper-type-sort').value) || 0;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('paper-types', { display_name: displayName, sort_order: sortOrder });
            
            // Clear form
            document.getElementById('new-paper-type-display').value = '';
            document.getElementById('new-paper-type-sort').value = '0';
        }

        function addColorMode() {
            const displayName = document.getElementById('new-color-mode-display').value;
            const sortOrder = parseInt(document.getElementById('new-color-mode-sort').value) || 0;

            if (!displayName) {
                adminPanel.showAlert('Please fill in the display name', 'error');
                return;
            }

            adminPanel.addOption('color-modes', { display_name: displayName, sort_order: sortOrder });
            
            // Clear form
            document.getElementById('new-color-mode-display').value = '';
            document.getElementById('new-color-mode-sort').value = '0';
        }

        function updateOption(type, id, field, value) {
            adminPanel.updateOption(type, id, field, value);
        }

        function deleteOption(type, id) {
            adminPanel.deleteOption(type, id);
        }

        function updateCombination(id, field, value) {
            adminPanel.updateCombination(id, field, value);
        }

        // Delete confirmation modal functions
        let orderToDelete = null;

        function openDeleteConfirmationModal(orderId) {
            // Find the order details
            const order = adminPanel.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            orderToDelete = orderId;

            // Populate order details
            const orderDetails = document.getElementById('delete-order-details');
            orderDetails.innerHTML = `
                <strong>Order #${order.order_number}</strong><br>
                Customer: ${order.customer_first_name} ${order.customer_last_name}<br>
                Phone: ${order.customer_phone}<br>
                Status: ${adminPanel.formatStatusText(order.status)}
            `;

            // Show modal
            const modal = document.getElementById('delete-confirmation-modal');
            modal.style.display = 'block';
        }

        function closeDeleteConfirmationModal() {
            const modal = document.getElementById('delete-confirmation-modal');
            modal.style.display = 'none';
            orderToDelete = null;
        }

        async function confirmDeleteOrder() {
            if (!orderToDelete) {
                console.error('No order selected for deletion');
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    adminPanel.showAlert('Authentication required. Please log in again.', 'error');
                    return;
                }

                const response = await fetch(`/api/orders/${orderToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    adminPanel.showAlert('Order deleted successfully!', 'success');
                    
                    // Close modal
                    closeDeleteConfirmationModal();
                    
                    // Reload orders
                    await adminPanel.loadOrders();
                    
                    // Emit socket event for real-time updates
                    if (window.io) {
                        const socket = io();
                        socket.emit('order_deleted', { orderId: orderToDelete });
                    }
                } else if (response.status === 401 || response.status === 403) {
                    adminPanel.showAlert('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    adminPanel.showAlert(errorData.error || 'Failed to delete order', 'error');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                adminPanel.showAlert('An error occurred while deleting the order', 'error');
            }
        }

        // Option Delete Modal Functions
        let optionToDelete = null;

        function openDeleteOptionModal(type, id, optionName) {
            optionToDelete = { type, id, optionName };
            
            // Update modal content
            const message = document.getElementById('delete-option-message');
            const details = document.getElementById('delete-option-details');
            
            message.textContent = `Are you sure you want to delete this ${type.replace('-', ' ')}?`;
            details.innerHTML = `
                <strong>Option:</strong> ${optionName}<br>
                <strong>Type:</strong> ${type.replace('-', ' ')}<br>
                <strong>ID:</strong> ${id}
            `;
            
            // Show modal
            const modal = document.getElementById('delete-option-modal');
            modal.style.display = 'block';
        }

        function closeDeleteOptionModal() {
            const modal = document.getElementById('delete-option-modal');
            modal.style.display = 'none';
            optionToDelete = null;
        }

        async function confirmDeleteOption() {
            if (!optionToDelete) {
                console.error('No option selected for deletion');
                return;
            }

            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    adminPanel.showAlert('Authentication required. Please log in again.', 'error');
                    return;
                }

                const response = await fetch(`/api/options/${optionToDelete.type}/${optionToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    adminPanel.showAlert(`${optionToDelete.type.replace('-', ' ')} deleted successfully!`, 'success');
                    
                    // Close modal
                    closeDeleteOptionModal();
                    
                    // Reload options and combinations
                    await adminPanel.loadOptions();
                    await adminPanel.loadCombinations();
                } else if (response.status === 401 || response.status === 403) {
                    adminPanel.showAlert('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    adminPanel.showAlert(errorData.error || 'Failed to delete option', 'error');
                }
            } catch (error) {
                console.error('Error deleting option:', error);
                adminPanel.showAlert('An error occurred while deleting the option', 'error');
            }
        }

        // Advanced Filter Functions
        function toggleFilterPanel() {
            const content = document.getElementById('filter-content');
            const toggleText = document.getElementById('filter-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.textContent = 'Hide Filters';
            } else {
                content.style.display = 'none';
                toggleText.textContent = 'Show Filters';
            }
        }

        function applyFilters() {
            adminPanel.applyFilters();
        }

        function clearAllFilters() {
            adminPanel.clearAllFilters();
        }

        function applyQuickFilter(type) {
            adminPanel.applyQuickFilter(type);
        }

        function removeFilter(key) {
            // Clear the specific filter
            switch (key) {
                case 'createdFrom':
                    document.getElementById('filter-created-from').value = '';
                    break;
                case 'createdTo':
                    document.getElementById('filter-created-to').value = '';
                    break;
                case 'pickupFrom':
                    document.getElementById('filter-pickup-from').value = '';
                    break;
                case 'pickupTo':
                    document.getElementById('filter-pickup-to').value = '';
                    break;
                case 'statuses':
                    document.querySelectorAll('.status-filters input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    break;
                case 'customerName':
                    document.getElementById('filter-customer-name').value = '';
                    break;
                case 'phone':
                    document.getElementById('filter-phone').value = '';
                    break;
                case 'email':
                    document.getElementById('filter-email').value = '';
                    break;
                case 'orderFrom':
                    document.getElementById('filter-order-from').value = '';
                    break;
                case 'orderTo':
                    document.getElementById('filter-order-to').value = '';
                    break;
                case 'description':
                    document.getElementById('filter-description').value = '';
                    break;
            }
            
            // Reapply filters
            adminPanel.applyFilters();
        }

        function saveFilterPreset() {
            const presetName = prompt('Enter a name for this filter preset:');
            if (presetName) {
                const filters = adminPanel.getFilterValues();
                localStorage.setItem(`filter_preset_${presetName}`, JSON.stringify(filters));
                adminPanel.showAlert(`Filter preset "${presetName}" saved!`, 'success');
            }
        }

        // Initialize the admin panel
        let adminPanel;
        document.addEventListener('DOMContentLoaded', () => {
            adminPanel = new AdminPanel();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const orderModal = document.getElementById('order-modal');
            const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
            const deleteOptionModal = document.getElementById('delete-option-modal');
            
            if (event.target === orderModal) {
                closeOrderModal();
            } else if (event.target === deleteConfirmationModal) {
                closeDeleteConfirmationModal();
            } else if (event.target === deleteOptionModal) {
                closeDeleteOptionModal();
            }
        }

        // Global functions for inline editing
        function showStatusDropdown(orderId, currentStatus) {
            // Remove any existing dropdowns
            const existingDropdown = document.querySelector('.status-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }

            const statusOptions = [
                { value: 'received', label: 'Received' },
                { value: 'paid', label: 'Paid' },
                { value: 'in_progress', label: 'In Progress' },
                { value: 'ready_for_pickup', label: 'Ready for Pickup' },
                { value: 'picked_up', label: 'Picked Up' },
                { value: 'abandoned', label: 'Abandoned' }
            ];

            // Find the clicked status element
            const statusElement = event.target;
            const rect = statusElement.getBoundingClientRect();
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'status-dropdown';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.top = (rect.bottom + 5) + 'px';

            // Add status options
            statusOptions.forEach(status => {
                const option = document.createElement('div');
                option.className = 'status-option';
                option.innerHTML = `
                    <span class="status-badge status-${status.value}">${status.label}</span>
                `;
                
                if (status.value === currentStatus) {
                    option.style.backgroundColor = '#e5e7eb';
                }
                
                option.addEventListener('click', () => {
                    adminPanel.updateOrderStatus(orderId, status.value);
                    dropdown.remove();
                });
                
                dropdown.appendChild(option);
            });

            document.body.appendChild(dropdown);

            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== statusElement) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 100);
        }

        function showDatePicker(orderId, currentDate, currentTime) {
            // Ensure settings are loaded before opening picker
            if (!adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('Settings not loaded yet, loading settings first...');
                adminPanel.loadSettings().then(() => {
                    showDatePicker(orderId, currentDate, currentTime);
                });
                return;
            }
            
            // Remove any existing date picker
            const existingPicker = document.querySelector('.date-picker-overlay');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            // Format current date/time for display (convert from database format to display format)
            let defaultDateTimeValue = '';
            if (currentDate) {
                defaultDateTimeValue = currentDate;
                if (currentTime) {
                    defaultDateTimeValue += ' ' + currentTime;
                }
                // Convert from database format (YYYY-MM-DD HH:MM) to display format (n/j/Y h:i K)
                const dateTime = new Date(defaultDateTimeValue);
                if (!isNaN(dateTime.getTime())) {
                    const month = dateTime.getMonth() + 1; // 0-based to 1-based
                    const day = dateTime.getDate();
                    const year = dateTime.getFullYear();
                    const hours = dateTime.getHours();
                    const minutes = dateTime.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours % 12 || 12; // Convert to 12-hour format
                    const displayMinutes = minutes.toString().padStart(2, '0');
                    defaultDateTimeValue = `${month}/${day}/${year} ${displayHours}:${displayMinutes} ${ampm}`;
                }
            }

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'date-picker-overlay';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'date-picker-modal';
            
            modal.innerHTML = `
                <div class="date-picker-header">
                    <h3>Set Pickup Date & Time</h3>
                    <button onclick="closeDatePicker()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="pickup-datetime-input">Pickup Date & Time:</label>
                    <input type="text" id="pickup-datetime-input" placeholder="Select date and time" value="${defaultDateTimeValue}" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <div class="date-picker-actions">
                    <button class="btn btn-secondary" onclick="closeDatePicker()">Cancel</button>
                    <button class="btn btn-primary" onclick="savePickupDateTime(${orderId})">Save</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Apply pickup settings restrictions with a small delay to ensure DOM is ready
            setTimeout(() => {
                applyPickupRestrictions();
            }, 100);

            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDatePicker();
                }
            });
        }

        function closeDatePicker() {
            const picker = document.querySelector('.date-picker-overlay');
            if (picker) {
                picker.remove();
            }
        }

        function savePickupDateTime(orderId) {
            const datetimeInput = document.getElementById('pickup-datetime-input');
            const datetimeValue = datetimeInput.value;
            
            if (datetimeValue) {
                // Parse the datetime value to extract date and time
                const dateTime = new Date(datetimeValue);
                const newDate = dateTime.toISOString().split('T')[0]; // YYYY-MM-DD format
                const newTime = dateTime.toTimeString().split(' ')[0].substring(0, 5); // HH:MM format
                
                // Update both date and time
                adminPanel.updateOrderPickupDateTime(orderId, newDate, newTime);
            } else {
                // Clear the pickup date/time
                adminPanel.updateOrderPickupDateTime(orderId, null, null);
            }
            
            closeDatePicker();
        }

        function applyPickupRestrictions() {
            console.log('=== APPLYING FLATPICKR RESTRICTIONS ===');
            
            if (!adminPanel || !adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('No pickup settings available, skipping restrictions');
                return;
            }
            
            const pickupSettings = adminPanel.settings.pickup_settings;
            const datetimeInput = document.getElementById('pickup-datetime-input');
            
            console.log('Pickup settings:', pickupSettings);
            console.log('Datetime input found:', !!datetimeInput);
            
            if (!datetimeInput) {
                console.log('Datetime input not found');
                return;
            }
            
            // Build disabled days array (flatpickr uses 0=Sunday, 1=Monday, etc.)
            const disabledDays = [];
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            dayNames.forEach((dayName, index) => {
                if (!pickupSettings.pickup_days[dayName]) {
                    disabledDays.push(index);
                }
            });
            
            console.log('Pickup days settings:', pickupSettings.pickup_days);
            console.log('Disabled days array:', disabledDays);
            console.log('Day names mapping:', dayNames);
            
            // Initialize flatpickr with restrictions
            const fpInstance = flatpickr(datetimeInput, {
                enableTime: true,
                dateFormat: "n/j/Y h:i K", // Format: 9/30/25 3:15 PM
                time_24hr: false,
                minuteIncrement: parseInt(pickupSettings.time_increment),
                minTime: pickupSettings.pickup_start_time,
                maxTime: pickupSettings.pickup_end_time,
                disable: [
                    function(date) {
                        // Disable specific days of the week
                        const dayOfWeek = date.getDay();
                        if (disabledDays.includes(dayOfWeek)) {
                            return true;
                        }
                        
                        // Disable unavailable dates
                        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                        if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                            return true;
                        }
                        
                        return false;
                    }
                ],
                defaultDate: datetimeInput.value || null,
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('Flatpickr date changed:', dateStr);
                }
            });
            
            // Store the instance for dynamic updates
            adminPanel.flatpickrInstances.push(fpInstance);
            
            console.log('=== FLATPICKR RESTRICTIONS APPLIED ===');
        }

        function applyPickupRestrictionsToEditModal() {
            console.log('=== APPLYING FLATPICKR RESTRICTIONS TO EDIT MODAL ===');
            
            if (!adminPanel || !adminPanel.settings || !adminPanel.settings.pickup_settings) {
                console.log('No pickup settings available for edit modal, skipping restrictions');
                return;
            }
            
            const pickupSettings = adminPanel.settings.pickup_settings;
            const datetimeInput = document.getElementById('pickup-datetime');
            
            console.log('Edit modal - Pickup settings:', pickupSettings);
            console.log('Edit modal - Datetime input found:', !!datetimeInput);
            
            if (!datetimeInput) {
                console.log('Edit modal - Datetime input not found');
                return;
            }
            
            // Build disabled days array (flatpickr uses 0=Sunday, 1=Monday, etc.)
            const disabledDays = [];
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            dayNames.forEach((dayName, index) => {
                if (!pickupSettings.pickup_days[dayName]) {
                    disabledDays.push(index);
                }
            });
            
            console.log('Edit modal - Pickup days settings:', pickupSettings.pickup_days);
            console.log('Edit modal - Disabled days array:', disabledDays);
            console.log('Edit modal - Day names mapping:', dayNames);
            
            // Initialize flatpickr with restrictions
            const fpInstance = flatpickr(datetimeInput, {
                enableTime: true,
                dateFormat: "n/j/Y h:i K", // Format: 9/30/25 3:15 PM
                time_24hr: false,
                minuteIncrement: parseInt(pickupSettings.time_increment),
                minTime: pickupSettings.pickup_start_time,
                maxTime: pickupSettings.pickup_end_time,
                disable: [
                    function(date) {
                        // Disable specific days of the week
                        const dayOfWeek = date.getDay();
                        if (disabledDays.includes(dayOfWeek)) {
                            return true;
                        }
                        
                        // Disable unavailable dates
                        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                        if (pickupSettings.unavailable_dates && pickupSettings.unavailable_dates.includes(dateStr)) {
                            return true;
                        }
                        
                        return false;
                    }
                ],
                defaultDate: datetimeInput.value || null,
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('Edit modal - Flatpickr date changed:', dateStr);
                }
            });
            
            // Store the instance for dynamic updates
            adminPanel.flatpickrInstances.push(fpInstance);
            
            console.log('=== EDIT MODAL FLATPICKR RESTRICTIONS APPLIED ===');
        }
        
        // Unavailable Dates Functions
        function openUnavailableDatesModal() {
            const modal = document.getElementById('unavailable-dates-modal');
            if (!modal) {
                console.error('Unavailable dates modal not found');
                return;
            }
            modal.style.display = 'flex';
            
            // Initialize flatpickr for date selection (date only, no time)
            const dateInput = document.getElementById('unavailable-date-input');
            if (dateInput && !dateInput._flatpickr) {
                flatpickr(dateInput, {
                    enableTime: false,
                    dateFormat: "Y-m-d", // Store in YYYY-MM-DD format
                    minDate: "today", // Can't select past dates
                    onChange: function(selectedDates, dateStr, instance) {
                        // Auto-close modal and add date when selected
                        if (dateStr) {
                            addUnavailableDateFromString(dateStr);
                            closeUnavailableDatesModal();
                        }
                    }
                });
            }
        }
        
        function closeUnavailableDatesModal() {
            const modal = document.getElementById('unavailable-dates-modal');
            if (!modal) {
                console.error('Unavailable dates modal not found');
                return;
            }
            modal.style.display = 'none';
            
            // Clear the input
            const dateInput = document.getElementById('unavailable-date-input');
            if (dateInput) {
                dateInput.value = '';
            }
        }
        
        function addUnavailableDate() {
            const dateInput = document.getElementById('unavailable-date-input');
            const dateStr = dateInput.value;
            if (dateStr) {
                addUnavailableDateFromString(dateStr);
                closeUnavailableDatesModal();
            }
        }
        
        function addUnavailableDateFromString(dateStr) {
            // Add to settings if not already present
            if (!adminPanel.settings.pickup_settings.unavailable_dates) {
                adminPanel.settings.pickup_settings.unavailable_dates = [];
            }
            
            if (!adminPanel.settings.pickup_settings.unavailable_dates.includes(dateStr)) {
                adminPanel.settings.pickup_settings.unavailable_dates.push(dateStr);
                updateUnavailableDatesDisplay();
            }
        }
        
        function removeUnavailableDate(dateStr) {
            if (adminPanel.settings.pickup_settings.unavailable_dates) {
                const index = adminPanel.settings.pickup_settings.unavailable_dates.indexOf(dateStr);
                if (index > -1) {
                    adminPanel.settings.pickup_settings.unavailable_dates.splice(index, 1);
                    updateUnavailableDatesDisplay();
                }
            }
        }
        
        function updateUnavailableDatesDisplay() {
            const container = document.getElementById('unavailable-dates-chips');
            if (!container) {
                console.log('Unavailable dates chips container not found');
                return;
            }
            
            container.innerHTML = '';
            
            if (adminPanel.settings.pickup_settings.unavailable_dates) {
                adminPanel.settings.pickup_settings.unavailable_dates.forEach(dateStr => {
                    const chip = document.createElement('div');
                    chip.className = 'unavailable-date-chip';
                    
                    // Format date for display (convert YYYY-MM-DD to M/D/YY)
                    // Parse date string manually to avoid timezone issues
                    const [year, month, day] = dateStr.split('-');
                    const displayDate = `${parseInt(month)}/${parseInt(day)}/${year.slice(-2)}`;
                    
                    chip.innerHTML = `
                        ${displayDate}
                        <button class="remove-btn" onclick="removeUnavailableDate('${dateStr}')" title="Remove date">&times;</button>
                    `;
                    
                    container.appendChild(chip);
                });
            }
        }
    </script>
    
    <!-- Unavailable Dates Modal -->
    <div id="unavailable-dates-modal" class="date-picker-overlay" style="display: none;">
        <div class="date-picker-modal">
            <div class="date-picker-header">
                <h3>Select Unavailable Date</h3>
                <button onclick="closeUnavailableDatesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div style="margin-bottom: 16px;">
                <label for="unavailable-date-input">Select Date:</label>
                <input type="text" id="unavailable-date-input" placeholder="Select date" style="width: 100%; padding: 8px; margin-top: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
            <div class="date-picker-actions">
                <button class="btn btn-secondary" onclick="closeUnavailableDatesModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close" onclick="closeDeleteConfirmationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this order?</p>
                <p><strong>This action cannot be undone.</strong></p>
                <div id="delete-order-details" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <!-- Order details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteConfirmationModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteOrder()">Delete Order</button>
            </div>
        </div>
    </div>

    <!-- Option Delete Confirmation Modal -->
    <div id="delete-option-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete Option</h3>
                <span class="close" onclick="closeDeleteOptionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-option-message">Are you sure you want to delete this option?</p>
                <p><strong>This will also delete all related combinations and cannot be undone.</strong></p>
                <div id="delete-option-details" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
                    <!-- Option details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteOptionModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteOption()">Delete Option</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</body>
</html>
